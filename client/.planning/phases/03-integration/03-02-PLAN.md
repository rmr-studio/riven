---
phase: 03-integration
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - components/feature-modules/authentication/components/Login.tsx
  - components/feature-modules/authentication/components/Register.tsx
autonomous: true

must_haves:
  truths:
    - "Login component authenticates via useAuth().signIn() method"
    - "Login component displays user-friendly error messages from getAuthErrorMessage()"
    - "Login OAuth flow uses useAuth().signInWithOAuth() method"
    - "Register component creates accounts via useAuth().signUp() method"
    - "Register OTP verification uses useAuth().verifyOtp() method"
    - "Register OTP resend uses useAuth().resendOtp() method"
    - "No direct Supabase imports exist in Login.tsx or Register.tsx"
  artifacts:
    - path: "components/feature-modules/authentication/components/Login.tsx"
      provides: "Login form using auth abstraction"
      min_lines: 100
    - path: "components/feature-modules/authentication/components/Register.tsx"
      provides: "Register form using auth abstraction"
      min_lines: 150
  key_links:
    - from: "components/feature-modules/authentication/components/Login.tsx"
      to: "components/provider/auth-context.tsx"
      via: "useAuth() hook"
      pattern: "const.*signIn.*=.*useAuth\\(\\)"
    - from: "components/feature-modules/authentication/components/Register.tsx"
      to: "components/provider/auth-context.tsx"
      via: "useAuth() hook"
      pattern: "const.*signUp.*=.*useAuth\\(\\)"
---

<objective>
Update Login and Register components to use the auth abstraction layer via useAuth().

Purpose: Complete the auth abstraction integration by migrating the two primary authentication components to use hook-provided methods instead of direct Supabase client calls.

Output:
- Login component using signIn() and signInWithOAuth() from useAuth()
- Register component using signUp(), verifyOtp(), and resendOtp() from useAuth()
- Both components use getAuthErrorMessage() for consistent error display
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-integration/03-RESEARCH.md

# Prior plan deliverables
@.planning/phases/03-integration/03-01-SUMMARY.md

# Files to modify
@components/feature-modules/authentication/components/Login.tsx
@components/feature-modules/authentication/components/Register.tsx

# Auth abstraction reference
@lib/auth/auth.types.ts
@lib/auth/auth-error.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Login component</name>
  <files>components/feature-modules/authentication/components/Login.tsx</files>
  <action>
Refactor Login.tsx to use auth abstraction:

1. Update imports:
   - Remove: `import { createClient } from "@/lib/util/supabase/client";`
   - Add: `import { useAuth } from "@/components/provider/auth-context";`
   - Add: `import { isAuthError, OAuthProvider } from "@/lib/auth";`
   - Add: `import { getAuthErrorMessage } from "@/lib/auth/error-messages";`
   - Keep: All existing UI component imports, form imports, router, toast

2. Remove `createClient()` call:
   - Delete: `const client = createClient();`
   - Add: `const { signIn, signInWithOAuth } = useAuth();`

3. Update `loginWithEmailPasswordCredentials` to use signIn:
   Replace the entire function with a direct call pattern in handleLoginSubmission:
   ```typescript
   const handleLoginSubmission = async (values: Login) => {
       try {
           await signIn({ type: "password", email: values.email, password: values.password });
           toast.success("Logged in successfully");
           router.push("/dashboard");
       } catch (error) {
           if (isAuthError(error)) {
               toast.error(getAuthErrorMessage(error.code));
           } else {
               toast.error("An unexpected error occurred");
           }
       }
   };
   ```
   Note: Remove the toast.promise wrapper - use simple try/catch for cleaner error handling.

4. Update `authenticateWithSocialProvider`:
   - Change parameter type: `SocialProviders` -> `OAuthProvider`
   - Replace implementation:
   ```typescript
   const authenticateWithSocialProvider = async (provider: OAuthProvider): Promise<void> => {
       try {
           await signInWithOAuth(provider, {
               redirectTo: `${process.env.NEXT_PUBLIC_HOSTED_URL}api/auth/token/callback`,
           });
           // Note: signInWithOAuth handles the redirect internally
       } catch (error) {
           if (isAuthError(error)) {
               toast.error(getAuthErrorMessage(error.code));
           } else {
               toast.error("OAuth sign-in failed");
           }
       }
   };
   ```

5. Update ThirdParty component usage:
   - The socialProviderAuthentication prop now receives OAuthProvider instead of SocialProviders
   - ThirdPartyAuth component may need to be aware of this type change (check if it causes issues)

6. Remove old AuthResponse related imports if no longer used:
   - Check if `AuthenticationCredentials`, `AuthResponse`, `SocialProviders` are still needed
   - Remove unused imports from `auth.interface`
  </action>
  <verify>
npx tsc --noEmit components/feature-modules/authentication/components/Login.tsx
Grep for "@supabase" in Login.tsx returns 0 matches
Grep for "createClient" in Login.tsx returns 0 matches
Grep for "signIn" in Login.tsx returns at least 1 match
  </verify>
  <done>
Login uses signIn() from useAuth() for password authentication
Login uses signInWithOAuth() from useAuth() for OAuth flow
Error handling uses isAuthError() and getAuthErrorMessage()
No direct Supabase imports or createClient() calls
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Register component</name>
  <files>components/feature-modules/authentication/components/Register.tsx</files>
  <action>
Refactor Register.tsx to use auth abstraction:

1. Update imports:
   - Remove: `import { createClient } from "@/lib/util/supabase/client";`
   - Remove: `import { AuthError, User } from "@supabase/supabase-js";`
   - Add: `import { useAuth } from "@/components/provider/auth-context";`
   - Add: `import { isAuthError, OAuthProvider } from "@/lib/auth";`
   - Add: `import { getAuthErrorMessage } from "@/lib/auth/error-messages";`
   - Keep: All existing UI imports, form imports, toast, useState

2. Remove `createClient()` call:
   - Delete: `const client = createClient();`
   - Add: `const { signIn, signUp, verifyOtp, resendOtp, signInWithOAuth } = useAuth();`

3. Update `registerWithEmailPasswordCredentials`:
   Replace with simpler implementation using signUp():
   ```typescript
   const registerWithEmailPasswordCredentials = async (
       email: string,
       password: string
   ): Promise<void> => {
       // signUp throws AuthError on failure (including EMAIL_TAKEN for obfuscated users)
       await signUp({ email, password });
   };
   ```
   Note: The adapter already handles obfuscated user detection and throws EMAIL_TAKEN.
   Remove the `isUserObfuscated` helper function - no longer needed.

4. Update `confirmEmailSignupWithOTP`:
   ```typescript
   const confirmEmailSignupWithOTP = async (
       userDetails: RegistrationConfirmation
   ): Promise<void> => {
       const { otp, email, password } = userDetails;

       // Verify the OTP
       await verifyOtp({
           email,
           token: otp,
           type: "signup",
       });

       // Auto sign-in after verification
       await signIn({ type: "password", email, password });
   };
   ```

5. Update `handleResendOTP`:
   ```typescript
   const handleResendOTP = async (email: string): Promise<void> => {
       await resendOtp({
           email,
           type: "signup",
       });
   };
   ```

6. Update `authenticateWithSocialProvider`:
   ```typescript
   const authenticateWithSocialProvider = async (provider: OAuthProvider): Promise<void> => {
       try {
           await signInWithOAuth(provider, {
               redirectTo: `${process.env.NEXT_PUBLIC_HOSTED_URL}api/auth/token/callback`,
           });
       } catch (error) {
           if (isAuthError(error)) {
               toast.error(getAuthErrorMessage(error.code));
           } else {
               toast.error("OAuth sign-in failed");
           }
       }
   };
   ```

7. Update `handleSubmission`:
   ```typescript
   const handleSubmission = async (values: Registration) => {
       const { email, password } = values;

       try {
           await registerWithEmailPasswordCredentials(email, password);
           toast.success("Account Created Successfully");
           setAccountCreated(true);
       } catch (error) {
           if (isAuthError(error)) {
               toast.error(getAuthErrorMessage(error.code));
           } else {
               toast.error("Failed to create account");
           }
       }
   };
   ```

8. Update RegisterConfirmation props:
   The callback functions now return Promise<void> and throw on error.
   Update how RegisterConfirmation uses these:
   - `confirmEmailSignupWithOTP` - wrap calls in try/catch within RegisterConfirmation
   - `handleResendOTP` - wrap calls in try/catch within RegisterConfirmation

9. Delete the `isUserObfuscated` helper function at the bottom of the file.

10. Clean up unused imports from auth.interface if no longer needed.
  </action>
  <verify>
npx tsc --noEmit components/feature-modules/authentication/components/Register.tsx
Grep for "@supabase" in Register.tsx returns 0 matches
Grep for "createClient" in Register.tsx returns 0 matches
Grep for "isUserObfuscated" in Register.tsx returns 0 matches
Grep for "signUp" in Register.tsx returns at least 1 match
Grep for "verifyOtp" in Register.tsx returns at least 1 match
  </verify>
  <done>
Register uses signUp() from useAuth() for account creation
Register uses verifyOtp() and resendOtp() for OTP flow
Register uses signIn() for auto-login after verification
Error handling uses isAuthError() and getAuthErrorMessage()
isUserObfuscated helper removed (adapter handles this)
No direct Supabase imports or createClient() calls
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. Run `npx tsc --noEmit` on entire project - no type errors
2. Run `npm run lint` - no errors
3. Grep for `@supabase` in both Login.tsx and Register.tsx - returns nothing
4. Grep for `createClient` in both files - returns nothing
5. Grep for `useAuth` in both files - returns matches (confirming hook usage)
</verification>

<success_criteria>
- Login component uses abstracted auth interface (INTG-03)
- Register component uses abstracted auth interface (INTG-04)
- Both components use getAuthErrorMessage() for consistent error display
- No direct Supabase imports in either component
- All files type-check and lint successfully
- Existing component structure (forms, UI) unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/03-integration/03-02-SUMMARY.md`
</output>
