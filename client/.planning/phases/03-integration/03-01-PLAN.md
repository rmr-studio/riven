---
phase: 03-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/auth/error-messages.ts
  - lib/auth/index.ts
  - components/provider/auth-context.tsx
  - components/feature-modules/user/components/avatar-dropdown.tsx
  - components/feature-modules/onboarding/components/OnboardForm.tsx
  - components/feature-modules/workspace/components/new-workspace.tsx
  - components/feature-modules/workspace/components/edit-workspace.tsx
autonomous: true

must_haves:
  truths:
    - "AuthProvider uses createAuthProvider() factory, not direct Supabase client"
    - "useAuth() returns session, user, loading unchanged for existing consumers"
    - "useAuth() additionally returns signIn, signUp, signOut, signInWithOAuth, verifyOtp, resendOtp methods"
    - "Components using client for null checks work after client is removed"
    - "getAuthErrorMessage() translates all AuthErrorCode values to user-friendly strings"
  artifacts:
    - path: "lib/auth/error-messages.ts"
      provides: "Error message mapping utility"
      exports: ["getAuthErrorMessage"]
    - path: "components/provider/auth-context.tsx"
      provides: "Refactored AuthProvider using factory"
      exports: ["AuthProvider", "useAuth"]
  key_links:
    - from: "components/provider/auth-context.tsx"
      to: "lib/auth/factory.ts"
      via: "createAuthProvider() import and call"
      pattern: "createAuthProvider\\(\\)"
    - from: "components/provider/auth-context.tsx"
      to: "lib/auth/auth.types.ts"
      via: "domain type imports"
      pattern: "import.*Session.*from.*@/lib/auth"
---

<objective>
Refactor AuthProvider to use the auth abstraction layer and expose auth methods through useAuth().

Purpose: Enable all auth components to use the provider-agnostic interface while maintaining backward compatibility for 30+ existing useAuth() consumers that only access session/user/loading.

Output:
- Error message utility for user-friendly AuthError display
- Refactored AuthProvider using factory pattern
- Updated components that previously relied on `client` property
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-integration/03-RESEARCH.md

# Prior phase deliverables
@.planning/phases/02-supabase-adapter/02-01-SUMMARY.md

# Files to modify
@components/provider/auth-context.tsx
@lib/auth/index.ts
@lib/auth/auth-error.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create error message utility</name>
  <files>lib/auth/error-messages.ts, lib/auth/index.ts</files>
  <action>
Create `lib/auth/error-messages.ts` with:

1. Import `AuthErrorCode` from `./auth-error`

2. Create `ERROR_MESSAGES` constant mapping each `AuthErrorCode` to a user-friendly string:
   - INVALID_CREDENTIALS: "Invalid email or password. Please try again."
   - SESSION_EXPIRED: "Your session has expired. Please sign in again."
   - USER_NOT_FOUND: "No account found with this email."
   - EMAIL_NOT_CONFIRMED: "Please check your email to confirm your account."
   - WEAK_PASSWORD: "Password is too weak. Please choose a stronger password."
   - EMAIL_TAKEN: "An account with this email already exists."
   - INVALID_TOKEN: "The verification code is invalid or has expired."
   - RATE_LIMITED: "Too many attempts. Please wait a moment and try again."
   - UNKNOWN_ERROR: "An unexpected error occurred. Please try again."

3. Export `getAuthErrorMessage(code: AuthErrorCode): string` function that:
   - Returns the mapped message for the code
   - Falls back to UNKNOWN_ERROR message if code not found

4. Update `lib/auth/index.ts` to add: `export { getAuthErrorMessage } from "./error-messages";`

Follow existing codebase patterns:
- Use `as const` for the mapping object
- Add JSDoc comment explaining purpose
  </action>
  <verify>
npx tsc --noEmit lib/auth/error-messages.ts
Grep for "getAuthErrorMessage" in lib/auth/index.ts confirms export
  </verify>
  <done>
getAuthErrorMessage() exists and is exported from @/lib/auth barrel
All 9 AuthErrorCode values have mapped messages
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor AuthProvider to use factory</name>
  <files>components/provider/auth-context.tsx</files>
  <action>
Refactor `components/provider/auth-context.tsx` to use auth abstraction:

1. Update imports:
   - Remove: `import { createClient } from "@/lib/util/supabase/client";`
   - Remove: `import { Session } from "@supabase/supabase-js";`
   - Add: `import { createAuthProvider, AuthProvider as IAuthProvider, Session, User, AuthChangeEvent } from "@/lib/auth";`
   - Keep existing React imports

2. Update `AuthContextType` interface:
   - Change `session: Session | null` to use domain Session (import handles this)
   - Change `user: Session["user"] | null` to `user: User | null`
   - REMOVE: `client?: ReturnType<typeof createClient>` (breaking change - intentional)
   - Keep: `loading: boolean`
   - ADD auth methods with provider method types:
     ```typescript
     signIn: IAuthProvider["signIn"];
     signUp: IAuthProvider["signUp"];
     signOut: IAuthProvider["signOut"];
     signInWithOAuth: IAuthProvider["signInWithOAuth"];
     verifyOtp: IAuthProvider["verifyOtp"];
     resendOtp: IAuthProvider["resendOtp"];
     ```

3. Update default context value:
   - Remove `client: undefined`
   - Add stub functions for auth methods that throw if called outside provider:
     ```typescript
     signIn: () => { throw new Error("useAuth must be used within AuthProvider"); },
     // ... same pattern for all methods
     ```

4. Update AuthProvider function:
   - Replace: `const client = useMemo(() => createClient(), []);`
   - With: `const provider = useMemo(() => createAuthProvider(), []);`

5. Update useEffect for auth state:
   - Replace: `const { data: subscription } = client.auth.onAuthStateChange(...)`
   - With: `const subscription = provider.onAuthStateChange(...)`
   - The callback signature stays the same: `(event, newSession) => ...`
   - Update cleanup: `subscription.unsubscribe()` (remove `.subscription` wrapper)

6. Update context value (wrap in useMemo for performance):
   ```typescript
   const value: AuthContextType = useMemo(() => ({
       session,
       user: session?.user ?? null,
       loading,
       signIn: provider.signIn.bind(provider),
       signUp: provider.signUp.bind(provider),
       signOut: provider.signOut.bind(provider),
       signInWithOAuth: provider.signInWithOAuth.bind(provider),
       verifyOtp: provider.verifyOtp.bind(provider),
       resendOtp: provider.resendOtp.bind(provider),
   }), [session, loading, provider]);
   ```

7. Remove console.log from auth state change callback (cleanup)

Keep the `useAuth()` export unchanged - it still returns `useContext(AuthContext)`.
  </action>
  <verify>
npx tsc --noEmit components/provider/auth-context.tsx
Grep for "@supabase" in auth-context.tsx returns 0 matches
Grep for "createAuthProvider" in auth-context.tsx returns 1 match
  </verify>
  <done>
AuthProvider uses createAuthProvider() instead of createClient()
useAuth() returns session, user, loading (backward compatible)
useAuth() additionally returns all 6 auth methods
No Supabase imports in auth-context.tsx
  </done>
</task>

<task type="auto">
  <name>Task 3: Update components using client property</name>
  <files>
    components/feature-modules/user/components/avatar-dropdown.tsx,
    components/feature-modules/onboarding/components/OnboardForm.tsx,
    components/feature-modules/workspace/components/new-workspace.tsx,
    components/feature-modules/workspace/components/edit-workspace.tsx
  </files>
  <action>
Update components that use `client` from useAuth() to work without it:

**avatar-dropdown.tsx:**
1. Change destructure: `const { client } = useAuth()` -> `const { signOut } = useAuth()`
2. Update imports: Add `import { isAuthError } from "@/lib/auth";` and `import { getAuthErrorMessage } from "@/lib/auth/error-messages";`
3. Add import for toast if not present: `import { toast } from "sonner";`
4. Update handleLogout:
   ```typescript
   const handleLogout = async () => {
       try {
           await signOut();
           router.push("/");
       } catch (error) {
           if (isAuthError(error)) {
               toast.error(getAuthErrorMessage(error.code));
           } else {
               console.error("Logout failed:", error);
           }
       }
   };
   ```

**OnboardForm.tsx:**
1. Change destructure: `const { client, session } = useAuth()` -> `const { session } = useAuth()`
2. Update handleSubmission guard: `if (!user || !client) return;` -> `if (!user || !session) return;`
   (session check replaces client check - ensures authenticated state)

**new-workspace.tsx:**
1. Change destructure: `const { session, client } = useAuth()` -> `const { session } = useAuth()`
2. Update handleSubmission guard: `if (!session || !client) {` -> `if (!session) {`
   (session is sufficient - if session exists, user is authenticated)

**edit-workspace.tsx:**
1. Change destructure: `const { session, client } = useAuth()` -> `const { session } = useAuth()`
2. Update handleSubmission guard: `if (!session || !client) {` -> `if (!session) {`
  </action>
  <verify>
npx tsc --noEmit components/feature-modules/user/components/avatar-dropdown.tsx
npx tsc --noEmit components/feature-modules/onboarding/components/OnboardForm.tsx
npx tsc --noEmit components/feature-modules/workspace/components/new-workspace.tsx
npx tsc --noEmit components/feature-modules/workspace/components/edit-workspace.tsx
Grep for "\.client" in these 4 files returns 0 matches
  </verify>
  <done>
avatar-dropdown uses signOut() from useAuth() with proper error handling
OnboardForm, new-workspace, edit-workspace no longer reference client
All 4 components type-check successfully
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. Run `npx tsc --noEmit` on entire project - no type errors
2. Grep for `@supabase` in `components/provider/auth-context.tsx` - returns nothing
3. Grep for `createAuthProvider` in `components/provider/auth-context.tsx` - returns 1 match
4. Grep for `\.client` in the 4 updated component files - returns nothing
5. Run `npm run lint` - no errors
</verification>

<success_criteria>
- AuthProvider uses factory pattern (INTG-01)
- useAuth() returns unchanged session/user/loading API (INTG-02 partial)
- useAuth() additionally exposes auth action methods
- No direct Supabase imports in auth-context.tsx
- Components that used `client` property work with new API
- All files type-check and lint successfully
</success_criteria>

<output>
After completion, create `.planning/phases/03-integration/03-01-SUMMARY.md`
</output>
