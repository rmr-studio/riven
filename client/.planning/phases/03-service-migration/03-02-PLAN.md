---
phase: 03-service-migration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - components/feature-modules/user/service/user.service.ts
  - components/feature-modules/workspace/service/workspace.service.ts
autonomous: true

must_haves:
  truths:
    - "UserService functions use createUserApi and normalizeApiError"
    - "WorkspaceService methods (except getWorkspaceMembers) use createWorkspaceApi and normalizeApiError"
    - "All migrated methods maintain existing signatures and validation logic"
    - "Methods without generated API coverage retain manual fetch pattern"
  artifacts:
    - path: "components/feature-modules/user/service/user.service.ts"
      provides: "User service functions with generated API calls"
      exports: ["fetchSessionUser", "updateUser"]
    - path: "components/feature-modules/workspace/service/workspace.service.ts"
      provides: "WorkspaceService with generated API calls"
      exports: ["WorkspaceService"]
  key_links:
    - from: "components/feature-modules/user/service/user.service.ts"
      to: "lib/api/user-api.ts"
      via: "createUserApi import and usage"
      pattern: "createUserApi\\(session\\)"
    - from: "components/feature-modules/workspace/service/workspace.service.ts"
      to: "lib/api/workspace-api.ts"
      via: "createWorkspaceApi import and usage"
      pattern: "createWorkspaceApi\\(session\\)"
---

<objective>
Migrate user and workspace services from manual fetch to generated APIs with normalizeApiError.

Purpose: Replace manual fetch patterns with type-safe generated API calls in UserService and WorkspaceService, completing the service migration phase.
Output: Two service files using createUserApi/createWorkspaceApi and normalizeApiError for all methods with generated API coverage.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-service-migration/03-RESEARCH.md

# Reference files
@lib/api/user-api.ts
@lib/api/workspace-api.ts
@lib/util/error/error.util.ts
@lib/types/apis/UserApi.ts
@lib/types/apis/WorkspaceApi.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate UserService functions</name>
  <files>components/feature-modules/user/service/user.service.ts</files>
  <action>
Migrate both standalone functions to use generated UserApi:

1. Update imports:
   - Add: `import { createUserApi } from "@/lib/api/user-api";`
   - Add: `import { normalizeApiError, fromError } from "@/lib/util/error/error.util";`
   - Remove: `api` import from utils (if present)
   - Remove: `isResponseError` import (normalizeApiError handles this)
   - Update type imports: Generated API uses `User` type, not custom response types
     - `GetCurrentUserResponse` likely maps to `User`
     - `UpdateUserProfileResponse` likely maps to `User`

2. Migrate `fetchSessionUser`:
   - Keep session null check (converts to ResponseError with fromError)
   - Replace fetch with:
     ```typescript
     const api = createUserApi(session);
     return await api.getCurrentUser();
     ```
   - **Note:** Generated getCurrentUser() takes no parameters
   - Replace entire catch block with: `await normalizeApiError(error);`
   - Update return type if needed (likely `Promise<User>` instead of `Promise<GetCurrentUserResponse>`)

3. Migrate `updateUser`:
   - Keep session null check with fromError
   - **Note:** The `updatedAvatar` parameter is unused in current implementation. Generated API only takes `user` object.
   - Replace fetch with:
     ```typescript
     const api = createUserApi(session);
     return await api.updateUserProfile({ user: request });
     ```
   - Replace entire catch block with: `await normalizeApiError(error);`
   - Update return type if needed (likely `Promise<User>`)
   - Keep the `updatedAvatar` parameter in signature even if unused (maintains API compatibility)

4. Import User type from generated types:
   ```typescript
   import type { User } from "@/lib/types";
   ```
   Or keep existing interface imports if they re-export the generated type.
  </action>
  <verify>
- `npm run build` passes
- fetchSessionUser uses api.getCurrentUser()
- updateUser uses api.updateUserProfile({ user: request })
- Both functions import createUserApi from @/lib/api/user-api
- Both functions use normalizeApiError in catch block
  </verify>
  <done>UserService functions migrated to generated UserApi with normalizeApiError</done>
</task>

<task type="auto">
  <name>Task 2: Migrate WorkspaceService methods</name>
  <files>components/feature-modules/workspace/service/workspace.service.ts</files>
  <action>
Migrate 5 of 6 methods (getWorkspaceMembers stays manual):

1. Update imports:
   - Add: `import { createWorkspaceApi } from "@/lib/api/workspace-api";`
   - Add: `import { normalizeApiError } from "@/lib/util/error/error.util";`
   - Keep: fromError, isResponseError (for manual fetch methods)
   - Keep: validateSession, validateUuid from service.util
   - Keep: handleError from service.util (for getWorkspaceMembers)
   - Remove: `api` import from utils
   - Update type imports as needed

2. Migrate `saveWorkspace`:
   - Keep validateSession
   - Replace manual FormData construction with:
     ```typescript
     const api = createWorkspaceApi(session);
     return await api.saveWorkspace({
       workspace: request,
       file: uploadedAvatar ?? undefined,
     });
     ```
   - Replace catch block with: `await normalizeApiError(error);`
   - Remove duplicate `if (response.ok)` check

3. Migrate `inviteToWorkspace`:
   - Replace session check with validateSession (for consistency)
   - **Note:** Generated API expects `role: WorkspaceRoles` enum, ensure params.role matches
   - Replace fetch with:
     ```typescript
     const api = createWorkspaceApi(session);
     return await api.inviteToWorkspace({
       workspaceId,
       email,
       role,
     });
     ```
   - Replace catch block with: `await normalizeApiError(error);`
   - Import WorkspaceRoles from @/lib/types if needed

4. Migrate `getWorkspaceInvites`:
   - Replace session check with validateSession
   - Replace fetch with:
     ```typescript
     const api = createWorkspaceApi(session);
     return await api.getWorkspaceInvites({ workspaceId });
     ```
   - Replace catch block with: `await normalizeApiError(error);`

5. Migrate `revokeInvite`:
   - **Note:** This is an instance method (not static). Convert to static for consistency or keep as-is.
   - Keep validateSession, validateUuid
   - **Note:** Generated API returns `void`, current returns `boolean`. Update return type to `Promise<void>`.
   - Replace fetch with:
     ```typescript
     const api = createWorkspaceApi(session);
     await api.revokeInvite({ workspaceId, id });
     ```
   - Replace catch block with: `await normalizeApiError(error);`
   - Remove `return true;` statement

6. Migrate `getWorkspace`:
   - Keep validateSession, validateUuid
   - Replace fetch with:
     ```typescript
     const api = createWorkspaceApi(session);
     return await api.getWorkspace({ workspaceId });
     ```
   - Replace catch block with: `await normalizeApiError(error);`

7. Keep `getWorkspaceMembers` unchanged (no generated API coverage):
   - Retains manual fetch pattern
   - Update error handling to use normalizeApiError in catch for consistency:
     ```typescript
     catch (error) {
       await normalizeApiError(error);
     }
     ```
   - Keep handleError for the response.ok check (parsing response body)
  </action>
  <verify>
- `npm run build` passes
- saveWorkspace uses api.saveWorkspace with workspace and file parameters
- inviteToWorkspace, getWorkspaceInvites, revokeInvite, getWorkspace use createWorkspaceApi
- revokeInvite returns Promise&lt;void&gt; (not Promise&lt;boolean&gt;)
- getWorkspaceMembers retains manual fetch pattern
- All migrated methods use normalizeApiError in catch
  </verify>
  <done>WorkspaceService methods migrated to generated WorkspaceApi; getWorkspaceMembers retains manual fetch</done>
</task>

</tasks>

<verification>
After all tasks:
1. `npm run build` passes with no errors
2. user.service.ts imports createUserApi from @/lib/api/user-api
3. workspace.service.ts imports createWorkspaceApi from @/lib/api/workspace-api
4. Both files import normalizeApiError from @/lib/util/error/error.util
5. No manual fetch calls remain except in WorkspaceService.getWorkspaceMembers
6. Return types match generated API (void for revokeInvite)
</verification>

<success_criteria>
- fetchSessionUser uses createUserApi and normalizeApiError
- updateUser uses createUserApi and normalizeApiError
- WorkspaceService.saveWorkspace uses createWorkspaceApi and normalizeApiError
- WorkspaceService.inviteToWorkspace uses createWorkspaceApi and normalizeApiError
- WorkspaceService.getWorkspaceInvites uses createWorkspaceApi and normalizeApiError
- WorkspaceService.revokeInvite uses createWorkspaceApi and normalizeApiError (returns void)
- WorkspaceService.getWorkspace uses createWorkspaceApi and normalizeApiError
- WorkspaceService.getWorkspaceMembers retains manual fetch (no generated coverage)
- Build passes without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-service-migration/03-02-SUMMARY.md`
</output>
