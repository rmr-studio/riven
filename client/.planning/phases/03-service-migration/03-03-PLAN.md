---
phase: 03-service-migration
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - components/feature-modules/blocks/service/block.service.ts
  - components/feature-modules/user/service/user.service.ts
  - components/feature-modules/workspace/service/workspace.service.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "All service methods compile without TypeScript errors"
    - "normalizeApiError calls properly signal termination to TypeScript"
    - "Service return types match what generated API classes return"
  artifacts:
    - path: "components/feature-modules/blocks/service/block.service.ts"
      provides: "BlockService with no TS errors"
      contains: "throw await normalizeApiError"
    - path: "components/feature-modules/user/service/user.service.ts"
      provides: "UserService with correct return types"
      contains: "throw await normalizeApiError"
    - path: "components/feature-modules/workspace/service/workspace.service.ts"
      provides: "WorkspaceService with correct return types"
      contains: "throw await normalizeApiError"
  key_links:
    - from: "components/feature-modules/blocks/service/block.service.ts"
      to: "components/feature-modules/blocks/interface/block.interface.ts"
      via: "HydrateBlockResponse type export"
      pattern: "export.*HydrateBlockResponse"
---

<objective>
Fix TypeScript compilation errors in migrated services

Purpose: The service migration (Phase 3) is functionally complete but has TypeScript errors that prevent a clean build. This plan addresses three categories of errors identified in VERIFICATION.md:
1. TS2366 - Functions lack ending return statements (normalizeApiError returns Promise<never> but compiler doesn't recognize it)
2. TS2322 - Type mismatches between generated API return types and interface-defined response types
3. TS2305 - Export mismatch for HydrateBlocksResponse (hook expects plural, service has singular)

Output: All three services compile cleanly, enabling the project to proceed to Phase 4.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-service-migration/03-VERIFICATION.md

# Source files to modify
@components/feature-modules/blocks/service/block.service.ts
@components/feature-modules/user/service/user.service.ts
@components/feature-modules/workspace/service/workspace.service.ts

# Interface files for reference
@components/feature-modules/user/interface/user.interface.ts
@components/feature-modules/workspace/interface/workspace.interface.ts

# Generated API files for return type reference
@lib/types/apis/UserApi.ts
@lib/types/apis/WorkspaceApi.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix normalizeApiError return statements in all services</name>
  <files>
    components/feature-modules/blocks/service/block.service.ts
    components/feature-modules/user/service/user.service.ts
    components/feature-modules/workspace/service/workspace.service.ts
  </files>
  <action>
    In each service file, change all occurrences of:
    ```typescript
    await normalizeApiError(error);
    ```
    to:
    ```typescript
    throw await normalizeApiError(error);
    ```

    The `normalizeApiError` function returns `Promise<never>` (it always throws internally), but TypeScript's control flow analysis doesn't recognize `await normalizeApiError(error)` as a terminal statement. Adding `throw` explicitly tells TypeScript this path never returns.

    Specific locations:
    - block.service.ts: line 66
    - user.service.ts: lines 32, 54
    - workspace.service.ts: lines 30, 46, 61, 79, 90 (5 occurrences total)
  </action>
  <verify>
    Run `npx tsc --noEmit` on the service files and confirm no TS2366 errors for these functions.
  </verify>
  <done>
    All `await normalizeApiError(error)` calls are prefixed with `throw` and TS2366 errors are resolved.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix type mismatches in UserService and WorkspaceService</name>
  <files>
    components/feature-modules/user/service/user.service.ts
    components/feature-modules/workspace/service/workspace.service.ts
  </files>
  <action>
    The issue: User interface defines `GetCurrentUserResponse` and `UpdateUserProfileResponse` using the operations pattern:
    ```typescript
    operations["getCurrentUser"]["responses"]["200"]["content"]["*/*"]
    ```

    But the generated API (`UserApi.getCurrentUser()`) returns `Promise<User>` directly.

    **Fix approach:** Update service return types to use the generated types directly, which matches what the API actually returns.

    In user.service.ts:
    - Import `User` from the interface (it's already there as `GetCurrentUserResponse` uses it)
    - Change `fetchSessionUser` return type from `Promise<GetCurrentUserResponse>` to `Promise<User>`
    - Change `updateUser` return type from `Promise<UpdateUserProfileResponse>` to `Promise<User>`
    - Remove the now-unused `GetCurrentUserResponse` and `UpdateUserProfileResponse` imports

    In workspace.service.ts:
    - `saveWorkspace` return type: Already `Promise<Workspace>` - verify it matches `workspaceApi.saveWorkspace()` return
    - `getWorkspace` return type: Already `Promise<Workspace>` - verify it matches `workspaceApi.getWorkspace()` return
    - Check: Generated `WorkspaceApi.saveWorkspace()` returns `Promise<Workspace>`, `WorkspaceApi.getWorkspace()` returns `Promise<Workspace>`
    - If there are TS2322 errors, they may be due to import path differences. Ensure `Workspace` is imported from the interface file.

    The generated API classes return the model types directly (User, Workspace), not wrapped response types. The services should use the same types.
  </action>
  <verify>
    Run `npx tsc --noEmit` and confirm no TS2322 type mismatch errors in user.service.ts or workspace.service.ts.
  </verify>
  <done>
    Service return types match generated API return types; no TS2322 errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix HydrateBlocksResponse export for hook compatibility</name>
  <files>
    components/feature-modules/blocks/service/block.service.ts
  </files>
  <action>
    The hook `use-blocks-hydration.ts` imports `HydrateBlocksResponse` (plural) from the service:
    ```typescript
    import { BlockService, HydrateBlocksResponse } from "../service/block.service";
    ```

    But the service only imports and re-exports `HydrateBlockResponse` (singular) from the interface.

    **Fix:** Add a re-export in block.service.ts that exports the type from the interface with the name the hook expects:

    Add at the top of block.service.ts (after the existing imports):
    ```typescript
    // Re-export for hook compatibility
    export type { HydrateBlockResponse as HydrateBlocksResponse } from "../interface/block.interface";
    ```

    This aliases the singular type to the plural name that the hook imports. Alternative: Change the hook import to use `HydrateBlockResponse`, but aliasing in the service is cleaner as it establishes the service as the source of truth for consumers.
  </action>
  <verify>
    Run `npx tsc --noEmit` on use-blocks-hydration.ts and confirm no TS2305 "Module has no exported member" error.
  </verify>
  <done>
    Hook successfully imports `HydrateBlocksResponse` from the service; TS2305 error resolved.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Run TypeScript compilation check:
   ```bash
   cd client && npx tsc --noEmit 2>&1 | grep -E "(block\.service|user\.service|workspace\.service|use-blocks-hydration)"
   ```
   Expected: No errors from these files.

2. Run full TypeScript check to confirm no regressions:
   ```bash
   cd client && npx tsc --noEmit 2>&1 | head -50
   ```
   Expected: Pre-existing errors only (template.interface.ts, entity-instance-validation.util.ts, schema.util.ts). No new errors from service files.

3. Verify services are still functional (imports work, types are correct):
   ```bash
   cd client && npx tsc --noEmit --listFiles 2>&1 | grep -E "(block\.service|user\.service|workspace\.service)" | head -5
   ```
   Expected: Files are processed without errors.
</verification>

<success_criteria>
1. `npx tsc --noEmit` produces no TS2366, TS2322, or TS2305 errors from the migrated service files
2. All service methods compile successfully with correct return types
3. `use-blocks-hydration.ts` can import `HydrateBlocksResponse` from the block service
4. No regressions - existing TypeScript errors remain unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/03-service-migration/03-03-SUMMARY.md` documenting:
- Changes made to each service file
- TypeScript errors resolved
- Verification that compilation succeeds
</output>
