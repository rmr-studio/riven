---
phase: 03-service-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/feature-modules/blocks/service/block.service.ts
  - components/feature-modules/blocks/service/block-type.service.ts
  - components/feature-modules/blocks/service/layout.service.ts
autonomous: true

must_haves:
  truths:
    - "BlockService.hydrateBlocks uses createBlockApi and normalizeApiError"
    - "BlockTypeService methods (except lintBlockType) use createBlockApi and normalizeApiError"
    - "LayoutService methods use createBlockApi and normalizeApiError"
    - "All migrated methods maintain existing signatures and validation logic"
    - "Methods without generated API coverage retain manual fetch pattern"
  artifacts:
    - path: "components/feature-modules/blocks/service/block.service.ts"
      provides: "BlockService with generated API calls"
      exports: ["BlockService"]
    - path: "components/feature-modules/blocks/service/block-type.service.ts"
      provides: "BlockTypeService with generated API calls"
      exports: ["BlockTypeService"]
    - path: "components/feature-modules/blocks/service/layout.service.ts"
      provides: "LayoutService with generated API calls"
      exports: ["LayoutService"]
  key_links:
    - from: "components/feature-modules/blocks/service/block.service.ts"
      to: "lib/api/block-api.ts"
      via: "createBlockApi import and usage"
      pattern: "createBlockApi\\(session\\)"
    - from: "components/feature-modules/blocks/service/block-type.service.ts"
      to: "lib/api/block-api.ts"
      via: "createBlockApi import and usage"
      pattern: "createBlockApi\\(session\\)"
    - from: "components/feature-modules/blocks/service/layout.service.ts"
      to: "lib/api/block-api.ts"
      via: "createBlockApi import and usage"
      pattern: "createBlockApi\\(session\\)"
---

<objective>
Migrate block-related services (BlockService, BlockTypeService, LayoutService) from manual fetch to generated BlockApi with normalizeApiError.

Purpose: Replace manual fetch patterns with type-safe generated API calls in all block-related services, establishing consistent error handling.
Output: Three service files using createBlockApi and normalizeApiError for all methods with generated API coverage.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-service-migration/03-RESEARCH.md

# Reference files
@lib/api/block-api.ts
@lib/util/error/error.util.ts
@lib/types/apis/BlockApi.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate BlockService.hydrateBlocks</name>
  <files>components/feature-modules/blocks/service/block.service.ts</files>
  <action>
Migrate the single method in BlockService to use generated API:

1. Update imports:
   - Add: `import { createBlockApi } from "@/lib/api/block-api";`
   - Add: `import { normalizeApiError } from "@/lib/util/error/error.util";`
   - Remove: `handleError` import from service.util (keep validateSession, validateUuid)
   - Remove: `api` import from utils
   - Update type imports to use generated types from `@/lib/types`:
     - `HydrateBlocksRequest` (contains references and workspaceId)
     - Keep `HydrateBlockResponse` from interface if it matches, or use generated return type

2. Migrate `hydrateBlocks` method:
   - Keep validation: validateSession, validateUuid for workspaceId and entity keys
   - Keep empty entities check with fromError
   - Replace fetch with:
     ```typescript
     const api = createBlockApi(session);
     return await api.hydrateBlocks({
       hydrateBlocksRequest: {
         references: entities,
         workspaceId,
       }
     });
     ```
   - Replace catch block with: `await normalizeApiError(error);`
   - Remove the manual response.ok check and handleError call

3. Remove unused imports (isResponseError may still be needed for the empty entities validation, but check if fromError handles it).
  </action>
  <verify>
- `npm run build` passes (no TypeScript errors)
- File imports createBlockApi from @/lib/api/block-api
- File imports normalizeApiError from @/lib/util/error/error.util
- hydrateBlocks method calls `api.hydrateBlocks({ hydrateBlocksRequest: ... })`
  </verify>
  <done>BlockService.hydrateBlocks uses generated BlockApi with normalizeApiError error handling</done>
</task>

<task type="auto">
  <name>Task 2: Migrate BlockTypeService methods</name>
  <files>components/feature-modules/blocks/service/block-type.service.ts</files>
  <action>
Migrate 4 of 5 methods (lintBlockType stays manual):

1. Update imports:
   - Add: `import { createBlockApi } from "@/lib/api/block-api";`
   - Add: `import { normalizeApiError } from "@/lib/util/error/error.util";`
   - Keep: validateSession, validateUuid from service.util
   - Remove: `handleError` from service.util
   - Remove: `api` from utils
   - Update type imports: Keep BlockType and CreateBlockTypeRequest from interface (or use generated)

2. Migrate `publishBlockType`:
   - Keep validateSession
   - Replace fetch with:
     ```typescript
     const api = createBlockApi(session);
     return await api.publishBlockType({ createBlockTypeRequest: request });
     ```
   - Replace catch with: `await normalizeApiError(error);`

3. Migrate `updateBlockType`:
   - Keep validateSession, validateUuid(blockTypeId)
   - **Note:** Generated API returns `void`, not `BlockType`. Update return type to `Promise<void>`.
   - Replace fetch with:
     ```typescript
     const api = createBlockApi(session);
     await api.updateBlockType({ blockTypeId, blockType: request });
     ```
   - Replace catch with: `await normalizeApiError(error);`
   - Remove return statement (method now returns void)

4. Migrate `getBlockTypes`:
   - Keep validateUuid(workspaceId), validateSession
   - **Note:** Generated API returns `BlockType[]`, not `GetBlockTypesResponse`. Update return type.
   - Replace fetch with:
     ```typescript
     const api = createBlockApi(session);
     return await api.getBlockTypes({ workspaceId });
     ```
   - Replace catch with: `await normalizeApiError(error);`

5. Migrate `getBlockTypeByKey`:
   - Keep validateSession
   - Replace fetch with:
     ```typescript
     const api = createBlockApi(session);
     return await api.getBlockTypeByKey({ key });
     ```
   - Replace catch with: `await normalizeApiError(error);`

6. Keep `lintBlockType` unchanged (no generated API coverage). It keeps manual fetch but update error handling to use normalizeApiError for consistency:
   - Keep the fetch call and response.ok check
   - Replace catch block with `await normalizeApiError(error);`
   - Keep handleError for the response error (since we need to parse the response body)
  </action>
  <verify>
- `npm run build` passes
- publishBlockType, updateBlockType, getBlockTypes, getBlockTypeByKey use createBlockApi
- updateBlockType returns Promise&lt;void&gt; (not Promise&lt;BlockType&gt;)
- getBlockTypes returns Promise&lt;BlockType[]&gt; (not GetBlockTypesResponse)
- lintBlockType retains manual fetch pattern
  </verify>
  <done>BlockTypeService methods migrated to generated BlockApi; lintBlockType retains manual fetch</done>
</task>

<task type="auto">
  <name>Task 3: Migrate LayoutService methods</name>
  <files>components/feature-modules/blocks/service/layout.service.ts</files>
  <action>
Migrate both methods to use generated BlockApi:

1. Update imports:
   - Add: `import { createBlockApi } from "@/lib/api/block-api";`
   - Add: `import { normalizeApiError } from "@/lib/util/error/error.util";`
   - Keep: validateSession, validateUuid from service.util
   - Remove: `handleError` from service.util
   - Remove: `api` from utils
   - Remove: `formatError` import (optional, only used for console.error)
   - Keep type imports but note that `EntityType` from entity interface will need to map to `ApplicationEntityType` from generated types

2. Migrate `loadLayout`:
   - Keep validation: workspaceId/entityId null check with fromError, validateUuid for both, validateSession
   - **Note:** Generated API expects `type: ApplicationEntityType`, but current method receives `EntityType` from entity interface. Check if these are compatible or need mapping.
   - Replace fetch with:
     ```typescript
     const api = createBlockApi(session);
     return await api.getBlockEnvironment({
       workspaceId,
       type: entityType as ApplicationEntityType, // May need type assertion or proper mapping
       entityId,
     });
     ```
   - Replace entire catch block with: `await normalizeApiError(error);`
   - Remove console.error calls (normalizeApiError throws, callers handle logging)

3. Migrate `saveLayoutSnapshot`:
   - Keep validateSession
   - Replace fetch with:
     ```typescript
     const api = createBlockApi(session);
     return await api.saveBlockEnvironment({ saveEnvironmentRequest: request });
     ```
   - Replace entire catch block with: `await normalizeApiError(error);`
   - Remove console.error calls

4. Update imports at top of file:
   - Import `ApplicationEntityType` from `@/lib/types` for the type parameter
   - Or keep EntityType if it's compatible (check if they're the same union)
  </action>
  <verify>
- `npm run build` passes
- loadLayout uses api.getBlockEnvironment with proper parameters
- saveLayoutSnapshot uses api.saveBlockEnvironment
- No console.error calls in either method
- fromError/isResponseError still work for parameter validation errors
  </verify>
  <done>LayoutService methods migrated to generated BlockApi with normalizeApiError</done>
</task>

</tasks>

<verification>
After all tasks:
1. `npm run build` passes with no errors
2. All three service files import createBlockApi from @/lib/api/block-api
3. All three service files import normalizeApiError from @/lib/util/error/error.util
4. No manual fetch calls remain except in BlockTypeService.lintBlockType
5. Return types match generated API (void for updateBlockType, BlockType[] for getBlockTypes)
</verification>

<success_criteria>
- BlockService.hydrateBlocks uses createBlockApi and normalizeApiError
- BlockTypeService.publishBlockType uses createBlockApi and normalizeApiError
- BlockTypeService.updateBlockType uses createBlockApi and normalizeApiError (returns void)
- BlockTypeService.getBlockTypes uses createBlockApi and normalizeApiError (returns BlockType[])
- BlockTypeService.getBlockTypeByKey uses createBlockApi and normalizeApiError
- BlockTypeService.lintBlockType retains manual fetch (no generated coverage)
- LayoutService.loadLayout uses createBlockApi and normalizeApiError
- LayoutService.saveLayoutSnapshot uses createBlockApi and normalizeApiError
- Build passes without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-service-migration/03-01-SUMMARY.md`
</output>
