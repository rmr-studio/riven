---
phase: 05-cleanup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/types/block/custom.ts
  - components/feature-modules/blocks/**/*.ts
  - components/feature-modules/blocks/**/*.tsx
  - components/feature-modules/blocks/interface/*.ts
autonomous: true

must_haves:
  truths:
    - "No files import from blocks interface files"
    - "Block domain types import from @/lib/types/block"
    - "All 7 block interface files are deleted"
  artifacts:
    - path: "lib/types/block/custom.ts"
      provides: "All block custom types including command and editor types"
      contains: "LayoutCommand"
    - path: "lib/types/block/guards.ts"
      provides: "Block type guards"
      contains: "isContentMetadata"
  key_links:
    - from: "components/feature-modules/blocks/**/*"
      to: "@/lib/types/block"
      via: "import statements"
      pattern: "from [\"']@/lib/types/block[\"']"
---

<objective>
Migrate remaining block custom types to domain barrel, update all imports, then delete all 7 block interface files.

Purpose: Remove legacy block interface re-export files as part of OpenAPI migration cleanup.
Output: Custom types migrated to barrel; 52+ block files import from domain barrel; 7 interface files deleted.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-cleanup/05-CONTEXT.md
@.planning/phases/05-cleanup/05-RESEARCH.md

# Domain barrel (target import)
@lib/types/block/index.ts
@lib/types/block/custom.ts
@lib/types/block/guards.ts

# Files to delete (source of truth for what's exported)
@components/feature-modules/blocks/interface/block.interface.ts
@components/feature-modules/blocks/interface/command.interface.ts
@components/feature-modules/blocks/interface/editor.interface.ts
@components/feature-modules/blocks/interface/grid.interface.ts
@components/feature-modules/blocks/interface/layout.interface.ts
@components/feature-modules/blocks/interface/panel.interface.ts
@components/feature-modules/blocks/interface/render.interface.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate block custom types to domain barrel</name>
  <files>
    - lib/types/block/custom.ts
  </files>
  <action>
    Add custom types from block interface files to `lib/types/block/custom.ts`.

    **From command.interface.ts (full migration needed):**
    ```typescript
    // Layout command types
    export interface LayoutSnapshot {
        blockEnvironment: EditorEnvironment;
        gridLayout: GridStackOptions;
        timestamp: string;
        version: number;
    }

    export interface LayoutCommand {
        id: string;
        type: LayoutCommandType;
        description: string;
        timestamp: number;
        execute(): void;
        undo(): void;
        canExecute?(): boolean;
        canUndo?(): boolean;
        metadata?: Record<string, unknown>;
    }

    export enum LayoutCommandType {
        ADD_BLOCK = "ADD_BLOCK",
        REMOVE_BLOCK = "REMOVE_BLOCK",
        MOVE_BLOCK = "MOVE_BLOCK",
        RESIZE_BLOCK = "RESIZE_BLOCK",
        REPOSITION_BLOCK = "REPOSITION_BLOCK",
        REORDER_BLOCK = "REORDER_BLOCK",
        UPDATE_BLOCK = "UPDATE_BLOCK",
        BATCH = "BATCH",
    }

    export type CommandCategory = "structural" | "layout";
    export function isStructuralCommand(type: LayoutCommandType): boolean;
    export function getCommandCategory(type: LayoutCommandType, command?: LayoutCommand): CommandCategory;

    export interface CommandContext {
        blockEnvironment: { ... };
        gridStack: { ... };
    }

    export interface CommandHistoryConfig { ... }
    export interface CommandHistoryState { ... }
    export interface ConflictResolution { ... }

    // Re-exports from OpenAPI (already in models)
    export type StructuralOperationRequest;
    export type StructuralOperationType;
    export type StructuralOperationData;
    export type AddBlockOperation;
    export type RemoveBlockOperation;
    export type MoveBlockOperation;
    export type UpdateBlockOperation;
    export type ReorderBlockOperation;
    export type SaveEnvironmentRequest;
    export type SaveEnvironmentResponse;
    ```

    **From editor.interface.ts (full migration needed):**
    ```typescript
    export interface EditorEnvironmentMetadata { ... }
    export interface DetachResult { ... }
    export interface InsertResult<T> { ... }
    export interface EditorEnvironment { ... }
    export interface BlockEnvironmentProviderProps { ... }
    export interface BlockEnvironmentContextValue { ... }
    ```

    **From grid.interface.ts (full migration needed):**
    ```typescript
    export interface GridEnvironment { ... }
    export interface GridProviderProps { ... }
    export interface GridActionResult<T> { ... }
    export interface GridstackContextValue { ... }
    ```

    **From layout.interface.ts:**
    - GridRect, LayoutGrid, LayoutGridItem, BlockTreeLayout are already re-exports from OpenAPI (already in models.ts)

    **From panel.interface.ts (full migration needed):**
    ```typescript
    export type ResizePosition = "nw" | "ne" | "sw" | "se";
    export interface SlashMenuItem { ... }
    export interface QuickActionItem { ... }
    ```

    **From render.interface.ts (full migration needed):**
    ```typescript
    export interface ProviderProps { ... }
    export interface CallbackProvider { ... }
    export interface WrapElementProvider { ... }
    export type RenderElementContextValue = { ... };
    ```

    **Import requirements for custom.ts:**
    - GridStackOptions, GridStackWidget, GridStackNode, GridStack from "gridstack"
    - ChildNodeProps from "@/lib/interfaces/interface"
    - EntityType from "@/lib/types/entity"
    - ReactNode from "react"
    - Existing types from ./models

    **Note:** Keep imports minimal - only what's needed for the type definitions.
  </action>
  <verify>
    Run: `tsc --noEmit lib/types/block/custom.ts 2>&1 | grep -c "error TS" || echo "0"`
    Expected: 0 errors in custom.ts
  </verify>
  <done>All block custom types from 6 interface files migrated to lib/types/block/custom.ts</done>
</task>

<task type="auto">
  <name>Task 2: Update block domain imports and delete interface files</name>
  <files>
    - components/feature-modules/blocks/context/*.tsx
    - components/feature-modules/blocks/hooks/*.ts
    - components/feature-modules/blocks/hooks/*.tsx
    - components/feature-modules/blocks/util/**/*.ts
    - components/feature-modules/blocks/util/**/*.tsx
    - components/feature-modules/blocks/components/**/*.tsx
    - components/feature-modules/blocks/service/*.ts
    - components/feature-modules/blocks/interface/*.ts (to delete)
  </files>
  <action>
    **Phase A: Update imports in all block files**

    For each file importing from block interface files, update to use domain barrel:

    1. `from "./block.interface"` or `from "../interface/block.interface"` -> `from "@/lib/types/block"`
    2. `from "./command.interface"` or `from "../interface/command.interface"` -> `from "@/lib/types/block"`
    3. `from "./editor.interface"` or `from "../interface/editor.interface"` -> `from "@/lib/types/block"`
    4. `from "./grid.interface"` or `from "../interface/grid.interface"` -> `from "@/lib/types/block"`
    5. `from "./layout.interface"` or `from "../interface/layout.interface"` -> `from "@/lib/types/block"`
    6. `from "./panel.interface"` or `from "../interface/panel.interface"` -> `from "@/lib/types/block"`
    7. `from "./render.interface"` or `from "../interface/render.interface"` -> `from "@/lib/types/block"`

    **Import replacement rules:**
    - Type-only imports: `import type { BlockNode, EditorEnvironment } from "@/lib/types/block"`
    - Runtime values (enums, functions, guards): `import { LayoutCommandType, isStructuralCommand, isContentMetadata } from "@/lib/types/block"`

    **Files importing from block.interface.ts (~52 files):**
    Cross-check with grep output and update all.

    **Files importing from other interface files:**
    - grid.interface.ts: 1 file (grid-provider.tsx)
    - render.interface.ts: 5 files (excludes grid.interface.ts which is being deleted)
    - panel.interface.ts: 9 files
    - command.interface.ts: 5 files
    - editor.interface.ts: 4 files
    - layout.interface.ts: 3 files

    **Phase B: Delete interface files**

    After all imports updated, delete in order (leaf to root):
    1. Delete panel.interface.ts (no interface dependencies)
    2. Delete grid.interface.ts (only depends on render.interface)
    3. Delete render.interface.ts (only depends on block.interface)
    4. Delete layout.interface.ts (only depends on types.ts - being deleted later)
    5. Delete command.interface.ts (depends on block.interface, editor.interface)
    6. Delete editor.interface.ts (depends on block.interface, layout.interface)
    7. Delete block.interface.ts (root - depended on by others)

    Delete all 7 files: `rm components/feature-modules/blocks/interface/*.interface.ts`
  </action>
  <verify>
    Run: `grep -r "from.*interface" components/feature-modules/blocks/ --include="*.ts" --include="*.tsx" 2>/dev/null | grep -v "lib/interfaces" | wc -l`
    Expected: 0 (no imports from interface files, except lib/interfaces/interface.ts)

    Run: `ls components/feature-modules/blocks/interface/*.interface.ts 2>&1 | wc -l`
    Expected: 0 (all interface files deleted) or error message

    Run: `tsc --noEmit 2>&1 | grep -c "error TS"`
    Expected: Same or fewer errors than baseline (281)
  </verify>
  <done>All block files import from @/lib/types/block; all 7 interface files deleted</done>
</task>

</tasks>

<verification>
1. `grep -rE "from.*/(block|command|editor|grid|layout|panel|render)\.interface" components/feature-modules/blocks/ --include="*.ts" --include="*.tsx" 2>/dev/null | wc -l` returns 0
2. `ls components/feature-modules/blocks/interface/*.interface.ts 2>&1` returns "No such file or directory"
3. `tsc --noEmit 2>&1 | grep -c "error TS"` returns <= 281 (baseline)
</verification>

<success_criteria>
- [ ] All block custom types migrated to lib/types/block/custom.ts
- [ ] Zero imports from block interface files in codebase
- [ ] All 7 block interface files deleted
- [ ] TypeScript error count unchanged or decreased
- [ ] All block domain files import from @/lib/types/block
</success_criteria>

<output>
After completion, create `.planning/phases/05-cleanup/05-02-SUMMARY.md`
</output>
