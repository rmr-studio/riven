---
phase: 04-service-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/feature-modules/blocks/service/block-type.service.ts
  - components/feature-modules/blocks/service/block.service.ts
  - components/feature-modules/blocks/service/layout.service.ts
  - components/feature-modules/entity/service/entity-type.service.ts
  - components/feature-modules/entity/service/entity.service.ts
  - components/feature-modules/workspace/service/workspace.service.ts
  - lib/util/service/service.util.ts
autonomous: true

must_haves:
  truths:
    - "All service files use domain Session type from @/lib/auth"
    - "No service files import Session from @supabase/supabase-js"
    - "validateSession utility uses domain Session type"
    - "Application builds successfully"
  artifacts:
    - path: "components/feature-modules/blocks/service/block-type.service.ts"
      provides: "Block type service with domain Session"
      contains: "import { Session } from \"@/lib/auth\""
    - path: "components/feature-modules/blocks/service/block.service.ts"
      provides: "Block service with domain Session"
      contains: "import { Session } from \"@/lib/auth\""
    - path: "components/feature-modules/blocks/service/layout.service.ts"
      provides: "Layout service with domain Session"
      contains: "import { Session } from \"@/lib/auth\""
    - path: "components/feature-modules/entity/service/entity-type.service.ts"
      provides: "Entity type service with domain Session"
      contains: "import { Session } from \"@/lib/auth\""
    - path: "components/feature-modules/entity/service/entity.service.ts"
      provides: "Entity service with domain Session"
      contains: "import { Session } from \"@/lib/auth\""
    - path: "components/feature-modules/workspace/service/workspace.service.ts"
      provides: "Workspace service with domain Session"
      contains: "import { Session } from \"@/lib/auth\""
    - path: "lib/util/service/service.util.ts"
      provides: "Service utilities with domain Session"
      contains: "import { Session } from \"@/lib/auth\""
  key_links:
    - from: "*.service.ts files"
      to: "@/lib/auth"
      via: "Session import"
      pattern: "import.*Session.*from.*@/lib/auth"
---

<objective>
Migrate all service layer files from Supabase Session type to domain Session type.

Purpose: Complete the auth abstraction by ensuring service files use provider-agnostic types.
Output: 7 files updated with domain Session import, application builds successfully.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Domain Session type location
@lib/auth/auth.types.ts
@lib/auth/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate blocks service files</name>
  <files>
    - components/feature-modules/blocks/service/block-type.service.ts
    - components/feature-modules/blocks/service/block.service.ts
    - components/feature-modules/blocks/service/layout.service.ts
  </files>
  <action>
    In each of the 3 blocks service files:
    1. Replace `import { Session } from "@supabase/supabase-js"` with `import { Session } from "@/lib/auth"`
    2. No other changes needed - the domain Session type has the same `access_token` field used by these services

    The change is mechanical - only the import path changes. The Session interface signature is compatible.
  </action>
  <verify>
    Run `grep -r "from \"@supabase/supabase-js\"" components/feature-modules/blocks/service/` returns no results.
    Run `grep -r "from \"@/lib/auth\"" components/feature-modules/blocks/service/ | grep Session` returns 3 files.
  </verify>
  <done>All 3 blocks service files import Session from @/lib/auth instead of @supabase/supabase-js.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate entity and workspace service files</name>
  <files>
    - components/feature-modules/entity/service/entity-type.service.ts
    - components/feature-modules/entity/service/entity.service.ts
    - components/feature-modules/workspace/service/workspace.service.ts
  </files>
  <action>
    In each of the 3 service files:
    1. Replace `import { Session } from "@supabase/supabase-js"` with `import { Session } from "@/lib/auth"`
    2. No other changes needed - the domain Session type has the same `access_token` field used by these services

    The change is mechanical - only the import path changes.
  </action>
  <verify>
    Run `grep -r "from \"@supabase/supabase-js\"" components/feature-modules/entity/service/` returns no results.
    Run `grep -r "from \"@supabase/supabase-js\"" components/feature-modules/workspace/service/` returns no results.
  </verify>
  <done>All 3 entity/workspace service files import Session from @/lib/auth.</done>
</task>

<task type="auto">
  <name>Task 3: Migrate service utility and verify build</name>
  <files>
    - lib/util/service/service.util.ts
  </files>
  <action>
    1. In lib/util/service/service.util.ts:
       - Replace `import { Session } from "@supabase/supabase-js"` with `import { Session } from "@/lib/auth"`
       - The `validateSession()` function type assertion works unchanged since domain Session has `access_token`

    2. After all migrations complete, verify:
       - `npm run build` succeeds
       - No files outside lib/auth/adapters/ import from @supabase/supabase-js for Session type
  </action>
  <verify>
    Run `npm run build` completes successfully.
    Run `grep -r "from \"@supabase/supabase-js\"" components/feature-modules --include="*.service.ts"` returns no results.
    Run `grep -r "from \"@supabase/supabase-js\"" lib/util/service/` returns no results.
  </verify>
  <done>
    - service.util.ts imports Session from @/lib/auth
    - Application builds successfully
    - No service files import Session from @supabase/supabase-js
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `grep -r "import.*Session.*from.*@supabase" components/` returns no results
2. `grep -r "import.*Session.*from.*@supabase" lib/util/` returns no results
3. `npm run build` passes
4. Only files in lib/auth/adapters/ import from @supabase/supabase-js (allowed for adapter implementation)
</verification>

<success_criteria>
1. All 7 files (6 services + 1 utility) import Session from @/lib/auth
2. No *.service.ts files import Session from @supabase/supabase-js
3. Application builds successfully with migrated imports
4. validateSession() utility continues to work with domain Session type
</success_criteria>

<output>
After completion, create `.planning/phases/04-service-migration/04-01-SUMMARY.md`
</output>
