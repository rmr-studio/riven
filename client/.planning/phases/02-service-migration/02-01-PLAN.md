---
phase: 02-service-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/api/entity-api.ts
  - components/feature-modules/entity/service/entity-type.service.ts
autonomous: true

must_haves:
  truths:
    - "EntityTypeService methods use EntityApi instead of manual fetch"
    - "Session-based auth flows through Configuration.accessToken"
    - "409 Conflict responses return impact data, not throw errors"
    - "Validation errors (validateSession, validateUuid) still provide clear messages"
  artifacts:
    - path: "lib/api/entity-api.ts"
      provides: "createEntityApi factory function"
      exports: ["createEntityApi"]
    - path: "components/feature-modules/entity/service/entity-type.service.ts"
      provides: "Migrated EntityTypeService using EntityApi"
      contains: "createEntityApi"
  key_links:
    - from: "entity-type.service.ts"
      to: "lib/api/entity-api.ts"
      via: "import createEntityApi"
      pattern: "import.*createEntityApi.*from.*@/lib/api/entity-api"
    - from: "lib/api/entity-api.ts"
      to: "lib/types"
      via: "import EntityApi, Configuration"
      pattern: "import.*EntityApi.*Configuration.*from.*@/lib/types"
---

<objective>
Create API factory and migrate EntityTypeService from manual fetch to generated EntityApi wrapper.

Purpose: Establishes the API factory pattern and migrates the primary entity type service (7 methods), including proper 409 Conflict handling for impact analysis endpoints.

Output: `lib/api/entity-api.ts` factory function, fully migrated `entity-type.service.ts`
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-service-migration/02-RESEARCH.md
@.planning/phases/01-interface-migration/01-01-SUMMARY.md
@components/feature-modules/entity/service/entity-type.service.ts
@lib/types/apis/EntityApi.ts
@lib/types/runtime.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API factory function</name>
  <files>lib/api/entity-api.ts</files>
  <action>
Create `lib/api/entity-api.ts` with the `createEntityApi` factory function.

Implementation:
```typescript
import { EntityApi, Configuration } from "@/lib/types";
import { Session } from "@supabase/supabase-js";

/**
 * Creates an EntityApi instance configured with session-based authentication.
 * Uses NEXT_PUBLIC_API_URL for base path (without /api suffix - generated paths include it).
 *
 * @param session - Supabase session with access_token
 * @returns Configured EntityApi instance
 * @throws Error if session is invalid or API URL not configured
 */
export function createEntityApi(session: Session): EntityApi {
    const basePath = process.env.NEXT_PUBLIC_API_URL;
    if (!basePath) {
        throw new Error("NEXT_PUBLIC_API_URL is not configured");
    }

    const config = new Configuration({
        basePath,
        accessToken: async () => session.access_token,
    });

    return new EntityApi(config);
}
```

Note: The `Session` parameter is non-null here because `validateSession()` is called BEFORE `createEntityApi()` in service methods, ensuring session exists. This provides better error messages.
  </action>
  <verify>
- File exists at `lib/api/entity-api.ts`
- TypeScript compiles: `npx tsc --noEmit lib/api/entity-api.ts`
  </verify>
  <done>Factory function exports `createEntityApi` with proper typing and configuration</done>
</task>

<task type="auto">
  <name>Task 2: Migrate EntityTypeService to use EntityApi</name>
  <files>components/feature-modules/entity/service/entity-type.service.ts</files>
  <action>
Migrate all 7 methods in EntityTypeService from manual fetch to EntityApi.

**Import changes:**
- Remove: `import { api } from "@/lib/util/utils";`
- Add: `import { createEntityApi } from "@/lib/api/entity-api";`
- Add: `import { ResponseError } from "@/lib/types";`
- Keep: `validateSession`, `validateUuid` from service.util (for early validation)
- Remove: `handleError` (no longer needed with EntityApi)
- Remove: `fromError`, `isResponseError` (no longer needed)

**Method migration mapping (from RESEARCH.md):**

1. `getEntityTypes(session, workspaceId)` -> Simple case
   - `api.getEntityTypesForWorkspace({ workspaceId })`

2. `getEntityTypeByKey(session, workspaceId, key)` -> Simple case
   - `api.getEntityTypeByKeyForWorkspace({ workspaceId, key })`

3. `publishEntityType(session, workspaceId, request)` -> Simple case
   - `api.createEntityType({ workspaceId, createEntityTypeRequest: request })`

4. `saveEntityTypeConfiguration(session, workspaceId, entityType)` -> Simple case
   - `api.updateEntityType({ workspaceId, entityType })`

5. `removeEntityTypeDefinition(session, workspaceId, definition, impactConfirmed)` -> **Catch 409**
   - `api.deleteEntityTypeDefinition({ workspaceId, deleteTypeDefinitionRequest: definition, impactConfirmed })`
   - Catch ResponseError with status 409, return `error.response.json()`

6. `saveEntityTypeDefinition(session, workspaceId, definition, impactConfirmed)` -> **Catch 409**
   - `api.saveEntityTypeDefinition({ workspaceId, saveTypeDefinitionRequest: definition, impactConfirmed })`
   - Catch ResponseError with status 409, return `error.response.json()`

7. `deleteEntityType(session, workspaceId, entityTypeKey, impactConfirmed)` -> **Catch 409**
   - `api.deleteEntityTypeByKey({ workspaceId, key: entityTypeKey, impactConfirmed })`
   - Catch ResponseError with status 409, return `error.response.json()`

**Pattern for simple methods:**
```typescript
static async getEntityTypes(session: Session | null, workspaceId: string): Promise<EntityType[]> {
    validateSession(session);
    validateUuid(workspaceId);
    const api = createEntityApi(session!);
    return api.getEntityTypesForWorkspace({ workspaceId });
}
```

**Pattern for 409-handling methods:**
```typescript
static async saveEntityTypeDefinition(
    session: Session | null,
    workspaceId: string,
    definition: SaveTypeDefinitionRequest,
    impactConfirmed: boolean = false
): Promise<EntityTypeImpactResponse> {
    validateSession(session);
    validateUuid(workspaceId);
    const api = createEntityApi(session!);

    try {
        return await api.saveEntityTypeDefinition({
            workspaceId,
            saveTypeDefinitionRequest: definition,
            impactConfirmed,
        });
    } catch (error) {
        if (error instanceof ResponseError && error.response.status === 409) {
            return await error.response.json();
        }
        throw error;
    }
}
```

**Critical:** Use `session!` (non-null assertion) after `validateSession(session)` since validation throws if null.
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit components/feature-modules/entity/service/entity-type.service.ts`
- No manual fetch calls remain: `grep -c "fetch(" components/feature-modules/entity/service/entity-type.service.ts` returns 0
- Uses createEntityApi: `grep -c "createEntityApi" components/feature-modules/entity/service/entity-type.service.ts` returns 7 (one per method)
  </verify>
  <done>
All 7 EntityTypeService methods use EntityApi:
- 4 simple methods directly return API call results
- 3 impact methods (removeEntityTypeDefinition, saveEntityTypeDefinition, deleteEntityType) catch 409 and return response data
- No manual fetch, no api() utility, no handleError
  </done>
</task>

</tasks>

<verification>
- TypeScript compiles without errors in modified files
- No `fetch(` calls remain in entity-type.service.ts
- No `api()` utility usage remains
- `createEntityApi` imported and used in all 7 methods
- `ResponseError` properly caught for 409-returning endpoints
</verification>

<success_criteria>
1. `lib/api/entity-api.ts` exists with `createEntityApi` factory
2. `entity-type.service.ts` uses EntityApi for all 7 methods
3. 409 responses handled correctly (return data, don't throw)
4. TypeScript compiles without errors
5. Method signatures unchanged (no breaking changes to callers)
</success_criteria>

<output>
After completion, create `.planning/phases/02-service-migration/02-01-SUMMARY.md`
</output>
