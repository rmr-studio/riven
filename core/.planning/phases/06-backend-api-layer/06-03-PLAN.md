---
phase: 06-backend-api-layer
plan: 03
type: execute
wave: 2
depends_on: [06-01]
files_modified:
  - src/main/kotlin/riven/core/controller/workflow/WorkflowExecutionController.kt
  - src/main/kotlin/riven/core/service/workflow/WorkflowExecutionService.kt
autonomous: true

must_haves:
  truths:
    - "User can list all executions for a workflow via GET /api/v1/workflow/executions/workflow/{workflowDefinitionId}"
    - "User can get execution details by ID via GET /api/v1/workflow/executions/{id}"
    - "User can list all executions for workspace via GET /api/v1/workflow/executions/workspace/{workspaceId}"
    - "Execution details include status, duration, input, output, and error information"
    - "User can retrieve node-level execution details for an execution"
  artifacts:
    - path: "src/main/kotlin/riven/core/service/workflow/WorkflowExecutionService.kt"
      provides: "Query methods for execution history"
      exports: ["getExecutionById", "listExecutionsForWorkflow", "listExecutionsForWorkspace"]
    - path: "src/main/kotlin/riven/core/controller/workflow/WorkflowExecutionController.kt"
      provides: "REST endpoints for execution queries"
      exports: ["getExecution", "listWorkflowExecutions", "listWorkspaceExecutions"]
  key_links:
    - from: "src/main/kotlin/riven/core/controller/workflow/WorkflowExecutionController.kt"
      to: "WorkflowExecutionService"
      via: "query methods"
      pattern: "workflowExecutionService\\.(getExecutionById|listExecutions)"
    - from: "src/main/kotlin/riven/core/service/workflow/WorkflowExecutionService.kt"
      to: "WorkflowExecutionRepository"
      via: "execution queries"
      pattern: "workflowExecutionRepository\\.(findById|findByWorkflowDefinitionId|findByWorkspaceId)"
---

<objective>
Extend WorkflowExecutionController and WorkflowExecutionService with query endpoints for execution history

Purpose: Enable users to retrieve execution status, history, and details for observability and debugging.

Output: Complete execution query API with list/get operations for executions at workflow and workspace level.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 6 Plan 1 outputs
@.planning/phases/06-backend-api-layer/06-01-SUMMARY.md

# Existing workflow execution infrastructure
@src/main/kotlin/riven/core/controller/workflow/WorkflowExecutionController.kt
@src/main/kotlin/riven/core/service/workflow/WorkflowExecutionService.kt
@src/main/kotlin/riven/core/entity/workflow/execution/WorkflowExecutionEntity.kt
@src/main/kotlin/riven/core/entity/workflow/execution/WorkflowExecutionNodeEntity.kt
@src/main/kotlin/riven/core/repository/workflow/WorkflowExecutionRepository.kt
@src/main/kotlin/riven/core/repository/workflow/WorkflowExecutionNodeRepository.kt

# Reference patterns
@src/main/kotlin/riven/core/controller/entity/EntityController.kt
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add query methods to WorkflowExecutionService</name>
  <files>
    src/main/kotlin/riven/core/service/workflow/WorkflowExecutionService.kt
  </files>
  <action>
    Extend existing WorkflowExecutionService with query methods:

    **Add methods to service:**

    1. `getExecutionById(id: UUID, workspaceId: UUID): Map<String, Any>`
       - Fetches WorkflowExecutionEntity by ID
       - Verifies workspace access (execution.workspaceId == workspaceId)
       - Throws NotFoundException if not found
       - Throws SecurityException if workspace mismatch
       - Returns execution details as map:
         ```kotlin
         mapOf(
             "executionId" to execution.id,
             "workflowDefinitionId" to execution.workflowDefinitionId,
             "status" to execution.status,
             "startedAt" to execution.startedAt,
             "completedAt" to execution.completedAt,
             "durationMs" to execution.durationMs,
             "triggerType" to execution.triggerType,
             "input" to execution.input,
             "output" to execution.output,
             "error" to execution.error
         )
         ```

    2. `listExecutionsForWorkflow(workflowDefinitionId: UUID, workspaceId: UUID): List<Map<String, Any>>`
       - Add query method to WorkflowExecutionRepository: `findByWorkflowDefinitionIdAndWorkspaceId(workflowDefinitionId: UUID, workspaceId: UUID): List<WorkflowExecutionEntity>`
       - Fetches all executions for workflow definition
       - Verifies workflow definition belongs to workspace
       - Maps each execution to summary map (id, status, startedAt, completedAt, durationMs)
       - Orders by startedAt DESC (most recent first)
       - Returns list of execution summaries

    3. `listExecutionsForWorkspace(workspaceId: UUID): List<Map<String, Any>>`
       - Add query method to WorkflowExecutionRepository: `findByWorkspaceId(workspaceId: UUID): List<WorkflowExecutionEntity>`
       - Fetches all executions in workspace across all workflows
       - Maps to summary (includes workflowDefinitionId for context)
       - Orders by startedAt DESC
       - Returns list of execution summaries

    4. `getExecutionNodeDetails(executionId: UUID, workspaceId: UUID): List<Map<String, Any>>`
       - Fetches WorkflowExecutionNodeEntity records for execution
       - Add query to WorkflowExecutionNodeRepository: `findByWorkflowExecutionId(executionId: UUID): List<WorkflowExecutionNodeEntity>`
       - Verifies execution belongs to workspace
       - Maps each node execution to:
         ```kotlin
         mapOf(
             "nodeId" to nodeExecution.workflowNodeId,
             "status" to nodeExecution.status,
             "startedAt" to nodeExecution.startedAt,
             "completedAt" to nodeExecution.completedAt,
             "output" to nodeExecution.output,
             "error" to nodeExecution.error
         )
         ```
       - Returns list of node execution details

    **Repository additions needed:**
    - WorkflowExecutionRepository.findByWorkflowDefinitionIdAndWorkspaceId()
    - WorkflowExecutionRepository.findByWorkspaceId()
    - WorkflowExecutionNodeRepository.findByWorkflowExecutionId()

    **Important patterns:**
    - Follow existing startExecution() patterns for structure
    - Use KotlinLogging for logging query operations
    - Add @Transactional(readOnly = true) for query methods (optimization)
    - Return maps for flexibility (avoid creating DTOs for now)
  </action>
  <verify>
    ./gradlew compileKotlin - confirms methods compile with repository queries
  </verify>
  <done>
    WorkflowExecutionService has 4 new query methods (getExecutionById, listExecutionsForWorkflow, listExecutionsForWorkspace, getExecutionNodeDetails), repository query methods added
  </done>
</task>

<task type="auto">
  <name>Task 2: Add query endpoints to WorkflowExecutionController</name>
  <files>
    src/main/kotlin/riven/core/controller/workflow/WorkflowExecutionController.kt
  </files>
  <action>
    Extend existing WorkflowExecutionController (currently has only /start endpoint) with query endpoints:

    **Add endpoints:**

    1. **GET /api/v1/workflow/executions/{id}**
       - @Operation(summary = "Get workflow execution by ID")
       - @RequestParam workspaceId: UUID
       - @ApiResponses: 200, 404, 401
       - Returns: ResponseEntity&lt;Map&lt;String, Any&gt;&gt;
       - Calls: workflowExecutionService.getExecutionById()

    2. **GET /api/v1/workflow/executions/workflow/{workflowDefinitionId}**
       - @Operation(summary = "List all executions for a workflow definition")
       - @RequestParam workspaceId: UUID
       - @ApiResponses: 200, 404, 401
       - Returns: ResponseEntity&lt;List&lt;Map&lt;String, Any&gt;&gt;&gt;
       - Calls: workflowExecutionService.listExecutionsForWorkflow()
       - Description: "Returns execution history ordered by most recent first"

    3. **GET /api/v1/workflow/executions/workspace/{workspaceId}**
       - @Operation(summary = "List all executions for workspace")
       - @ApiResponses: 200, 401
       - Returns: ResponseEntity&lt;List&lt;Map&lt;String, Any&gt;&gt;&gt;
       - Calls: workflowExecutionService.listExecutionsForWorkspace()
       - Description: "Returns all workflow executions across all workflows in workspace"

    4. **GET /api/v1/workflow/executions/{id}/nodes**
       - @Operation(summary = "Get node-level execution details")
       - @RequestParam workspaceId: UUID
       - @ApiResponses: 200, 404, 401
       - Returns: ResponseEntity&lt;List&lt;Map&lt;String, Any&gt;&gt;&gt;
       - Calls: workflowExecutionService.getExecutionNodeDetails()
       - Description: "Returns execution status for each node in the workflow"

    **Important patterns:**
    - Maintain consistency with existing /start endpoint structure
    - Use @PreAuthorize("isAuthenticated()") (already applied at class level or add to methods)
    - Log incoming requests
    - Follow RESTful conventions
  </action>
  <verify>
    ./gradlew build -x test - confirms controller compiles with new endpoints
  </verify>
  <done>
    WorkflowExecutionController has 4 new GET endpoints (getExecution, listWorkflowExecutions, listWorkspaceExecutions, getNodeDetails), follows REST patterns
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for execution query methods</name>
  <files>
    src/test/kotlin/riven/core/service/workflow/WorkflowExecutionServiceTest.kt
  </files>
  <action>
    Create unit tests for WorkflowExecutionService query methods:

    **Test class structure:**
    - JUnit 5 with Mockito
    - Mock: WorkflowExecutionRepository, WorkflowExecutionNodeRepository, WorkflowDefinitionRepository, ActivityService, AuthTokenService
    - Test both new query methods and existing startExecution (if not already tested)

    **Test cases (minimum 7 new tests):**

    1. `getExecutionById_success_returnsExecutionDetails()`
       - Mock repository returns execution
       - Verify workspace access check passes
       - Assert returned map contains all fields (executionId, status, startedAt, etc.)

    2. `getExecutionById_notFound_throwsNotFoundException()`
       - Mock repository returns Optional.empty()
       - Assert NotFoundException thrown

    3. `getExecutionById_wrongWorkspace_throwsSecurityException()`
       - Mock returns execution with different workspaceId
       - Assert SecurityException thrown

    4. `listExecutionsForWorkflow_success_returnsList()`
       - Mock repository returns 3 executions
       - Assert returned list has 3 items
       - Verify each item has expected fields
       - Verify ordered by startedAt DESC (most recent first)

    5. `listExecutionsForWorkspace_success_returnsList()`
       - Mock repository returns executions from multiple workflows
       - Assert list contains executions from different workflowDefinitionIds
       - Verify ordered by startedAt DESC

    6. `getExecutionNodeDetails_success_returnsNodeList()`
       - Mock execution exists in workspace
       - Mock nodeRepository returns 5 node executions
       - Assert returned list has 5 items with nodeId, status, output fields

    7. `getExecutionNodeDetails_executionNotFound_throwsNotFoundException()`
       - Mock execution not found
       - Assert NotFoundException thrown

    **Testing patterns:**
    - Use `whenever(repository.findById(any())).thenReturn(Optional.of(mockEntity))` for Mockito mocking
    - Create helper methods to build mock WorkflowExecutionEntity instances
    - Verify @Transactional(readOnly = true) annotation present on query methods
  </action>
  <verify>
    ./gradlew test --tests WorkflowExecutionServiceTest - all tests pass
  </verify>
  <done>
    WorkflowExecutionServiceTest exists with minimum 7 test cases for query methods, all passing
  </done>
</task>

</tasks>

<verification>
**Overall verification:**

1. Build: `./gradlew clean build`
2. Tests: `./gradlew test --tests '*WorkflowExecutionService*'`
3. OpenAPI: Verify WorkflowExecutionController section has 5 endpoints total (1 POST /start + 4 GET queries)
4. Manual test (optional):
   - Start an execution via POST /start
   - Query execution by ID via GET /{id}
   - List executions for workflow via GET /workflow/{workflowDefinitionId}
   - Verify response includes status, timestamps, input/output

**Success criteria:**
- WorkflowExecutionService has 4 new query methods
- WorkflowExecutionController has 4 new GET endpoints
- Repository query methods added for filtering by workflow/workspace
- Unit tests verify success and error cases
</verification>

<success_criteria>
- [ ] WorkflowExecutionService extended with 4 query methods (getExecutionById, listExecutionsForWorkflow, listExecutionsForWorkspace, getExecutionNodeDetails)
- [ ] Repository query methods added to WorkflowExecutionRepository and WorkflowExecutionNodeRepository
- [ ] WorkflowExecutionController extended with 4 GET endpoints
- [ ] Query methods use @Transactional(readOnly = true) for optimization
- [ ] Unit tests created with minimum 7 test cases, all passing
- [ ] ./gradlew build succeeds
- [ ] OpenAPI documentation shows complete execution API (start + query endpoints)
</success_criteria>

<output>
After completion, create `.planning/phases/06-backend-api-layer/06-03-SUMMARY.md`
</output>
