---
phase: 06-backend-api-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/kotlin/riven/core/service/workflow/WorkflowDefinitionService.kt
  - src/main/kotlin/riven/core/controller/workflow/WorkflowDefinitionController.kt
  - src/main/kotlin/riven/core/models/request/workflow/CreateWorkflowDefinitionRequest.kt
  - src/main/kotlin/riven/core/models/request/workflow/UpdateWorkflowDefinitionRequest.kt
autonomous: true

must_haves:
  truths:
    - "User can create a new workflow definition via POST /api/v1/workflow/definitions"
    - "User can retrieve workflow definition by ID via GET /api/v1/workflow/definitions/{id}"
    - "User can list all workflow definitions for workspace via GET /api/v1/workflow/definitions/workspace/{workspaceId}"
    - "User can update workflow metadata (name, description, icon, tags) via PUT"
    - "User can delete workflow definition via DELETE (soft delete)"
  artifacts:
    - path: "src/main/kotlin/riven/core/service/workflow/WorkflowDefinitionService.kt"
      provides: "Workflow definition CRUD business logic"
      min_lines: 150
    - path: "src/main/kotlin/riven/core/controller/workflow/WorkflowDefinitionController.kt"
      provides: "REST endpoints for workflow definitions"
      exports: ["createWorkflow", "getWorkflow", "listWorkflows", "updateWorkflow", "deleteWorkflow"]
    - path: "src/main/kotlin/riven/core/models/request/workflow/CreateWorkflowDefinitionRequest.kt"
      provides: "Request model for workflow creation"
      contains: "data class CreateWorkflowDefinitionRequest"
    - path: "src/main/kotlin/riven/core/models/request/workflow/UpdateWorkflowDefinitionRequest.kt"
      provides: "Request model for workflow update"
      contains: "data class UpdateWorkflowDefinitionRequest"
  key_links:
    - from: "src/main/kotlin/riven/core/controller/workflow/WorkflowDefinitionController.kt"
      to: "WorkflowDefinitionService"
      via: "constructor injection"
      pattern: "private val workflowDefinitionService: WorkflowDefinitionService"
    - from: "src/main/kotlin/riven/core/service/workflow/WorkflowDefinitionService.kt"
      to: "WorkflowDefinitionRepository"
      via: "constructor injection"
      pattern: "private val workflowDefinitionRepository: WorkflowDefinitionRepository"
    - from: "src/main/kotlin/riven/core/service/workflow/WorkflowDefinitionService.kt"
      to: "ActivityService"
      via: "audit logging"
      pattern: "activityService\\.logActivity"
---

<objective>
Implement REST APIs for workflow definition lifecycle management

Purpose: Enable users to create, retrieve, update, and delete workflow definitions through REST endpoints, establishing the foundation for workflow graph construction in subsequent plans.

Output: Complete CRUD API for workflow definitions with service layer business logic, request/response models, and activity logging.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing workflow infrastructure
@src/main/kotlin/riven/core/entity/workflow/WorkflowDefinitionEntity.kt
@src/main/kotlin/riven/core/entity/workflow/WorkflowDefinitionVersionEntity.kt
@src/main/kotlin/riven/core/repository/workflow/WorkflowDefinitionRepository.kt
@src/main/kotlin/riven/core/repository/workflow/WorkflowDefinitionVersionRepository.kt
@src/main/kotlin/riven/core/models/workflow/WorkflowDefinition.kt

# Reference patterns from existing codebase
@src/main/kotlin/riven/core/controller/entity/EntityTypeController.kt
@src/main/kotlin/riven/core/service/entity/type/EntityTypeService.kt
@src/main/kotlin/riven/core/controller/workflow/WorkflowExecutionController.kt

# CLAUDE.md for architectural patterns
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WorkflowDefinitionService with CRUD operations</name>
  <files>
    src/main/kotlin/riven/core/service/workflow/WorkflowDefinitionService.kt
    src/main/kotlin/riven/core/models/request/workflow/CreateWorkflowDefinitionRequest.kt
    src/main/kotlin/riven/core/models/request/workflow/UpdateWorkflowDefinitionRequest.kt
  </files>
  <action>
    Create WorkflowDefinitionService following established service layer patterns from CLAUDE.md:

    **Service class structure:**
    - Use constructor injection (no @Autowired)
    - Inject: WorkflowDefinitionRepository, WorkflowDefinitionVersionRepository, ActivityService, AuthTokenService
    - Mark service methods as @Transactional where appropriate

    **Implement methods:**

    1. `createWorkflow(workspaceId: UUID, request: CreateWorkflowDefinitionRequest): WorkflowDefinition`
       - Creates WorkflowDefinitionEntity with status=DRAFT, versionNumber=1
       - Creates initial WorkflowDefinitionVersionEntity with empty workflow/canvas ({})
       - Logs activity (CREATE operation, WORKFLOW_DEFINITION entity type)
       - Returns WorkflowDefinition model via toModel()

    2. `getWorkflowById(id: UUID, workspaceId: UUID): WorkflowDefinition`
       - Fetches definition and version, verifies workspace access
       - Throws NotFoundException if not found
       - Throws SecurityException if workspace mismatch
       - Returns WorkflowDefinition model

    3. `listWorkflowsForWorkspace(workspaceId: UUID): List<WorkflowDefinition>`
       - Fetches all definitions for workspace
       - For each definition, fetch current version by versionNumber
       - Returns list of WorkflowDefinition models

    4. `updateWorkflow(id: UUID, workspaceId: UUID, request: UpdateWorkflowDefinitionRequest): WorkflowDefinition`
       - Updates metadata: name, description, icon (colour + type), tags
       - Does NOT update workflow/canvas structure (that's handled separately)
       - Verifies workspace access
       - Logs activity (UPDATE operation)
       - Returns updated WorkflowDefinition model

    5. `deleteWorkflow(id: UUID, workspaceId: UUID): Unit`
       - Performs soft delete (sets deleted=true, deletedAt=now)
       - Verifies workspace access
       - Logs activity (DELETE operation)
       - Throws NotFoundException if not found

    **Request models to create:**

    CreateWorkflowDefinitionRequest:
    ```kotlin
    data class CreateWorkflowDefinitionRequest(
        val name: String,
        val description: String? = null,
        val iconColour: IconColour = IconColour.NEUTRAL,
        val iconType: IconType = IconType.FILE,
        val tags: List<String> = emptyList()
    )
    ```

    UpdateWorkflowDefinitionRequest:
    ```kotlin
    data class UpdateWorkflowDefinitionRequest(
        val name: String?,
        val description: String?,
        val iconColour: IconColour?,
        val iconType: IconType?,
        val tags: List<String>?
    )
    ```

    **Important patterns:**
    - Follow EntityTypeService patterns for structure
    - Use KotlinLogging for logging (private val log = KotlinLogging.logger {})
    - Activity logging: Use ApplicationEntityType.WORKFLOW_DEFINITION (if doesn't exist, add to enum)
    - Error handling: NotFoundException, SecurityException for domain errors
  </action>
  <verify>
    ./gradlew compileKotlin - confirms syntax validity and dependency injection
  </verify>
  <done>
    WorkflowDefinitionService exists with 5 public methods (create, get, list, update, delete), request models created, compiles successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Create WorkflowDefinitionController with REST endpoints</name>
  <files>
    src/main/kotlin/riven/core/controller/workflow/WorkflowDefinitionController.kt
  </files>
  <action>
    Create WorkflowDefinitionController following EntityTypeController patterns:

    **Controller structure:**
    - @RestController annotation
    - @RequestMapping("/api/v1/workflow/definitions")
    - @Tag annotation for OpenAPI documentation
    - Constructor inject WorkflowDefinitionService

    **Implement endpoints:**

    1. **POST /api/v1/workflow/definitions/workspace/{workspaceId}**
       - @Operation(summary = "Create a new workflow definition")
       - @ApiResponses: 201 (created), 400 (invalid), 401 (unauthorized)
       - Body: CreateWorkflowDefinitionRequest
       - Returns: ResponseEntity&lt;WorkflowDefinition&gt; with HttpStatus.CREATED
       - Calls: workflowDefinitionService.createWorkflow()

    2. **GET /api/v1/workflow/definitions/{id}**
       - @Operation(summary = "Get workflow definition by ID")
       - @RequestParam workspaceId: UUID (required)
       - @ApiResponses: 200 (success), 404 (not found), 401 (unauthorized)
       - Returns: ResponseEntity&lt;WorkflowDefinition&gt;
       - Calls: workflowDefinitionService.getWorkflowById()

    3. **GET /api/v1/workflow/definitions/workspace/{workspaceId}**
       - @Operation(summary = "List all workflow definitions for workspace")
       - @ApiResponses: 200 (success), 401 (unauthorized)
       - Returns: ResponseEntity&lt;List&lt;WorkflowDefinition&gt;&gt;
       - Calls: workflowDefinitionService.listWorkflowsForWorkspace()

    4. **PUT /api/v1/workflow/definitions/{id}**
       - @Operation(summary = "Update workflow definition metadata")
       - @RequestParam workspaceId: UUID (required)
       - Body: UpdateWorkflowDefinitionRequest
       - @ApiResponses: 200 (updated), 400 (invalid), 404 (not found), 401 (unauthorized)
       - Returns: ResponseEntity&lt;WorkflowDefinition&gt;
       - Calls: workflowDefinitionService.updateWorkflow()

    5. **DELETE /api/v1/workflow/definitions/{id}**
       - @Operation(summary = "Delete workflow definition")
       - @RequestParam workspaceId: UUID (required)
       - @ApiResponses: 204 (deleted), 404 (not found), 401 (unauthorized)
       - Returns: ResponseEntity&lt;Void&gt; with HttpStatus.NO_CONTENT
       - Calls: workflowDefinitionService.deleteWorkflow()

    **Important patterns:**
    - Use @PreAuthorize("isAuthenticated()") on all endpoints (or class-level)
    - Add KotlinLogging for request logging (log.info { "POST /api/v1/workflow/definitions/workspace/$workspaceId" })
    - Follow EntityTypeController structure for consistency
    - Use proper HTTP status codes (201 for create, 204 for delete, 200 for updates/reads)
  </action>
  <verify>
    ./gradlew compileKotlin && ./gradlew build -x test - confirms controller properly wired
  </verify>
  <done>
    WorkflowDefinitionController exists with 5 REST endpoints (POST, GET, GET list, PUT, DELETE), compiles successfully, follows established patterns
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for WorkflowDefinitionService</name>
  <files>
    src/test/kotlin/riven/core/service/workflow/WorkflowDefinitionServiceTest.kt
  </files>
  <action>
    Create comprehensive unit tests for WorkflowDefinitionService:

    **Test class structure:**
    - Use JUnit 5 (@Test, @BeforeEach)
    - Mock dependencies with Mockito (@Mock, @InjectMocks or manual instantiation)
    - Use @ExtendWith(MockitoExtension::class) if using annotations

    **Test cases to implement (minimum 8 tests):**

    1. `createWorkflow_success_createsDefinitionAndVersion()`
       - Mock repository returns saved entity with ID
       - Verify WorkflowDefinitionEntity created with correct fields
       - Verify WorkflowDefinitionVersionEntity created with empty workflow/canvas
       - Verify ActivityService.logActivity called once
       - Assert returned WorkflowDefinition has correct properties

    2. `getWorkflowById_success_returnsWorkflow()`
       - Mock repository returns definition and version
       - Verify workspace access check passes
       - Assert returned WorkflowDefinition matches expected

    3. `getWorkflowById_notFound_throwsNotFoundException()`
       - Mock repository returns Optional.empty()
       - Assert NotFoundException thrown with correct message

    4. `getWorkflowById_wrongWorkspace_throwsSecurityException()`
       - Mock repository returns definition with different workspaceId
       - Assert SecurityException thrown

    5. `listWorkflowsForWorkspace_success_returnsList()`
       - Mock repository returns list of 3 definitions
       - Mock version repository returns corresponding versions
       - Assert returned list has 3 WorkflowDefinition items

    6. `updateWorkflow_success_updatesMetadata()`
       - Mock repository returns existing definition
       - Provide UpdateWorkflowDefinitionRequest with new name/description
       - Verify repository.save called with updated fields
       - Verify ActivityService.logActivity called

    7. `deleteWorkflow_success_softDeletes()`
       - Mock repository returns existing definition
       - Verify repository.save called with deleted=true
       - Verify ActivityService.logActivity called with DELETE operation

    8. `deleteWorkflow_notFound_throwsNotFoundException()`
       - Mock repository returns Optional.empty()
       - Assert NotFoundException thrown

    **Testing patterns:**
    - Use `verify(repository, times(1)).save(any())` for Mockito verification
    - Use `assertThrows<NotFoundException>` for exception testing (Kotlin syntax)
    - Mock authTokenService.getUserId() to return test UUID
    - Use descriptive assertion messages
  </action>
  <verify>
    ./gradlew test --tests WorkflowDefinitionServiceTest - all tests pass
  </verify>
  <done>
    WorkflowDefinitionServiceTest exists with minimum 8 test cases covering success and error scenarios, all tests passing
  </done>
</task>

</tasks>

<verification>
**Overall phase verification:**

1. Build succeeds: `./gradlew clean build`
2. All tests pass: `./gradlew test --tests '*WorkflowDefinitionService*'`
3. OpenAPI docs accessible: Start server, visit http://localhost:8081/docs/swagger-ui.html, verify "Workflow Definition Management" section exists with 5 endpoints
4. Manual API test (optional):
   - POST /api/v1/workflow/definitions/workspace/{workspaceId} with {"name":"Test Workflow"} returns 201
   - GET /api/v1/workflow/definitions/{id}?workspaceId={workspaceId} returns 200 with workflow
   - PUT updates metadata successfully
   - DELETE soft-deletes successfully

**Success criteria:**
- WorkflowDefinitionService implements 5 CRUD methods
- WorkflowDefinitionController exposes 5 REST endpoints
- Unit tests achieve >80% coverage on service layer
- No compilation errors
- Integration with existing repositories successful
</verification>

<success_criteria>
- [ ] WorkflowDefinitionService created with create, get, list, update, delete methods
- [ ] Request models (CreateWorkflowDefinitionRequest, UpdateWorkflowDefinitionRequest) created
- [ ] WorkflowDefinitionController created with 5 REST endpoints
- [ ] All endpoints follow established patterns (constructor injection, activity logging, error handling)
- [ ] Unit tests created with minimum 8 test cases, all passing
- [ ] ./gradlew build succeeds with no errors
- [ ] OpenAPI documentation generated correctly
</success_criteria>

<output>
After completion, create `.planning/phases/06-backend-api-layer/06-01-SUMMARY.md`
</output>
