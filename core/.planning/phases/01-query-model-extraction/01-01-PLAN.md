---
phase: 01-query-model-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/kotlin/riven/core/models/entity/query/EntityQuery.kt
  - src/main/kotlin/riven/core/models/entity/query/QueryFilter.kt
  - src/main/kotlin/riven/core/models/entity/query/RelationshipCondition.kt
  - src/main/kotlin/riven/core/models/entity/query/QueryPagination.kt
  - src/main/kotlin/riven/core/models/entity/query/QueryProjection.kt
autonomous: true

must_haves:
  truths:
    - "EntityQuery model exists with maxDepth field (default 3, validated 1-10)"
    - "QueryFilter sealed interface has ATTRIBUTE, RELATIONSHIP, AND, OR subtypes"
    - "RelationshipCondition sealed interface has EXISTS, NOT_EXISTS, TARGET_EQUALS, TARGET_MATCHES, TARGET_TYPE_MATCHES, COUNT_MATCHES subtypes"
    - "TargetTypeMatches has branches list with TypeBranch (entityTypeId + optional filter)"
    - "All Jackson annotations preserved for JSON backward compatibility"
  artifacts:
    - path: "src/main/kotlin/riven/core/models/entity/query/EntityQuery.kt"
      provides: "EntityQuery data class with maxDepth"
      contains: "maxDepth: Int = 3"
    - path: "src/main/kotlin/riven/core/models/entity/query/QueryFilter.kt"
      provides: "QueryFilter sealed interface, FilterOperator enum, FilterValue sealed interface"
      exports: ["QueryFilter", "FilterOperator", "FilterValue"]
    - path: "src/main/kotlin/riven/core/models/entity/query/RelationshipCondition.kt"
      provides: "RelationshipCondition sealed interface with all subtypes including TargetTypeMatches"
      exports: ["RelationshipCondition", "TypeBranch"]
    - path: "src/main/kotlin/riven/core/models/entity/query/QueryPagination.kt"
      provides: "QueryPagination, OrderByClause, SortDirection"
      exports: ["QueryPagination", "OrderByClause", "SortDirection"]
    - path: "src/main/kotlin/riven/core/models/entity/query/QueryProjection.kt"
      provides: "QueryProjection data class"
      exports: ["QueryProjection"]
  key_links:
    - from: "EntityQuery.kt"
      to: "QueryFilter.kt"
      via: "filter property type reference"
      pattern: "filter: QueryFilter\\?"
    - from: "QueryFilter.kt"
      to: "RelationshipCondition.kt"
      via: "Relationship subtype's condition property"
      pattern: "condition: RelationshipCondition"
    - from: "RelationshipCondition.kt"
      to: "QueryFilter.kt"
      via: "TargetMatches and TargetTypeMatches filter property"
      pattern: "filter: QueryFilter"
---

<objective>
Create query model files in the shared `models/entity/query/` directory.

Purpose: Extract query-related models from WorkflowQueryEntityActionConfig into a reusable location so any feature (not just workflows) can build entity queries.

Output: 5 Kotlin files containing all query models with proper Jackson annotations and validation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-query-model-extraction/01-CONTEXT.md
@.planning/phases/01-query-model-extraction/01-RESEARCH.md
@src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowQueryEntityActionConfig.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EntityQuery and QueryProjection</name>
  <files>
    src/main/kotlin/riven/core/models/entity/query/EntityQuery.kt
    src/main/kotlin/riven/core/models/entity/query/QueryProjection.kt
  </files>
  <action>
Create the `src/main/kotlin/riven/core/models/entity/query/` directory.

**EntityQuery.kt:**
- Copy EntityQuery from WorkflowQueryEntityActionConfig.kt (lines 367-374)
- Add `maxDepth: Int = 3` property with validation in init block: `require(maxDepth in 1..10)`
- Add @Schema annotations for maxDepth (description, defaultValue="3", minimum="1", maximum="10")
- Package: `riven.core.models.entity.query`
- Keep all existing KDoc and @Schema annotations

**QueryProjection.kt:**
- Copy QueryProjection from WorkflowQueryEntityActionConfig.kt (lines 735-753)
- Package: `riven.core.models.entity.query`
- Keep all existing annotations unchanged
  </action>
  <verify>
Files compile: `./gradlew compileKotlin 2>&1 | head -50`
  </verify>
  <done>
EntityQuery.kt exists with maxDepth field (default 3, validated 1-10). QueryProjection.kt exists with all original fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create QueryFilter and QueryPagination</name>
  <files>
    src/main/kotlin/riven/core/models/entity/query/QueryFilter.kt
    src/main/kotlin/riven/core/models/entity/query/QueryPagination.kt
  </files>
  <action>
**QueryFilter.kt:**
- Copy QueryFilter sealed interface from WorkflowQueryEntityActionConfig.kt (lines 380-473)
- Copy FilterOperator enum (lines 627-669)
- Copy FilterValue sealed interface (lines 579-617)
- Package: `riven.core.models.entity.query`
- Keep ALL @JsonTypeName, @JsonTypeInfo, @JsonSubTypes annotations exactly as-is (backward compatibility)
- Keep all @Schema annotations unchanged

**QueryPagination.kt:**
- Copy QueryPagination from WorkflowQueryEntityActionConfig.kt (lines 683-692)
- Copy OrderByClause (lines 700-707)
- Copy SortDirection enum (lines 713-719)
- Package: `riven.core.models.entity.query`
- Keep all annotations unchanged
  </action>
  <verify>
Files compile: `./gradlew compileKotlin 2>&1 | head -50`
  </verify>
  <done>
QueryFilter.kt exists with sealed interface + 4 subtypes + FilterOperator + FilterValue. QueryPagination.kt exists with QueryPagination + OrderByClause + SortDirection.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create RelationshipCondition with TargetTypeMatches</name>
  <files>
    src/main/kotlin/riven/core/models/entity/query/RelationshipCondition.kt
  </files>
  <action>
**RelationshipCondition.kt:**
- Copy RelationshipCondition sealed interface from WorkflowQueryEntityActionConfig.kt (lines 484-569)
- Add new TypeBranch data class (before sealed interface):
  ```kotlin
  @Schema(description = "Type branch for polymorphic relationship filtering.")
  data class TypeBranch(
      @Schema(description = "UUID of the entity type this branch matches.")
      val entityTypeId: UUID,
      @Schema(description = "Optional filter to apply to entities of this type.", nullable = true)
      val filter: QueryFilter? = null
  )
  ```
- Add TargetTypeMatches as new subtype inside RelationshipCondition:
  ```kotlin
  @Schema(description = "Type-aware filtering for polymorphic relationships.")
  @JsonTypeName("TARGET_TYPE_MATCHES")
  data class TargetTypeMatches(
      @Schema(description = "Type-specific filter branches. At least one required.")
      val branches: List<TypeBranch>
  ) : RelationshipCondition {
      init {
          require(branches.isNotEmpty()) { "TargetTypeMatches requires at least one branch" }
      }
  }
  ```
- Update @JsonSubTypes to include the new type:
  ```kotlin
  JsonSubTypes.Type(RelationshipCondition.TargetTypeMatches::class, name = "TARGET_TYPE_MATCHES")
  ```
- Update @Schema oneOf array to include TargetTypeMatches
- Package: `riven.core.models.entity.query`
  </action>
  <verify>
File compiles: `./gradlew compileKotlin 2>&1 | head -50`
Verify TargetTypeMatches exists: `grep -n "TargetTypeMatches" src/main/kotlin/riven/core/models/entity/query/RelationshipCondition.kt`
  </verify>
  <done>
RelationshipCondition.kt exists with all 6 subtypes (EXISTS, NOT_EXISTS, TARGET_EQUALS, TARGET_MATCHES, TARGET_TYPE_MATCHES, COUNT_MATCHES). TypeBranch class exists with entityTypeId and optional filter. TargetTypeMatches validates non-empty branches.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. All 5 files exist in `src/main/kotlin/riven/core/models/entity/query/`:
   - `ls src/main/kotlin/riven/core/models/entity/query/`

2. Project compiles without errors:
   - `./gradlew compileKotlin`

3. Jackson annotations preserved (spot check):
   - `grep -c "@JsonTypeName" src/main/kotlin/riven/core/models/entity/query/*.kt`

4. New TargetTypeMatches type exists:
   - `grep "TARGET_TYPE_MATCHES" src/main/kotlin/riven/core/models/entity/query/RelationshipCondition.kt`

5. maxDepth validation exists:
   - `grep "require(maxDepth" src/main/kotlin/riven/core/models/entity/query/EntityQuery.kt`
</verification>

<success_criteria>
- 5 model files created in models/entity/query/
- All models have correct package declaration (riven.core.models.entity.query)
- Jackson annotations match original values exactly (@JsonTypeName values unchanged)
- EntityQuery has maxDepth with default 3, validated 1-10
- TargetTypeMatches exists with branches list and non-empty validation
- TypeBranch has entityTypeId (UUID) and optional filter (QueryFilter?)
- Project compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/01-query-model-extraction/01-01-SUMMARY.md`
</output>
