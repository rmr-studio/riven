---
phase: 07-error-handling-retry-logic
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/kotlin/riven/core/configuration/workflow/WorkflowRetryConfigurationProperties.kt
  - src/main/kotlin/riven/core/models/workflow/engine/error/WorkflowExecutionError.kt
  - src/main/kotlin/riven/core/models/workflow/engine/error/NodeExecutionError.kt
  - src/main/kotlin/riven/core/models/workflow/engine/error/RetryAttempt.kt
  - src/main/kotlin/riven/core/enums/workflow/WorkflowErrorType.kt
  - src/main/resources/application.yml
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Retry configuration values are externalized in application.yml"
    - "Structured error models capture error type, message, retry history, and stack trace"
    - "Error type enum classifies errors into retryable vs non-retryable categories"
  artifacts:
    - path: "src/main/kotlin/riven/core/configuration/workflow/WorkflowRetryConfigurationProperties.kt"
      provides: "Externalized retry configuration binding"
      exports: ["WorkflowRetryConfigurationProperties", "RetryConfig", "HttpRetryConfig"]
    - path: "src/main/kotlin/riven/core/models/workflow/engine/error/WorkflowExecutionError.kt"
      provides: "Workflow-level error model for JSONB storage"
      exports: ["WorkflowExecutionError"]
    - path: "src/main/kotlin/riven/core/models/workflow/engine/error/NodeExecutionError.kt"
      provides: "Node-level error model with retry history"
      exports: ["NodeExecutionError"]
    - path: "src/main/kotlin/riven/core/models/workflow/engine/error/RetryAttempt.kt"
      provides: "Single retry attempt record"
      exports: ["RetryAttempt"]
    - path: "src/main/kotlin/riven/core/enums/workflow/WorkflowErrorType.kt"
      provides: "Error classification enum"
      exports: ["WorkflowErrorType"]
  key_links:
    - from: "src/main/resources/application.yml"
      to: "WorkflowRetryConfigurationProperties"
      via: "@ConfigurationProperties binding"
      pattern: "riven\\.workflow\\.retry"
    - from: "NodeExecutionError"
      to: "RetryAttempt"
      via: "retryAttempts list"
      pattern: "retryAttempts.*List<RetryAttempt>"
---

<objective>
Create retry configuration infrastructure and structured error models for workflow execution.

Purpose: Establish the foundation for error handling by defining externalized retry configuration and typed error models that can be stored in JSONB columns and returned in API responses.

Output:
- WorkflowRetryConfigurationProperties bound to application.yml
- Structured error models (WorkflowExecutionError, NodeExecutionError, RetryAttempt)
- WorkflowErrorType enum for error classification
- Updated application.yml with retry settings
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-error-handling-retry-logic/07-RESEARCH.md
@.planning/phases/07-error-handling-retry-logic/07-CONTEXT.md
@src/main/kotlin/riven/core/configuration/workflow/TemporalEngineConfigurationProperties.kt
@src/main/kotlin/riven/core/entity/workflow/execution/WorkflowExecutionNodeEntity.kt
@src/main/resources/application.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WorkflowErrorType enum and RetryAttempt model</name>
  <files>
    src/main/kotlin/riven/core/enums/workflow/WorkflowErrorType.kt
    src/main/kotlin/riven/core/models/workflow/engine/error/RetryAttempt.kt
  </files>
  <action>
Create WorkflowErrorType enum in enums/workflow/ with error classification values:
- HTTP_CLIENT_ERROR (4xx - non-retryable)
- HTTP_SERVER_ERROR (5xx - retryable)
- VALIDATION_ERROR (schema/input validation - non-retryable)
- CONTROL_FLOW_ERROR (CONDITION node deterministic failure - non-retryable)
- SECURITY_ERROR (auth/authz - non-retryable)
- DATABASE_ERROR (connection issues - retryable)
- NETWORK_ERROR (timeout/connection - retryable)
- EXECUTION_ERROR (generic - retryable)
- UNKNOWN_ERROR (fallback - retryable)

Include a property `retryable: Boolean` for each enum value.

Create RetryAttempt data class in models/workflow/engine/error/:
```kotlin
data class RetryAttempt(
    val attemptNumber: Int,
    val timestamp: ZonedDateTime,
    val errorType: WorkflowErrorType,
    val errorMessage: String,
    val durationMs: Long
)
```

Use ZonedDateTime for timestamps (consistent with existing entities).
  </action>
  <verify>
Files compile: `./gradlew compileKotlin`
  </verify>
  <done>
WorkflowErrorType enum exists with retryable property, RetryAttempt data class exists with all fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create NodeExecutionError and WorkflowExecutionError models</name>
  <files>
    src/main/kotlin/riven/core/models/workflow/engine/error/NodeExecutionError.kt
    src/main/kotlin/riven/core/models/workflow/engine/error/WorkflowExecutionError.kt
  </files>
  <action>
Create NodeExecutionError data class for per-node error details (stored in workflow_node_executions.error JSONB):
```kotlin
data class NodeExecutionError(
    val errorType: WorkflowErrorType,
    val message: String,
    val httpStatusCode: Int? = null,        // For HTTP action errors
    val retryAttempts: List<RetryAttempt>,  // History of all attempts
    val isFinal: Boolean,                   // True if retries exhausted or non-retryable
    val stackTrace: String? = null          // Optional, for debug mode (truncated to 10KB)
)
```

Create WorkflowExecutionError data class for workflow-level summary (stored in workflow_executions.error JSONB):
```kotlin
data class WorkflowExecutionError(
    val failedNodeId: UUID,
    val failedNodeName: String,
    val failedNodeType: String,
    val errorType: WorkflowErrorType,
    val message: String,
    val totalRetryCount: Int,               // Sum across all nodes
    val timestamp: ZonedDateTime
)
```

Both classes should be serializable to JSON via Jackson (use data classes, no special annotations needed).
  </action>
  <verify>
Files compile: `./gradlew compileKotlin`
  </verify>
  <done>
NodeExecutionError and WorkflowExecutionError data classes exist with all specified fields, properly importing RetryAttempt and WorkflowErrorType.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create WorkflowRetryConfigurationProperties and update application.yml</name>
  <files>
    src/main/kotlin/riven/core/configuration/workflow/WorkflowRetryConfigurationProperties.kt
    src/main/resources/application.yml
  </files>
  <action>
Create WorkflowRetryConfigurationProperties in configuration/workflow/:
```kotlin
@ConfigurationProperties("riven.workflow.retry")
data class WorkflowRetryConfigurationProperties(
    val default: RetryConfig = RetryConfig(),
    val httpAction: HttpRetryConfig = HttpRetryConfig(),
    val crudAction: RetryConfig = RetryConfig(maxAttempts = 2)
)

data class RetryConfig(
    val maxAttempts: Int = 3,
    val initialIntervalSeconds: Long = 1,
    val backoffCoefficient: Double = 2.0,
    val maxIntervalSeconds: Long = 30
)

data class HttpRetryConfig(
    val maxAttempts: Int = 3,
    val initialIntervalSeconds: Long = 2,
    val backoffCoefficient: Double = 2.0,
    val maxIntervalSeconds: Long = 60,
    val nonRetryableStatusCodes: List<Int> = listOf(400, 401, 403, 404, 422)
)
```

Update application.yml to add retry configuration under existing riven.workflow section:
```yaml
riven:
  workflow:
    engine:
      target: ${TEMPORAL_SERVER_ADDRESS}
    retry:
      default:
        max-attempts: 3
        initial-interval-seconds: 1
        backoff-coefficient: 2.0
        max-interval-seconds: 30
      http-action:
        max-attempts: 3
        initial-interval-seconds: 2
        backoff-coefficient: 2.0
        max-interval-seconds: 60
        non-retryable-status-codes: [400, 401, 403, 404, 422]
      crud-action:
        max-attempts: 2
        initial-interval-seconds: 1
        backoff-coefficient: 2.0
        max-interval-seconds: 10
```

Add @EnableConfigurationProperties or @ConfigurationPropertiesScan to pick up the new properties (check if already configured in CoreApplication.kt).
  </action>
  <verify>
Application starts successfully: `./gradlew bootRun` (check for configuration binding errors in first 30s then Ctrl+C).
Or verify with: `./gradlew compileKotlin`
  </verify>
  <done>
WorkflowRetryConfigurationProperties binds to application.yml retry section, providing type-safe access to retry configuration values.
  </done>
</task>

</tasks>

<verification>
All files compile without errors:
```bash
./gradlew compileKotlin
```

Configuration binding verified (no startup errors related to retry config).
</verification>

<success_criteria>
- [ ] WorkflowErrorType enum exists with retryable property
- [ ] RetryAttempt data class captures single retry attempt
- [ ] NodeExecutionError captures per-node error details with retry history
- [ ] WorkflowExecutionError captures workflow-level error summary
- [ ] WorkflowRetryConfigurationProperties binds to application.yml
- [ ] application.yml contains retry configuration under riven.workflow.retry
- [ ] All code compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-error-handling-retry-logic/07-01-SUMMARY.md`
</output>
