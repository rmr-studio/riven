---
phase: 01-foundation-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/test/kotlin/riven/core/models/workflow/node/config/OutputMetadataValidationTest.kt
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Every declared outputMetadata key exists in the corresponding NodeOutput.toMap() result"
    - "Every declared OutputFieldType matches the actual Kotlin type returned by toMap()"
    - "Test output lists all node types that lack outputMetadata as warnings (Phase 3 TODO tracker)"
  artifacts:
    - path: "src/test/kotlin/riven/core/models/workflow/node/config/OutputMetadataValidationTest.kt"
      provides: "Parameterized validation tests for output metadata"
      min_lines: 80
  key_links:
    - from: "OutputMetadataValidationTest"
      to: "WorkflowNodeOutputMetadata.fields"
      via: "key comparison against NodeOutput.toMap().keys"
      pattern: "outputMetadata.*fields.*map.*key"
    - from: "OutputMetadataValidationTest"
      to: "OutputFieldType"
      via: "type validation against toMap() value runtime types"
      pattern: "OutputFieldType\\."
---

<objective>
Create parameterized unit tests that validate outputMetadata declarations match actual NodeOutput.toMap() behavior -- keys must exist, types must match, and nodes without outputMetadata are listed as warnings.

Purpose: Ensures output metadata stays in sync with actual node outputs. Prevents drift where metadata declares fields that don't exist or have wrong types. Also acts as a Phase 3 rollout tracker by listing uncovered nodes.

Output: One test file with parameterized tests covering key validation, type validation, and coverage tracking.
</objective>

<execution_context>
@/home/jared/.claude/get-shit-done/workflows/execute-plan.md
@/home/jared/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-infrastructure/01-CONTEXT.md
@.planning/phases/01-foundation-infrastructure/01-RESEARCH.md
@.planning/phases/01-foundation-infrastructure/01-01-SUMMARY.md

@src/main/kotlin/riven/core/models/workflow/engine/state/NodeOutput.kt
@src/main/kotlin/riven/core/enums/workflow/OutputFieldType.kt
@src/main/kotlin/riven/core/models/workflow/node/config/WorkflowNodeOutputField.kt
@src/main/kotlin/riven/core/models/workflow/node/config/WorkflowNodeOutputMetadata.kt
@src/main/kotlin/riven/core/service/workflow/WorkflowNodeConfigRegistry.kt
@src/test/kotlin/riven/core/models/workflow/engine/state/NodeOutputTest.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create parameterized output metadata validation tests</name>
  <files>
    src/test/kotlin/riven/core/models/workflow/node/config/OutputMetadataValidationTest.kt
  </files>
  <action>
    Create a new test file at the path above in `riven.core.models.workflow.node.config` package.

    This test does NOT need Spring context or the registry -- it directly tests the relationship between companion object outputMetadata declarations and NodeOutput.toMap() results. This keeps tests fast (no Spring boot) and self-contained.

    **Test structure (use JUnit 5 @ParameterizedTest with @MethodSource):**

    Define a data class `OutputMetadataTestCase` with:
    - `nodeLabel: String` (display name, e.g., "CREATE_ENTITY")
    - `outputMetadata: WorkflowNodeOutputMetadata?` (from companion object, nullable)
    - `exampleOutput: NodeOutput` (example instance for toMap() testing)

    Create a companion object with `@JvmStatic` method `nodeOutputTestCases()` returning `List<Arguments>` (or `Stream<Arguments>`) that enumerates ALL known node types with outputMetadata and example outputs:
    - CREATE_ENTITY: `WorkflowCreateEntityActionConfig.outputMetadata` + `CreateEntityOutput(entityId=UUID.randomUUID(), entityTypeId=UUID.randomUUID(), payload=mapOf(UUID.randomUUID() to "test"))`
    - UPDATE_ENTITY: null outputMetadata (not yet declared) + `UpdateEntityOutput(entityId=UUID.randomUUID(), updated=true, payload=mapOf(UUID.randomUUID() to "test"))`
    - DELETE_ENTITY: null outputMetadata + `DeleteEntityOutput(entityId=UUID.randomUUID(), deleted=true, impactedEntities=3)`
    - QUERY_ENTITY: null outputMetadata + `QueryEntityOutput(entities=listOf(mapOf("id" to "1")), totalCount=1, hasMore=false)`
    - HTTP_REQUEST: null outputMetadata + `HttpResponseOutput(statusCode=200, headers=mapOf("Content-Type" to "application/json"), body="{}", url="https://example.com", method="GET")`
    - CONDITION: null outputMetadata + `ConditionOutput(result=true, evaluatedExpression="x > 5")`

    Access companion outputMetadata directly (e.g., `WorkflowCreateEntityActionConfig.outputMetadata`) rather than via registry reflection -- tests should verify the declaration itself, not the reflection mechanism.

    **Test 1: `outputMetadata keys exist in toMap`** (@ParameterizedTest)
    - Skip (return early with log message) if outputMetadata is null -- per user decision, nodes without metadata are expected during rollout
    - For each field in outputMetadata.fields, assert that field.key exists in exampleOutput.toMap().keys
    - Per user decision: toMap() keys must be a SUPERSET of outputMetadata keys (extra keys allowed, every declared key must exist)
    - Error message should include the node label and missing key

    **Test 2: `outputMetadata types match toMap value types`** (@ParameterizedTest)
    - Skip if outputMetadata is null
    - For each field in outputMetadata.fields, get the value from exampleOutput.toMap()[field.key]
    - Validate OutputFieldType matches actual Kotlin type:
      - UUID -> value is `java.util.UUID`
      - STRING -> value is `String`
      - BOOLEAN -> value is `Boolean`
      - NUMBER -> value is `Number` (Int, Long, Double, etc.)
      - MAP -> value is `Map<*, *>`
      - LIST -> value is `List<*>` or `Collection<*>`
      - OBJECT -> value is any non-null non-primitive (skip if null and nullable=true)
      - ENTITY -> value is `Map<*, *>` (entity serializes as map)
      - ENTITY_LIST -> value is `List<*>`
    - If field.nullable is true and value is null, skip type check for that field
    - Error message should include node label, field key, expected type, actual type

    **Test 3: `all node types are accounted for in test cases`** (regular @Test, not parameterized)
    - Hardcode the expected count of NodeOutput sealed interface implementations (currently 7: CreateEntity, UpdateEntity, DeleteEntity, QueryEntity, HttpResponse, Condition, UnsupportedNode)
    - Assert testCases.size matches expected count minus any excluded types (UnsupportedNodeOutput and GenericMapOutput are utility types, exclude them)
    - This prevents adding new NodeOutput subclasses without updating the test

    **Test 4: `nodes without outputMetadata are tracked`** (regular @Test)
    - Filter testCases where outputMetadata is null
    - For each, print a warning: `"WARNING: $nodeLabel missing outputMetadata (Phase 3 TODO)"`
    - Assert that the list is not empty (confirms we're tracking during rollout) OR just log -- do NOT fail on this, it's informational
    - This is the Phase 3 TODO tracker per user decision

    **Naming convention:** Follow existing test file patterns -- backtick method names with descriptive sentences.
  </action>
  <verify>
    Run `./gradlew test --tests "riven.core.models.workflow.node.config.OutputMetadataValidationTest"` -- all tests pass.
    Run `./gradlew test` -- full test suite passes (no regressions).
    Test output shows WARNING lines for nodes without outputMetadata (UPDATE_ENTITY, DELETE_ENTITY, QUERY_ENTITY, HTTP_REQUEST, CONDITION).
  </verify>
  <done>
    Parameterized tests validate that CreateEntityActionConfig.outputMetadata keys ("entityId", "entityTypeId", "payload") all exist in CreateEntityOutput.toMap().
    Parameterized tests validate OutputFieldType matches actual Kotlin runtime types from toMap().
    Nodes without outputMetadata are logged as warnings (5 nodes: UPDATE_ENTITY, DELETE_ENTITY, QUERY_ENTITY, HTTP_REQUEST, CONDITION).
    Node type accounting test prevents silent addition of new NodeOutput types without test coverage.
    Full test suite passes.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew test` passes with zero failures
2. Test file exists at `src/test/kotlin/riven/core/models/workflow/node/config/OutputMetadataValidationTest.kt`
3. Test output contains WARNING lines for 5 nodes missing outputMetadata
4. CreateEntityActionConfig outputMetadata passes both key existence and type matching validation
</verification>

<success_criteria>
- Tests validate keys AND types per user decision (META-12)
- toMap() superset rule enforced: declared keys must exist, extra keys allowed (META-12)
- Phase 3 TODO tracker logs warnings for uncovered nodes (per user decision on validation strategy)
- All parameterized tests pass for CreateEntityActionConfig (the only node with outputMetadata in Phase 1)
- Zero regressions in existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-02-SUMMARY.md`
</output>
