---
phase: 01-foundation-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/kotlin/riven/core/enums/workflow/OutputFieldType.kt
  - src/main/kotlin/riven/core/models/workflow/node/config/WorkflowNodeOutputField.kt
  - src/main/kotlin/riven/core/models/workflow/node/config/WorkflowNodeOutputMetadata.kt
  - src/main/kotlin/riven/core/service/workflow/WorkflowNodeConfigRegistry.kt
  - src/main/kotlin/riven/core/models/response/workflow/NodeTypeSchemaResponse.kt
  - src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowCreateEntityActionConfig.kt
autonomous: true
user_setup: []

must_haves:
  truths:
    - "OutputFieldType enum exists with UUID, STRING, BOOLEAN, NUMBER, MAP, LIST, OBJECT, ENTITY, ENTITY_LIST values"
    - "WorkflowNodeOutputField data class exists with key, label, type, description, nullable, exampleValue, entityTypeId"
    - "WorkflowNodeOutputMetadata wraps an ordered List<WorkflowNodeOutputField>"
    - "WorkflowNodeConfigRegistry extracts outputMetadata from companion objects via reflection at startup"
    - "Node-schemas API endpoint returns outputMetadata as sibling field alongside metadata and configSchema"
    - "Nodes without outputMetadata return outputMetadata: null (field present but null, not omitted)"
    - "CreateEntityActionConfig declares outputMetadata in its companion object as proof of infrastructure"
  artifacts:
    - path: "src/main/kotlin/riven/core/enums/workflow/OutputFieldType.kt"
      provides: "Enum defining all supported output field types"
      contains: "enum class OutputFieldType"
    - path: "src/main/kotlin/riven/core/models/workflow/node/config/WorkflowNodeOutputField.kt"
      provides: "Data class for individual output field definition"
      contains: "data class WorkflowNodeOutputField"
    - path: "src/main/kotlin/riven/core/models/workflow/node/config/WorkflowNodeOutputMetadata.kt"
      provides: "Wrapper data class for output metadata field list"
      contains: "data class WorkflowNodeOutputMetadata"
    - path: "src/main/kotlin/riven/core/service/workflow/WorkflowNodeConfigRegistry.kt"
      provides: "Registry with outputMetadata extraction via reflection"
      contains: "outputMetadata"
    - path: "src/main/kotlin/riven/core/models/response/workflow/NodeTypeSchemaResponse.kt"
      provides: "API response model with outputMetadata field"
      contains: "outputMetadata"
  key_links:
    - from: "WorkflowNodeConfigRegistry.registerNode()"
      to: "companion.outputMetadata"
      via: "Kotlin reflection members.find"
      pattern: 'members\.find.*outputMetadata'
    - from: "NodeSchemaEntry"
      to: "WorkflowNodeOutputMetadata"
      via: "outputMetadata property"
      pattern: "val outputMetadata.*WorkflowNodeOutputMetadata"
    - from: "WorkflowNodeMetadata (API response)"
      to: "WorkflowNodeOutputMetadata"
      via: "outputMetadata nullable field"
      pattern: "val outputMetadata.*WorkflowNodeOutputMetadata\\?"
    - from: "WorkflowCreateEntityActionConfig.companion"
      to: "WorkflowNodeOutputMetadata"
      via: "companion object val"
      pattern: "val outputMetadata = WorkflowNodeOutputMetadata"
---

<objective>
Create the output metadata data model (enum, data classes), extend the registry to extract outputMetadata via reflection, and wire it through to the API response -- with CreateEntityActionConfig as the proof-of-concept node.

Purpose: Establishes the complete infrastructure pipeline from node companion object declaration through registry extraction to API exposure. One node (CreateEntity) proves the pipeline works end-to-end.

Output: Three new Kotlin files (enum + 2 data classes), modifications to registry and API response model, outputMetadata declared on CreateEntityActionConfig.
</objective>

<execution_context>
@/home/jared/.claude/get-shit-done/workflows/execute-plan.md
@/home/jared/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-infrastructure/01-CONTEXT.md
@.planning/phases/01-foundation-infrastructure/01-RESEARCH.md

@src/main/kotlin/riven/core/enums/workflow/WorkflowNodeConfigFieldType.kt
@src/main/kotlin/riven/core/models/workflow/node/config/WorkflowNodeConfigField.kt
@src/main/kotlin/riven/core/models/workflow/node/config/WorkflowNodeTypeMetadata.kt
@src/main/kotlin/riven/core/service/workflow/WorkflowNodeConfigRegistry.kt
@src/main/kotlin/riven/core/models/response/workflow/NodeTypeSchemaResponse.kt
@src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowCreateEntityActionConfig.kt
@src/main/kotlin/riven/core/models/workflow/engine/state/NodeOutput.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OutputFieldType enum and output metadata data classes</name>
  <files>
    src/main/kotlin/riven/core/enums/workflow/OutputFieldType.kt
    src/main/kotlin/riven/core/models/workflow/node/config/WorkflowNodeOutputField.kt
    src/main/kotlin/riven/core/models/workflow/node/config/WorkflowNodeOutputMetadata.kt
  </files>
  <action>
    Create three new Kotlin files following existing codebase patterns:

    1. `OutputFieldType.kt` in `riven.core.enums.workflow` package:
       - Enum class with values: UUID, STRING, BOOLEAN, NUMBER, MAP, LIST, OBJECT, ENTITY, ENTITY_LIST
       - Follow the same style as `WorkflowNodeConfigFieldType.kt` (SCREAMING_SNAKE_CASE, no annotations)
       - Jackson serializes enum names as-is by default (no `@JsonValue` needed)

    2. `WorkflowNodeOutputField.kt` in `riven.core.models.workflow.node.config` package:
       - Data class with these properties (in this exact order):
         - `key: String` (required, no default)
         - `label: String` (required, no default -- per user decision: label is required on every field)
         - `type: OutputFieldType` (required, no default)
         - `description: String? = null` (nullable = optional; per user decision: only provide when field name isn't self-explanatory)
         - `nullable: Boolean = false` (non-nullable with default; per user decision: defaults to false)
         - `exampleValue: Any? = null` (nullable = optional; per user decision: include on ALL field types)
         - `entityTypeId: UUID? = null` (nullable; only for ENTITY/ENTITY_LIST types; null means "dynamic -- resolve from node config")
       - Import `java.util.UUID` and `riven.core.enums.workflow.OutputFieldType`
       - Follow `WorkflowNodeConfigField.kt` style -- no Swagger annotations needed on this data class (it's internal model, not request/response)

    3. `WorkflowNodeOutputMetadata.kt` in `riven.core.models.workflow.node.config` package:
       - Data class with single property: `fields: List<WorkflowNodeOutputField>`
       - Per user decision: ordered List (not Set or Map) -- declaration order is display order for frontend
       - Import the output field class
  </action>
  <verify>
    All three files compile: run `./gradlew compileKotlin` from project root. No compilation errors.
  </verify>
  <done>
    OutputFieldType enum has 9 values (UUID, STRING, BOOLEAN, NUMBER, MAP, LIST, OBJECT, ENTITY, ENTITY_LIST).
    WorkflowNodeOutputField has 7 properties with correct types and defaults.
    WorkflowNodeOutputMetadata wraps List of WorkflowNodeOutputField.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend registry extraction and API response, add CreateEntity outputMetadata</name>
  <files>
    src/main/kotlin/riven/core/service/workflow/WorkflowNodeConfigRegistry.kt
    src/main/kotlin/riven/core/models/response/workflow/NodeTypeSchemaResponse.kt
    src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowCreateEntityActionConfig.kt
  </files>
  <action>
    Modify three existing files to wire outputMetadata through the full pipeline:

    1. `WorkflowNodeConfigRegistry.kt`:
       - Add import for `WorkflowNodeOutputMetadata`
       - Add `val outputMetadata: WorkflowNodeOutputMetadata? = null` property to `NodeSchemaEntry` data class (after `metadata` property)
       - Add `val outputMetadata: WorkflowNodeOutputMetadata? = null` property to `WorkflowNodeMetadata` data class (after `schema` property)
       - In `registerNode<T>()` method, AFTER the existing metadata extraction block (after line ~248 `val metadata = metadataProperty.call(companion)...`) and BEFORE the `NodeSchemaEntry(...)` construction:
         - Extract outputMetadata: `val outputMetadataProperty = companion::class.members.find { it.name == "outputMetadata" }`
         - Cast safely: `val outputMetadata = outputMetadataProperty?.call(companion) as? WorkflowNodeOutputMetadata`
         - Do NOT log a warning if null -- outputMetadata is optional during rollout (per user decision)
         - Per user decision: if reflection fails (exception), log warning and continue, don't fail startup. The existing try-catch around registerNode already handles this.
       - Pass `outputMetadata = outputMetadata` to `NodeSchemaEntry(...)` constructor
       - In `getAllNodes()`, pass `outputMetadata = it.outputMetadata` to `WorkflowNodeMetadata(...)` constructor
       - Per user decision: nodes without outputMetadata will have `outputMetadata: null` in the response (field present but null, not omitted). This happens naturally since `WorkflowNodeOutputMetadata? = null` serializes as `null` with Jackson.

    2. `NodeTypeSchemaResponse.kt`:
       - Add import for `WorkflowNodeOutputMetadata`
       - Add property after `configSchema`:
         ```
         @Schema(description = "Output field definitions describing the shape of this node's execution output")
         val outputMetadata: WorkflowNodeOutputMetadata? = null
         ```
       - This ensures the Swagger docs also reflect the new field

    3. `WorkflowCreateEntityActionConfig.kt`:
       - Add imports for `OutputFieldType`, `WorkflowNodeOutputField`, `WorkflowNodeOutputMetadata`
       - Add `val outputMetadata` to the companion object (after `configSchema`):
         - Field 1: key="entityId", label="Entity ID", type=OutputFieldType.UUID, exampleValue="550e8400-e29b-41d4-a716-446655440000"
         - Field 2: key="entityTypeId", label="Entity Type ID", type=OutputFieldType.UUID, exampleValue="660e8400-e29b-41d4-a716-446655440001"
         - Field 3: key="payload", label="Entity Payload", type=OutputFieldType.MAP, description="Entity attributes as UUID-keyed map", exampleValue=mapOf("770e8400-e29b-41d4-a716-446655440002" to "Example Value")
       - Use native Kotlin types for exampleValue (strings for UUIDs, mapOf() for maps) -- per Claude's discretion on serialization format
       - Entity type is dynamic for CreateEntity (entityTypeId comes from config) so entityTypeId property on the fields is null (omitted, defaults to null)
       - Match the keys exactly to CreateEntityOutput.toMap() keys: "entityId", "entityTypeId", "payload"
  </action>
  <verify>
    Run `./gradlew compileKotlin` -- no compilation errors.
    Run `./gradlew test` -- all existing tests still pass (no regressions).
    Visually inspect that WorkflowNodeConfigRegistry.getAllNodes() would include outputMetadata in its return type.
  </verify>
  <done>
    NodeSchemaEntry and WorkflowNodeMetadata include nullable outputMetadata property.
    registerNode() extracts outputMetadata from companion objects via reflection.
    getAllNodes() passes outputMetadata through to API response model.
    NodeTypeSchemaResponse includes outputMetadata for Swagger documentation.
    WorkflowCreateEntityActionConfig companion declares outputMetadata with 3 fields matching CreateEntityOutput.toMap() keys.
    All existing tests pass without modification.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew compileKotlin` passes with zero errors
2. `./gradlew test` passes with zero failures (no regressions)
3. New files exist at expected paths:
   - `src/main/kotlin/riven/core/enums/workflow/OutputFieldType.kt`
   - `src/main/kotlin/riven/core/models/workflow/node/config/WorkflowNodeOutputField.kt`
   - `src/main/kotlin/riven/core/models/workflow/node/config/WorkflowNodeOutputMetadata.kt`
4. Grep confirms: `outputMetadata` appears in NodeSchemaEntry, WorkflowNodeMetadata, registerNode(), getAllNodes(), NodeTypeSchemaResponse, and WorkflowCreateEntityActionConfig companion
</verification>

<success_criteria>
- OutputFieldType enum defines 9 values including ENTITY and ENTITY_LIST (META-02)
- WorkflowNodeOutputField data class has all 7 properties with correct defaults (META-01)
- WorkflowNodeOutputMetadata wraps ordered field list (META-03)
- Registry extracts outputMetadata via reflection, caches at startup, returns null for missing (META-04)
- API response includes outputMetadata as nullable sibling of metadata and configSchema (META-05)
- CreateEntityActionConfig proves the full pipeline works (companion -> registry -> API)
- Zero test regressions
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-01-SUMMARY.md`
</output>
