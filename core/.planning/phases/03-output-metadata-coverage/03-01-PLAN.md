---
phase: 03-output-metadata-coverage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowUpdateEntityActionConfig.kt
  - src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowDeleteEntityActionConfig.kt
  - src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowHttpRequestActionConfig.kt
  - src/main/kotlin/riven/core/models/workflow/node/config/controls/WorkflowConditionControlConfig.kt
  - src/test/kotlin/riven/core/models/workflow/node/config/OutputMetadataValidationTest.kt
autonomous: true

must_haves:
  truths:
    - "UpdateEntityActionConfig companion declares outputMetadata with keys entityId, updated, payload"
    - "DeleteEntityActionConfig companion declares outputMetadata with keys entityId, deleted, impactedEntities"
    - "HttpRequestActionConfig companion declares outputMetadata with keys statusCode, headers, body, url, method, success"
    - "ConditionControlConfig companion declares outputMetadata with keys result, conditionResult, evaluatedExpression"
    - "OutputMetadataValidationTest covers all 7 NodeOutput types with non-null outputMetadata"
    - "All tests pass with zero Phase 3 TODO warnings"
  artifacts:
    - path: "src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowUpdateEntityActionConfig.kt"
      provides: "UpdateEntity outputMetadata declaration"
      contains: "val outputMetadata = WorkflowNodeOutputMetadata"
    - path: "src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowDeleteEntityActionConfig.kt"
      provides: "DeleteEntity outputMetadata declaration"
      contains: "val outputMetadata = WorkflowNodeOutputMetadata"
    - path: "src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowHttpRequestActionConfig.kt"
      provides: "HttpRequest outputMetadata declaration"
      contains: "val outputMetadata = WorkflowNodeOutputMetadata"
    - path: "src/main/kotlin/riven/core/models/workflow/node/config/controls/WorkflowConditionControlConfig.kt"
      provides: "Condition outputMetadata declaration"
      contains: "val outputMetadata = WorkflowNodeOutputMetadata"
    - path: "src/test/kotlin/riven/core/models/workflow/node/config/OutputMetadataValidationTest.kt"
      provides: "Parameterized validation for all 7 node types"
      contains: "expectedNodeOutputTypes = 7"
  key_links:
    - from: "WorkflowUpdateEntityActionConfig.outputMetadata"
      to: "UpdateEntityOutput.toMap()"
      via: "key names match exactly"
      pattern: "entityId.*updated.*payload"
    - from: "WorkflowDeleteEntityActionConfig.outputMetadata"
      to: "DeleteEntityOutput.toMap()"
      via: "key names match exactly"
      pattern: "entityId.*deleted.*impactedEntities"
    - from: "WorkflowHttpRequestActionConfig.outputMetadata"
      to: "HttpResponseOutput.toMap()"
      via: "key names match exactly"
      pattern: "statusCode.*headers.*body.*url.*method.*success"
    - from: "WorkflowConditionControlConfig.outputMetadata"
      to: "ConditionOutput.toMap()"
      via: "key names match exactly"
      pattern: "result.*conditionResult.*evaluatedExpression"
---

<objective>
Add outputMetadata declarations to all remaining workflow node types and update the validation test suite to achieve complete coverage.

Purpose: Complete the output metadata rollout so every node type declares its output shape for frontend previews and downstream node wiring. This is the final phase delivering on the project's core value.

Output: 4 config files with outputMetadata companion properties + updated parameterized test validating all 7 node types.
</objective>

<execution_context>
@/home/jared/.claude/get-shit-done/workflows/execute-plan.md
@/home/jared/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-output-metadata-coverage/03-RESEARCH.md

# Source of truth for toMap() keys per NodeOutput type
@src/main/kotlin/riven/core/models/workflow/engine/state/NodeOutput.kt

# Proof-of-concept pattern to follow exactly
@src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowCreateEntityActionConfig.kt

# Files to modify
@src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowUpdateEntityActionConfig.kt
@src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowDeleteEntityActionConfig.kt
@src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowHttpRequestActionConfig.kt
@src/main/kotlin/riven/core/models/workflow/node/config/controls/WorkflowConditionControlConfig.kt
@src/test/kotlin/riven/core/models/workflow/node/config/OutputMetadataValidationTest.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add outputMetadata declarations to 4 node config companion objects</name>
  <files>
    src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowUpdateEntityActionConfig.kt
    src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowDeleteEntityActionConfig.kt
    src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowHttpRequestActionConfig.kt
    src/main/kotlin/riven/core/models/workflow/node/config/controls/WorkflowConditionControlConfig.kt
  </files>
  <action>
Add a `val outputMetadata = WorkflowNodeOutputMetadata(...)` property to each companion object, following the exact pattern from WorkflowCreateEntityActionConfig (Phase 1 proof-of-concept). Add necessary imports: `riven.core.enums.workflow.OutputFieldType`, `riven.core.models.workflow.node.config.WorkflowNodeOutputField`, `riven.core.models.workflow.node.config.WorkflowNodeOutputMetadata`.

For each node, cross-reference the corresponding NodeOutput.toMap() in NodeOutput.kt to get exact key names and types:

**WorkflowUpdateEntityActionConfig** — mirrors UpdateEntityOutput.toMap():
- `entityId` (UUID): UUID of updated entity
- `updated` (BOOLEAN): Whether update succeeded
- `payload` (MAP): Entity attributes after update, description "Entity attributes as UUID-keyed map"

**WorkflowDeleteEntityActionConfig** — mirrors DeleteEntityOutput.toMap():
- `entityId` (UUID): UUID of deleted entity
- `deleted` (BOOLEAN): Whether deletion succeeded
- `impactedEntities` (NUMBER): Count of cascade-affected entities

**WorkflowHttpRequestActionConfig** — mirrors HttpResponseOutput.toMap():
- `statusCode` (NUMBER): HTTP status code
- `headers` (MAP): Response headers, description "Response headers as key-value map"
- `body` (STRING, nullable=true): Response body (nullable per HttpResponseOutput constructor)
- `url` (STRING): Requested URL
- `method` (STRING): HTTP method used
- `success` (BOOLEAN): Whether status code is 2xx (this IS in toMap() so must be declared)

**WorkflowConditionControlConfig** — mirrors ConditionOutput.toMap():
- `result` (BOOLEAN): Boolean result of condition evaluation
- `conditionResult` (BOOLEAN): Backward-compatible alias for result
- `evaluatedExpression` (STRING): The expression that was evaluated

Use the same example value style as CreateEntityActionConfig: UUID strings for UUID fields, native Kotlin types for collections.
  </action>
  <verify>
Project compiles: `./gradlew compileKotlin` succeeds. Spot-check each file has `val outputMetadata = WorkflowNodeOutputMetadata(` in the companion object.
  </verify>
  <done>
All four config companion objects declare outputMetadata with keys exactly matching their NodeOutput.toMap() keys and correct OutputFieldType mappings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update OutputMetadataValidationTest for full coverage</name>
  <files>
    src/test/kotlin/riven/core/models/workflow/node/config/OutputMetadataValidationTest.kt
  </files>
  <action>
Update the parameterized test suite to validate all 7 production NodeOutput types with non-null outputMetadata:

1. **Add imports** for the 5 newly-referenced config classes:
   - `riven.core.models.workflow.node.config.actions.WorkflowUpdateEntityActionConfig`
   - `riven.core.models.workflow.node.config.actions.WorkflowDeleteEntityActionConfig`
   - `riven.core.models.workflow.node.config.actions.WorkflowHttpRequestActionConfig`
   - `riven.core.models.workflow.node.config.actions.WorkflowQueryEntityActionConfig`
   - `riven.core.models.workflow.node.config.actions.WorkflowBulkUpdateEntityActionConfig`
   - `riven.core.models.workflow.node.config.controls.WorkflowConditionControlConfig`
   - `riven.core.models.workflow.engine.state.BulkUpdateEntityOutput`

2. **Update existing test cases** — change `outputMetadata = null` to actual companion references:
   - UPDATE_ENTITY: `outputMetadata = WorkflowUpdateEntityActionConfig.outputMetadata`
   - DELETE_ENTITY: `outputMetadata = WorkflowDeleteEntityActionConfig.outputMetadata`
   - QUERY_ENTITY: `outputMetadata = WorkflowQueryEntityActionConfig.outputMetadata`
   - HTTP_REQUEST: `outputMetadata = WorkflowHttpRequestActionConfig.outputMetadata`
   - CONDITION: `outputMetadata = WorkflowConditionControlConfig.outputMetadata`

3. **Add BULK_UPDATE_ENTITY test case** after the QUERY_ENTITY case:
   ```kotlin
   Arguments.of(
       OutputMetadataTestCase(
           nodeLabel = "BULK_UPDATE_ENTITY",
           outputMetadata = WorkflowBulkUpdateEntityActionConfig.outputMetadata,
           exampleOutput = BulkUpdateEntityOutput(
               entitiesUpdated = 10,
               entitiesFailed = 2,
               failedEntityDetails = listOf(mapOf("entityId" to "abc", "error" to "fail")),
               totalProcessed = 12
           )
       )
   )
   ```

4. **Update expected count** from `val expectedNodeOutputTypes = 6` to `val expectedNodeOutputTypes = 7`.

5. **Remove Phase 3 TODO comments** — Update comment on the tracking test from "Phase 3 rollout" language to "all nodes should have outputMetadata". Consider updating the test `nodes without outputMetadata are tracked for Phase 3` to assert that nodesWithoutMetadata is empty (change from tracker to enforcer):
   ```kotlin
   assertEquals(0, nodesWithoutMetadata.size,
       "All nodes should declare outputMetadata. Missing: ${nodesWithoutMetadata.map { it.nodeLabel }}")
   ```
  </action>
  <verify>
Run `./gradlew test --tests "riven.core.models.workflow.node.config.OutputMetadataValidationTest"` — all tests pass, no Phase 3 TODO warnings in output. Verify the tracking test now enforces zero missing metadata instead of just logging warnings.
  </verify>
  <done>
OutputMetadataValidationTest covers all 7 NodeOutput types, all test cases reference non-null outputMetadata, expected count is 7, and the Phase 3 tracker test enforces complete coverage.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew compileKotlin` — project compiles with all new outputMetadata declarations
2. `./gradlew test --tests "riven.core.models.workflow.node.config.OutputMetadataValidationTest"` — all parameterized tests pass
3. Test output contains no "WARNING: X missing outputMetadata" messages
4. `./gradlew test` — full test suite passes (no regressions)
</verification>

<success_criteria>
- All 7 production node types (CreateEntity, UpdateEntity, DeleteEntity, QueryEntity, BulkUpdateEntity, HttpRequest, Condition) declare outputMetadata in their companion objects
- OutputMetadataValidationTest validates all 7 types with non-null metadata
- Declared outputMetadata keys match NodeOutput.toMap() keys exactly (validated by parameterized test)
- Declared OutputFieldType values match actual Kotlin runtime types (validated by parameterized test)
- Zero Phase 3 TODO warnings remain
- Full test suite passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-output-metadata-coverage/03-01-SUMMARY.md`
</output>
