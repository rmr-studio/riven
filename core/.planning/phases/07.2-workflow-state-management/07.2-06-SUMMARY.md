# Phase 7.2 Plan 06: Coordination Service Integration Summary

**Completed:** 2026-02-01
**Duration:** 9 minutes

## One-liner

Integrated WorkflowDataStore into coordination service, unified node signatures to use dataStore, coordinator now writes StepOutput after execution, removed dataRegistry from WorkflowState.

## What Was Built

### Task 1: Update node config signatures to use WorkflowDataStore

Updated all node configurations to receive `WorkflowDataStore` instead of `WorkflowExecutionContext`:

- **WorkflowNodeConfig.kt** - Changed execute() signature from `context: WorkflowExecutionContext` to `dataStore: WorkflowDataStore`
- **WorkflowNode.kt** - Updated delegation to pass dataStore
- **Action configs** (Create, Update, Delete, Query, Http) - Use `dataStore.metadata.workspaceId` instead of `context.workspaceId`
- **Control configs** (Condition) - Use `dataStore.metadata.workspaceId`
- **Function and Trigger configs** - Updated signatures (triggers throw UnsupportedOperationException as expected)

### Task 2: Update WorkflowCoordinationService to use WorkflowDataStore

Major refactor of the coordination service:

- **Create dataStore at workflow start** - `WorkflowMetadata` includes executionId, workspaceId, workflowDefinitionId, version, startedAt
- **Share dataStore across all nodes** - Single dataStore instance passed to all node executions
- **Coordinator writes StepOutput** - After node.execute() returns NodeOutput, coordinator creates StepOutput with nodeId, nodeName, status, output, executedAt, durationMs
- **Removed executeAction helper** - Coordinator now writes directly to dataStore
- **Removed WorkflowExecutionContext usage** - No more context creation, all data flows through dataStore

### Task 3: Remove dataRegistry from WorkflowState and clean up

Pure orchestration state in WorkflowState:

- **Removed dataRegistry field** - WorkflowState is now orchestration-only (phase, activeNodes, completedNodes, failedNodes)
- **Removed getNodeOutput()** - No longer needed, data is in WorkflowDataStore
- **Updated NodeCompleted event** - No longer carries output, just nodeId
- **Updated StateTransition** - No longer writes to dataRegistry in handleNodeCompleted
- **Updated WorkflowGraphCoordinationService** - Initialize state without dataRegistry
- **Updated WorkflowOrchestrationService** - Set output to null in result (outputs in DB records)
- **Updated integration tests** - Verify completedNodes instead of dataRegistry contents

## Architectural Decisions

| Decision | Rationale |
|----------|-----------|
| Coordinator writes StepOutput | Nodes return typed NodeOutput, coordinator wraps with execution metadata (timing, status) |
| WorkflowState is orchestration-only | Clean separation: orchestration (which nodes are done) vs data (what they produced) |
| Share dataStore across nodes | Template resolution needs access to prior step outputs |
| Outputs in DB, not workflow result | WorkflowExecutionNodeEntity stores outputs, no need to pass through Temporal |

## Key Files Modified

### Node Configs (signatures updated)
- `src/main/kotlin/riven/core/models/workflow/node/config/WorkflowNodeConfig.kt`
- `src/main/kotlin/riven/core/models/workflow/node/WorkflowNode.kt`
- `src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowCreateEntityActionConfig.kt`
- `src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowUpdateEntityActionConfig.kt`
- `src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowDeleteEntityActionConfig.kt`
- `src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowQueryEntityActionConfig.kt`
- `src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowHttpRequestActionConfig.kt`
- `src/main/kotlin/riven/core/models/workflow/node/config/controls/WorkflowConditionControlConfig.kt`
- `src/main/kotlin/riven/core/models/workflow/node/config/WorkflowFunctionConfig.kt`
- `src/main/kotlin/riven/core/models/workflow/node/config/trigger/*.kt` (4 files)

### Coordination (major refactor)
- `src/main/kotlin/riven/core/service/workflow/engine/coordinator/WorkflowCoordinationService.kt`

### State Management (cleanup)
- `src/main/kotlin/riven/core/models/workflow/engine/coordinator/WorkflowState.kt`
- `src/main/kotlin/riven/core/models/workflow/engine/coordinator/StateTransition.kt`
- `src/main/kotlin/riven/core/service/workflow/engine/coordinator/WorkflowGraphCoordinationService.kt`
- `src/main/kotlin/riven/core/service/workflow/engine/WorkflowOrchestrationService.kt`

### Tests (updated assertions)
- `src/test/kotlin/riven/core/service/workflow/WorkflowGraphCoordinationServiceIntegrationTest.kt`
- `src/test/kotlin/riven/core/service/workflow/WorkflowExecutionIntegrationTest.kt`
- `src/test/kotlin/riven/core/service/workflow/WorkflowExecutionEndToEndIntegrationTest.kt`

## Verification Results

- `./gradlew compileKotlin` - Passes
- `./gradlew test` - All tests pass

## Data Flow (After Integration)

```
1. executeWorkflowWithCoordinator() creates WorkflowDataStore(metadata)
2. nodeExecutor callback receives shared dataStore
3. For each node:
   a. workflowNodeInputResolverService.resolveAll(configMap, dataStore) - uses prior step outputs
   b. node.execute(dataStore, resolvedInputs, services) - returns NodeOutput
   c. Coordinator creates StepOutput and calls dataStore.setStepOutput(nodeName, stepOutput)
   d. WorkflowExecutionNodeEntity updated with output for DB persistence
4. WorkflowState tracks orchestration only (completedNodes, activeNodes, phase)
```

## Deviations from Plan

None - plan executed exactly as written.

## Next Phase Readiness

Phase 7.2 plan 07 can proceed with deprecation of old classes (WorkflowExecutionContext, NodeExecutionData).
