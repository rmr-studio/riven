---
phase: 07.2-workflow-state-management
plan: 05
type: execute
wave: 2
depends_on: ["07.2-02"]
files_modified:
  - src/main/kotlin/riven/core/models/workflow/node/config/WorkflowNodeConfig.kt
  - src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowCreateEntityActionConfig.kt
  - src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowUpdateEntityActionConfig.kt
  - src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowDeleteEntityActionConfig.kt
  - src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowQueryEntityActionConfig.kt
  - src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowHttpRequestActionConfig.kt
  - src/main/kotlin/riven/core/models/workflow/node/config/controls/WorkflowConditionControlConfig.kt
  - src/main/kotlin/riven/core/models/workflow/node/WorkflowNode.kt
  - src/test/kotlin/riven/core/models/workflow/node/config/NodeConfigExecuteTest.kt
autonomous: true

must_haves:
  truths:
    - "WorkflowNodeConfig.execute() returns NodeOutput"
    - "WorkflowNode.execute() returns NodeOutput"
    - "All 6 node config implementations return typed NodeOutput"
    - "Return types match current output structure"
  artifacts:
    - path: "src/main/kotlin/riven/core/models/workflow/node/config/WorkflowNodeConfig.kt"
      provides: "Updated execute() signature"
      exports: ["WorkflowNodeConfig"]
  key_links:
    - from: "WorkflowNodeConfig.execute()"
      to: "NodeOutput"
      via: "return type"
      pattern: "fun execute\\(.*\\): NodeOutput"
---

<objective>
Update all node config execute() methods to return typed NodeOutput instead of Map.

Purpose: Type-safe node outputs that work with new template resolution
Output: All node configs return specific NodeOutput subclasses
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.2-workflow-state-management/07.2-CONTEXT.md
@.planning/phases/07.2-workflow-state-management/07.2-RESEARCH.md

# Current node config implementations
@src/main/kotlin/riven/core/models/workflow/node/config/WorkflowNodeConfig.kt
@src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowCreateEntityActionConfig.kt
@src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowHttpRequestActionConfig.kt
@src/main/kotlin/riven/core/models/workflow/node/config/controls/WorkflowConditionControlConfig.kt
@src/main/kotlin/riven/core/models/workflow/node/WorkflowNode.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update WorkflowNodeConfig interface signature</name>
  <files>
    src/main/kotlin/riven/core/models/workflow/node/config/WorkflowNodeConfig.kt
    src/main/kotlin/riven/core/models/workflow/node/WorkflowNode.kt
  </files>
  <action>
**Update WorkflowNodeConfig.kt:**

Change the execute() return type from `JsonObject` (which is `Map<String, Any?>`) to `NodeOutput`:

```kotlin
import riven.core.models.workflow.engine.datastore.NodeOutput

sealed interface WorkflowNodeConfig {
    // ... existing properties ...

    /**
     * Execute this node with given context and resolved inputs.
     *
     * @param context Workflow execution context with data registry
     * @param inputs Resolved inputs (templates already converted to values)
     * @param services Service provider for on-demand access to Spring services
     * @return Typed NodeOutput representing execution result
     * @throws Exception on execution failure
     */
    fun execute(
        context: WorkflowExecutionContext,  // Will change to WorkflowDataStore in plan 06
        inputs: JsonObject,
        services: NodeServiceProvider
    ): NodeOutput  // Changed from JsonObject

    // ... rest unchanged ...
}
```

**Update WorkflowNode.kt:**

Update the execute() method to return NodeOutput:

```kotlin
fun execute(
    context: WorkflowExecutionContext,
    inputs: JsonObject,
    services: NodeServiceProvider
): NodeOutput {
    return config.execute(context, inputs, services)
}
```

Note: We keep WorkflowExecutionContext for now; plan 06 will change to WorkflowDataStore.
  </action>
  <verify>`./gradlew compileKotlin` fails with expected errors in node config implementations (they still return Map)</verify>
  <done>Interface signature updated, compilation errors expected in implementations</done>
</task>

<task type="auto">
  <name>Task 2: Update all action config execute() methods</name>
  <files>
    src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowCreateEntityActionConfig.kt
    src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowUpdateEntityActionConfig.kt
    src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowDeleteEntityActionConfig.kt
    src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowQueryEntityActionConfig.kt
    src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowHttpRequestActionConfig.kt
  </files>
  <action>
Update each action config to return typed NodeOutput:

**WorkflowCreateEntityActionConfig.kt:**
```kotlin
import riven.core.models.workflow.engine.datastore.CreateEntityOutput
import riven.core.models.workflow.engine.datastore.NodeOutput

override fun execute(
    context: WorkflowExecutionContext,
    inputs: JsonObject,
    services: NodeServiceProvider
): NodeOutput {
    // ... existing implementation up to result ...

    return CreateEntityOutput(
        entityId = result.entity?.id ?: throw IllegalStateException("Entity creation failed"),
        entityTypeId = result.entity?.typeId ?: throw IllegalStateException("Entity type missing"),
        payload = result.entity?.payload ?: emptyMap()
    )
}
```

**WorkflowUpdateEntityActionConfig.kt:**
```kotlin
import riven.core.models.workflow.engine.datastore.UpdateEntityOutput
import riven.core.models.workflow.engine.datastore.NodeOutput

override fun execute(...): NodeOutput {
    // ... existing implementation ...

    return UpdateEntityOutput(
        entityId = resolvedEntityId,
        updated = true,  // If we got here, update succeeded
        payload = result.entity?.payload ?: emptyMap()
    )
}
```

**WorkflowDeleteEntityActionConfig.kt:**
```kotlin
import riven.core.models.workflow.engine.datastore.DeleteEntityOutput
import riven.core.models.workflow.engine.datastore.NodeOutput

override fun execute(...): NodeOutput {
    // ... existing implementation ...

    return DeleteEntityOutput(
        entityId = resolvedEntityId,
        deleted = true,
        impactedEntities = 0  // TODO: Get actual count from delete result
    )
}
```

**WorkflowQueryEntityActionConfig.kt:**
```kotlin
import riven.core.models.workflow.engine.datastore.QueryEntityOutput
import riven.core.models.workflow.engine.datastore.NodeOutput

override fun execute(...): NodeOutput {
    // ... existing implementation ...

    return QueryEntityOutput(
        entities = entities.map { it.payload },  // Convert to payload maps
        totalCount = entities.size,  // TODO: Get actual total from paginated query
        hasMore = false  // TODO: Get from pagination info
    )
}
```

**WorkflowHttpRequestActionConfig.kt:**
```kotlin
import riven.core.models.workflow.engine.datastore.HttpResponseOutput
import riven.core.models.workflow.engine.datastore.NodeOutput

override fun execute(...): NodeOutput {
    // ... existing implementation up to response ...

    return HttpResponseOutput(
        statusCode = response.statusCode.value(),
        headers = response.headers.toSingleValueMap(),
        body = response.body,
        url = resolvedUrl,
        method = resolvedMethod
    )
}
```
  </action>
  <verify>`./gradlew compileKotlin` still has error in ConditionControlConfig</verify>
  <done>All 5 action configs return typed NodeOutput</done>
</task>

<task type="auto">
  <name>Task 3: Update control config and verify compilation</name>
  <files>
    src/main/kotlin/riven/core/models/workflow/node/config/controls/WorkflowConditionControlConfig.kt
    src/test/kotlin/riven/core/models/workflow/node/config/NodeConfigExecuteTest.kt
  </files>
  <action>
**Update WorkflowConditionControlConfig.kt:**
```kotlin
import riven.core.models.workflow.engine.datastore.ConditionOutput
import riven.core.models.workflow.engine.datastore.NodeOutput

override fun execute(
    context: WorkflowExecutionContext,
    inputs: Map<String, Any?>,
    services: NodeServiceProvider
): NodeOutput {
    // ... existing implementation up to result ...

    return ConditionOutput(
        result = result,
        evaluatedExpression = resolvedExpression
    )
}
```

**Create NodeConfigExecuteTest.kt** (or update existing tests):

Test that each config returns correct NodeOutput type:

```kotlin
@Test
fun `CreateEntityActionConfig returns CreateEntityOutput`() {
    val config = WorkflowCreateEntityActionConfig(
        entityTypeId = entityTypeId.toString(),
        payload = emptyMap()
    )

    val result = config.execute(context, inputs, services)

    assertIs<CreateEntityOutput>(result)
    assertNotNull((result as CreateEntityOutput).entityId)
}

@Test
fun `HttpRequestActionConfig returns HttpResponseOutput`() {
    val config = WorkflowHttpRequestActionConfig(
        url = "https://api.example.com",
        method = "GET"
    )

    val result = config.execute(context, inputs, services)

    assertIs<HttpResponseOutput>(result)
    assertEquals(200, (result as HttpResponseOutput).statusCode)
}

@Test
fun `ConditionControlConfig returns ConditionOutput`() {
    val config = WorkflowConditionControlConfig(
        expression = "true"
    )

    val result = config.execute(context, inputs, services)

    assertIs<ConditionOutput>(result)
    assertTrue((result as ConditionOutput).result)
}
```

Note: These tests may require mocking services. Add as integration tests if unit testing is complex.
  </action>
  <verify>`./gradlew compileKotlin` passes with no errors</verify>
  <done>All node configs compile and return typed NodeOutput</done>
</task>

</tasks>

<verification>
- `./gradlew compileKotlin` - No compilation errors
- `./gradlew test` - Existing tests still pass (may need updates)
- Verify each config returns appropriate NodeOutput subclass
- Verify no Map<String, Any?> returns remain in execute() methods
</verification>

<success_criteria>
- WorkflowNodeConfig.execute() returns NodeOutput
- WorkflowNode.execute() returns NodeOutput
- All 6 node configs return specific typed outputs:
  - WorkflowCreateEntityActionConfig -> CreateEntityOutput
  - WorkflowUpdateEntityActionConfig -> UpdateEntityOutput
  - WorkflowDeleteEntityActionConfig -> DeleteEntityOutput
  - WorkflowQueryEntityActionConfig -> QueryEntityOutput
  - WorkflowHttpRequestActionConfig -> HttpResponseOutput
  - WorkflowConditionControlConfig -> ConditionOutput
- Compilation passes with no type errors
</success_criteria>

<output>
After completion, create `.planning/phases/07.2-workflow-state-management/07.2-05-SUMMARY.md`
</output>
