---
phase: 07.2-workflow-state-management
plan: 07
type: execute
wave: 4
depends_on: ["07.2-06"]
files_modified:
  - src/main/kotlin/riven/core/models/workflow/engine/environment/WorkflowExecutionContext.kt
  - src/main/kotlin/riven/core/models/workflow/engine/environment/NodeExecutionData.kt
autonomous: true

must_haves:
  truths:
    - "WorkflowExecutionContext is deleted"
    - "NodeExecutionData is deleted"
    - "No compilation errors after removal"
    - "No remaining references to deleted classes"
  artifacts:
    - path: "src/main/kotlin/riven/core/models/workflow/engine/environment/WorkflowExecutionContext.kt"
      provides: "File deleted"
    - path: "src/main/kotlin/riven/core/models/workflow/engine/environment/NodeExecutionData.kt"
      provides: "File deleted"
  key_links: []
---

<objective>
Remove deprecated WorkflowExecutionContext and NodeExecutionData classes.

Purpose: Complete the unification by removing legacy state classes
Output: Clean codebase with only WorkflowDataStore and related types
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.2-workflow-state-management/07.2-CONTEXT.md
@.planning/phases/07.2-workflow-state-management/07.2-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify no remaining references and delete old classes</name>
  <files>
    src/main/kotlin/riven/core/models/workflow/engine/environment/WorkflowExecutionContext.kt
    src/main/kotlin/riven/core/models/workflow/engine/environment/NodeExecutionData.kt
  </files>
  <action>
**Step 1: Search for remaining references:**

```bash
# Find any remaining imports of WorkflowExecutionContext
grep -r "WorkflowExecutionContext" src/main/kotlin --include="*.kt"
grep -r "WorkflowExecutionContext" src/test/kotlin --include="*.kt"

# Find any remaining imports of NodeExecutionData
grep -r "NodeExecutionData" src/main/kotlin --include="*.kt"
grep -r "NodeExecutionData" src/test/kotlin --include="*.kt"
```

If any references remain, they are bugs from Plan 06 that need fixing first.

**Step 2: Delete the files:**

```bash
rm src/main/kotlin/riven/core/models/workflow/engine/environment/WorkflowExecutionContext.kt
rm src/main/kotlin/riven/core/models/workflow/engine/environment/NodeExecutionData.kt
```

**Step 3: Clean up empty package:**

If `environment` package is now empty, consider:
- Leaving it empty (fine for now)
- Or if `WorkflowNodeContext.kt` still exists, keep the package

**Step 4: Verify build:**

```bash
./gradlew clean build
```

Should compile and all tests should pass.
  </action>
  <verify>`./gradlew clean build` passes with no errors</verify>
  <done>Old state classes deleted, codebase compiles cleanly</done>
</task>

<task type="auto">
  <name>Task 2: Update any remaining test files</name>
  <files>src/test/kotlin/riven/core/**/*.kt</files>
  <action>
Search for and update any test files that may still reference the old classes:

```bash
# Find test files with old references
grep -r "WorkflowExecutionContext\|NodeExecutionData" src/test/kotlin --include="*.kt" -l
```

For each file found:
1. Update to use WorkflowDataStore, StepOutput, NodeOutput types
2. Update test setup to create proper WorkflowMetadata and WorkflowDataStore
3. Ensure tests pass

Common updates needed:
- Replace `WorkflowExecutionContext(...)` with `WorkflowDataStore(WorkflowMetadata(...))`
- Replace `NodeExecutionData(...)` with `StepOutput(...)`
- Replace `context.dataRegistry[name] = data` with `dataStore.setStepOutput(name, stepOutput)`
- Replace `context.dataRegistry[name]` with `dataStore.getStepOutput(name)`

If no test files reference old classes, this task is complete with verification only.
  </action>
  <verify>`./gradlew test` - All tests pass</verify>
  <done>All tests updated and passing, no references to deleted classes</done>
</task>

<task type="auto">
  <name>Task 3: Final verification and documentation</name>
  <files>None (verification only)</files>
  <action>
**Final verification checklist:**

1. **Compilation:** `./gradlew compileKotlin` passes
2. **Tests:** `./gradlew test` all pass
3. **No old references:**
   ```bash
   grep -r "WorkflowExecutionContext" src/ --include="*.kt"
   grep -r "NodeExecutionData" src/ --include="*.kt"
   ```
   Should return empty (only in git history)

4. **New structure verified:**
   - `WorkflowDataStore` exists with all methods
   - `StepOutput` exists with `NodeOutput` typed output
   - `TriggerContext` sealed interface exists
   - `NodeOutput` sealed interface with 6 implementations
   - `WorkflowMetadata` exists
   - `LoopContext` placeholder exists

5. **Template resolution works:**
   - `{{ steps.name.output.field }}` resolves
   - `{{ trigger.* }}` paths ready (when trigger is set)
   - `{{ variables.* }}` paths ready
   - `{{ loops.* }}` paths ready

Add summary comment in WorkflowDataStore documenting the unification:
```kotlin
/**
 * Unified workflow state container.
 *
 * Created in Phase 7.2 to replace:
 * - WorkflowState.dataRegistry (orchestration data)
 * - WorkflowExecutionContext (execution metadata + data)
 *
 * All workflow data flows through this single datastore:
 * - Trigger context: Set once at workflow start
 * - Step outputs: Write-once per node, read by templates
 * - Variables: Last-write-wins for user variables
 * - Loop contexts: Per-loop iteration state
 *
 * Thread-safe via ConcurrentHashMap for parallel node execution.
 */
```
  </action>
  <verify>All verification checks pass, documentation added</verify>
  <done>Phase 7.2 complete - unified workflow state management</done>
</task>

</tasks>

<verification>
- `./gradlew clean build` - Full clean build passes
- `./gradlew test` - All tests pass
- `grep` searches return no results for deleted classes
- New datastore structure is complete and documented
</verification>

<success_criteria>
- WorkflowExecutionContext.kt deleted
- NodeExecutionData.kt deleted
- No compilation errors
- No test failures
- No remaining references to deleted classes
- WorkflowDataStore is the single source of workflow state
</success_criteria>

<output>
After completion, create `.planning/phases/07.2-workflow-state-management/07.2-07-SUMMARY.md`
</output>
