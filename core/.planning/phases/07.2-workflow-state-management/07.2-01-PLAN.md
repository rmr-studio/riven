---
phase: 07.2-workflow-state-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/kotlin/riven/core/models/workflow/engine/datastore/WorkflowDataStore.kt
  - src/main/kotlin/riven/core/models/workflow/engine/datastore/WorkflowMetadata.kt
  - src/main/kotlin/riven/core/models/workflow/engine/datastore/StepOutput.kt
  - src/test/kotlin/riven/core/models/workflow/engine/datastore/WorkflowDataStoreTest.kt
autonomous: true

must_haves:
  truths:
    - "WorkflowDataStore stores step outputs by node name"
    - "Step outputs are write-once (IllegalStateException on duplicate)"
    - "Variables use last-write-wins semantics"
    - "All getters are thread-safe"
  artifacts:
    - path: "src/main/kotlin/riven/core/models/workflow/engine/datastore/WorkflowDataStore.kt"
      provides: "Thread-safe datastore class"
      exports: ["WorkflowDataStore"]
    - path: "src/main/kotlin/riven/core/models/workflow/engine/datastore/StepOutput.kt"
      provides: "Step output data class"
      exports: ["StepOutput"]
    - path: "src/main/kotlin/riven/core/models/workflow/engine/datastore/WorkflowMetadata.kt"
      provides: "Immutable workflow metadata"
      exports: ["WorkflowMetadata"]
  key_links:
    - from: "WorkflowDataStore"
      to: "ConcurrentHashMap"
      via: "internal storage"
      pattern: "ConcurrentHashMap<String, StepOutput>"
---

<objective>
Create WorkflowDataStore class with thread-safe sections for steps, variables, and loop contexts.

Purpose: Unified state container replacing both WorkflowState.dataRegistry and WorkflowExecutionContext
Output: WorkflowDataStore.kt, StepOutput.kt, WorkflowMetadata.kt with unit tests
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.2-workflow-state-management/07.2-CONTEXT.md
@.planning/phases/07.2-workflow-state-management/07.2-RESEARCH.md

# Existing patterns
@src/main/kotlin/riven/core/models/workflow/engine/environment/WorkflowExecutionContext.kt
@src/main/kotlin/riven/core/models/workflow/engine/environment/NodeExecutionData.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WorkflowMetadata and StepOutput data classes</name>
  <files>
    src/main/kotlin/riven/core/models/workflow/engine/datastore/WorkflowMetadata.kt
    src/main/kotlin/riven/core/models/workflow/engine/datastore/StepOutput.kt
  </files>
  <action>
Create new package `riven.core.models.workflow.engine.datastore`.

**WorkflowMetadata.kt:**
- Immutable data class for workflow-level context
- Fields: `executionId: UUID`, `workspaceId: UUID`, `workflowDefinitionId: UUID`, `version: Int`, `startedAt: Instant`
- These are set once at creation and never modified

**StepOutput.kt:**
- Immutable data class replacing NodeExecutionData
- Fields: `nodeId: UUID`, `nodeName: String`, `status: WorkflowStatus`, `output: Any?` (will be typed NodeOutput in plan 02), `executedAt: Instant`, `durationMs: Long`
- Note: `output` is `Any?` temporarily; plan 02 will change it to `NodeOutput`
- Do NOT include error field (errors throw exceptions, not stored in datastore)
  </action>
  <verify>Files compile with `./gradlew compileKotlin`</verify>
  <done>Both data classes exist in datastore package with documented fields</done>
</task>

<task type="auto">
  <name>Task 2: Create WorkflowDataStore class with thread-safe operations</name>
  <files>src/main/kotlin/riven/core/models/workflow/engine/datastore/WorkflowDataStore.kt</files>
  <action>
Create WorkflowDataStore class with:

**Constructor:**
- Single parameter: `metadata: WorkflowMetadata` (immutable after construction)

**Internal storage (all ConcurrentHashMap):**
- `private val steps = ConcurrentHashMap<String, StepOutput>()`
- `private val variables = ConcurrentHashMap<String, Any?>()`
- `private val loops = ConcurrentHashMap<String, LoopContext>()` (LoopContext is placeholder data class for now)

**Trigger storage:**
- `@Volatile private var _trigger: Any? = null` (will be TriggerContext in plan 03)
- Write-once enforcement in setter

**Public API:**

```kotlin
// Metadata access
val metadata: WorkflowMetadata  // Direct access to immutable metadata

// Trigger (write-once)
fun setTrigger(trigger: Any) {
    if (_trigger != null) throw IllegalStateException("Trigger already set")
    _trigger = trigger
}
fun getTrigger(): Any? = _trigger

// Steps (write-once per key)
fun setStepOutput(name: String, output: StepOutput) {
    val existing = steps.putIfAbsent(name, output)
    if (existing != null) {
        throw IllegalStateException("Step output already exists for: $name")
    }
}
fun getStepOutput(name: String): StepOutput? = steps[name]
fun getAllStepOutputs(): Map<String, StepOutput> = steps.toMap()

// Variables (last-write-wins)
fun setVariable(name: String, value: Any?) {
    variables[name] = value
}
fun getVariable(name: String): Any? = variables[name]
fun getAllVariables(): Map<String, Any?> = variables.toMap()

// Loops (mutable per loop)
fun setLoopContext(loopId: String, context: LoopContext) {
    loops[loopId] = context
}
fun getLoopContext(loopId: String): LoopContext? = loops[loopId]
```

**LoopContext placeholder:**
Create as simple data class in same file for now:
```kotlin
data class LoopContext(
    val loopId: String,
    val currentIndex: Int,
    val currentItem: Any?,
    val totalItems: Int
)
```
  </action>
  <verify>`./gradlew compileKotlin` passes</verify>
  <done>WorkflowDataStore class with all thread-safe methods and write-once enforcement</done>
</task>

<task type="auto">
  <name>Task 3: Unit tests for WorkflowDataStore concurrency and write-once semantics</name>
  <files>src/test/kotlin/riven/core/models/workflow/engine/datastore/WorkflowDataStoreTest.kt</files>
  <action>
Create comprehensive unit tests:

**Basic operations:**
- `setStepOutput stores and retrieves step`
- `setStepOutput throws IllegalStateException on duplicate key`
- `setVariable allows overwrite (last-write-wins)`
- `setTrigger stores trigger`
- `setTrigger throws IllegalStateException when already set`
- `getAllStepOutputs returns copy (modifications don't affect datastore)`
- `getAllVariables returns copy (modifications don't affect datastore)`

**Concurrency tests:**
- `concurrent setVariable calls all succeed (last writer wins)`
- `concurrent setStepOutput with different keys all succeed`
- `concurrent setStepOutput with same key - exactly one succeeds, others throw`

Use JUnit 5 with ExecutorService for concurrency tests:
```kotlin
@Test
fun `concurrent setStepOutput with same key - one succeeds, others throw`() {
    val executor = Executors.newFixedThreadPool(10)
    val successCount = AtomicInteger(0)
    val failCount = AtomicInteger(0)
    val latch = CountDownLatch(10)

    repeat(10) { i ->
        executor.submit {
            try {
                dataStore.setStepOutput("node1", createStepOutput(i))
                successCount.incrementAndGet()
            } catch (e: IllegalStateException) {
                failCount.incrementAndGet()
            } finally {
                latch.countDown()
            }
        }
    }

    latch.await()
    assertEquals(1, successCount.get())
    assertEquals(9, failCount.get())
}
```
  </action>
  <verify>`./gradlew test --tests "riven.core.models.workflow.engine.datastore.WorkflowDataStoreTest"` passes</verify>
  <done>All unit tests pass, covering basic operations and concurrency scenarios</done>
</task>

</tasks>

<verification>
- `./gradlew compileKotlin` - No compilation errors
- `./gradlew test --tests "*WorkflowDataStoreTest*"` - All tests pass
- Verify write-once semantics enforced
- Verify thread-safety with concurrent tests
</verification>

<success_criteria>
- WorkflowDataStore class exists with ConcurrentHashMap-backed storage
- StepOutput and WorkflowMetadata data classes exist
- Write-once enforcement works for steps and trigger
- Last-write-wins works for variables
- Unit tests cover all methods and concurrency scenarios
</success_criteria>

<output>
After completion, create `.planning/phases/07.2-workflow-state-management/07.2-01-SUMMARY.md`
</output>
