---
phase: 06.1-execution-queue-management
plan: 01
type: execute
wave: 1
depends_on: [ ]
files_modified:
  - src/main/kotlin/riven/core/configuration/ShedLockConfiguration.kt
  - src/main/kotlin/riven/core/enums/workspace/WorkspaceTier.kt
  - schema.sql
autonomous: true
user_setup: [ ]

must_haves:
  truths:
    - "ShedLock is configured for distributed scheduler locking"
    - "WorkspaceTier enum maps WorkspacePlan to concurrent workflow limits"
    - "shedlock table exists in database schema"
  artifacts:
    - path: "src/main/kotlin/riven/core/configuration/ShedLockConfiguration.kt"
      provides: "Spring configuration for distributed lock provider"
      exports: [ "lockProvider" ]
    - path: "src/main/kotlin/riven/core/enums/workspace/WorkspaceTier.kt"
      provides: "Tier-based concurrency limits"
      exports: [ "WorkspaceTier" ]
  key_links:
    - from: "ShedLockConfiguration.kt"
      to: "DataSource"
      via: "JdbcTemplateLockProvider"
      pattern: "JdbcTemplateLockProvider.*dataSource"
    - from: "WorkspaceTier.kt"
      to: "WorkspacePlan.kt"
      via: "fromPlan companion function"
      pattern: "fromPlan.*WorkspacePlan"
---

<objective>
Set up ShedLock distributed locking infrastructure and define workspace tier concurrency limits.

Purpose: Enable safe distributed queue processing across multiple application instances and establish tier-based
concurrency control for workflow executions.

Output: ShedLock Spring configuration, shedlock DDL table, WorkspaceTier enum with concurrency limits per plan.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.1-execution-queue-management/06.1-CONTEXT.md
@.planning/phases/06.1-execution-queue-management/06.1-RESEARCH.md
@src/main/kotlin/riven/core/enums/workspace/WorkspacePlan.kt
@build.gradle.kts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ShedLock dependencies and configuration</name>
  <files>
    - build.gradle.ktscont
    - src/main/kotlin/riven/core/configuration/ShedLockConfiguration.kt
    - schema.sql
  </files>
  <action>
    1. Add ShedLock dependencies to build.gradle.kts:
       ```kotlin
       implementation("net.javacrumbs.shedlock:shedlock-spring:7.5.0")
       implementation("net.javacrumbs.shedlock:shedlock-provider-jdbc-template:7.5.0")
       ```

    2. Create ShedLockConfiguration.kt in configuration package:
       - Use @Configuration annotation
       - Add @EnableScheduling annotation
       - Add @EnableSchedulerLock(defaultLockAtMostFor = "5m") annotation
       - Create lockProvider() @Bean that returns JdbcTemplateLockProvider
       - Use .usingDbTime() for clock skew safety (critical per research)
       - Inject DataSource via constructor

    3. Add shedlock table DDL to schema.sql (append to end):
       ```sql
       -- ShedLock table for distributed scheduler locking
       CREATE TABLE IF NOT EXISTS public.shedlock (
           name VARCHAR(64) PRIMARY KEY,
           lock_until TIMESTAMP(3) NOT NULL,
           locked_at TIMESTAMP(3) NOT NULL,
           locked_by VARCHAR(255) NOT NULL
       );
       ```

    Follow existing project patterns:
    - Constructor injection (not field injection)
    - KLogger for logging
    - Package: riven.core.configuration (NOT configuration/workflow since this is cross-cutting)

  </action>
  <verify>
    - `./gradlew compileKotlin` passes
    - ShedLockConfiguration.kt exists with @EnableSchedulerLock annotation
    - schema.sql contains CREATE TABLE shedlock
  </verify>
  <done>
    ShedLock infrastructure ready: dependencies added, configuration created, DDL defined.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create WorkspaceTier enum with concurrency limits</name>
  <files>src/main/kotlin/riven/core/enums/workspace/WorkspaceTier.kt</files>
  <action>
    Create WorkspaceTier enum that maps WorkspacePlan to execution limits:

    ```kotlin
    package riven.core.enums.workspace

    /**
     * Workspace tier with associated resource limits.
     *
     * Defines maximum concurrent workflow executions per workspace based on tier.
     * Tiers map directly from WorkspacePlan - each plan has exactly one tier.
     *
     * @property maxConcurrentWorkflows Maximum simultaneous workflow executions
     * @property displayName Human-readable tier name
     */
    enum class WorkspaceTier(
        val maxConcurrentWorkflows: Int,
        val displayName: String
    ) {
        FREE(1, "Free"),
        STARTUP(3, "Startup"),
        SCALE(5, "Scale"),
        ENTERPRISE(10, "Enterprise");

        companion object {
            /**
             * Get tier for a workspace plan.
             *
             * @param plan WorkspacePlan to convert
             * @return Corresponding WorkspaceTier
             */
            fun fromPlan(plan: WorkspacePlan): WorkspaceTier = when (plan) {
                WorkspacePlan.FREE -> FREE
                WorkspacePlan.STARTUP -> STARTUP
                WorkspacePlan.SCALE -> SCALE
                WorkspacePlan.ENTERPRISE -> ENTERPRISE
            }

            val DEFAULT = FREE
        }
    }
    ```

    Limits per CONTEXT.md decisions:
    - FREE: 1 (basic users)
    - STARTUP: 3 (small teams)
    - SCALE: 5 (Pro tier equivalent)
    - ENTERPRISE: 10 (full capacity)

    Follow existing enum patterns in codebase (see WorkspacePlan.kt for style).

  </action>
  <verify>
    - `./gradlew compileKotlin` passes
    - WorkspaceTier.kt exists in enums/workspace/
    - All four tiers defined with correct limits (1, 3, 5, 10)
    - fromPlan() companion function handles all WorkspacePlan values
  </verify>
  <done>
    WorkspaceTier enum complete with tier-to-limit mapping and fromPlan conversion.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Build verification:
   ```bash
   ./gradlew compileKotlin
   ```

2. ShedLock setup complete:
    - Dependency present in build.gradle.kts
    - ShedLockConfiguration.kt uses @EnableSchedulerLock
    - schema.sql has shedlock table DDL

3. WorkspaceTier enum complete:
    - Maps all WorkspacePlan values
    - Provides maxConcurrentWorkflows per tier
    - Has fromPlan() conversion function
      </verification>

<success_criteria>

- ShedLock dependencies added to build.gradle.kts
- ShedLockConfiguration.kt created with JdbcTemplateLockProvider bean
- shedlock table DDL added to schema.sql
- WorkspaceTier enum created with all tiers and limits
- ./gradlew compileKotlin passes without errors
  </success_criteria>

<output>
After completion, create `.planning/phases/06.1-execution-queue-management/06.1-01-SUMMARY.md`
</output>
