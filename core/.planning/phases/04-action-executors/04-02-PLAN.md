---
phase: 04-action-executors
plan: 02
type: execute
---

<objective>
Implement HTTP request actions and conditional control flow executors for workflow nodes.

Purpose: Enable workflows to make external HTTP requests and branch execution based on expression evaluation, completing the core action and control flow capabilities.
Output: Working HTTP_REQUEST action executor and CONDITION control flow executor with expression evaluation integration.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries
@.planning/phases/01-expression-system-foundation/01-01-SUMMARY.md
@.planning/phases/02-entity-context-integration/02-01-SUMMARY.md
@.planning/phases/03-temporal-workflow-engine/03-01-SUMMARY.md
@.planning/phases/04-action-executors/04-01-SUMMARY.md

# Key implementation files
@src/main/kotlin/riven/core/service/workflow/temporal/activities/WorkflowNodeActivitiesImpl.kt
@src/main/kotlin/riven/core/service/workflow/ExpressionParserService.kt
@src/main/kotlin/riven/core/service/workflow/ExpressionEvaluatorService.kt
@src/main/kotlin/riven/core/service/workflow/EntityContextService.kt
@src/main/kotlin/riven/core/models/workflow/WorkflowControlNode.kt
@src/main/kotlin/riven/core/enums/workflow/WorkflowControlType.kt

# Codebase patterns
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md

**Tech stack available:**
- ExpressionParserService and ExpressionEvaluatorService (Phase 1)
- EntityContextService for entity data resolution (Phase 2)
- Spring WebClient (reactive HTTP client) - already in dependencies
- Temporal activity framework (Phase 3)
- Entity CRUD executors (Plan 04-01)

**Established patterns:**
- Activity implementation as Spring bean with constructor injection
- Expression parsing from SQL-like strings
- Entity context resolution with relationship traversal
- Error handling via NodeExecutionResult.error

**Constraining decisions:**
- Phase 1: "SQL-like expression syntax with =, !=, >, <, >=, <=, AND, OR operators"
- Phase 2: "maxDepth default of 3 prevents infinite recursion in relationship traversal"
- Phase 3: "Activity timeout set to 5 minutes with 3 retry attempts max"
- Plan 04-01: "Entity service integration with comprehensive error handling"
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement HTTP_REQUEST action executor with WebClient</name>
  <files>src/main/kotlin/riven/core/service/workflow/temporal/activities/WorkflowNodeActivitiesImpl.kt, build.gradle.kts</files>
  <action>
Add HTTP_REQUEST action executor to WorkflowNodeActivitiesImpl:

1. Add Spring WebClient as constructor dependency (already in Spring Boot dependencies)
   - Inject WebClient.Builder and create instance
2. Extend executeActionNode() switch to handle HTTP_REQUEST:
   - Parse config to extract: url (String), method (GET/POST/PUT/DELETE), headers (Map<String, String>), body (optional Map<String, Any?>)
   - Build WebClient request with configured method, headers, body
   - Execute request with block() (synchronous - activities are non-deterministic)
   - Capture response: status code, headers, body
   - Return response data in NodeExecutionResult.output
3. Handle HTTP errors:
   - Connection timeout → error in NodeExecutionResult
   - 4xx/5xx status codes → include status code and response body in error
   - Network errors → capture exception message
4. Add request/response logging at INFO level

**What to avoid:**
- DON'T use RestTemplate (deprecated) - use WebClient
- DON'T make HTTP calls in Temporal workflow code (non-deterministic) - only in activities
- DON'T expose sensitive headers (Authorization, API keys) in logs
- DON'T allow arbitrary URLs without validation (security risk - validate URL format)
- DON'T use async WebClient methods (.subscribe(), .doOnNext()) - use .block() for synchronous execution in activity

**Why:**
- WebClient is modern Spring reactive HTTP client (RestTemplate deprecated)
- Temporal workflows must be deterministic; HTTP calls are non-deterministic (activities only)
- Logging sensitive data creates audit trail security issues
- URL validation prevents SSRF attacks (Server-Side Request Forgery)
- Activities should be synchronous; Temporal handles async orchestration at workflow level
  </action>
  <verify>./gradlew compileKotlin passes. HTTP_REQUEST in executeActionNode() switch statement. WebClient dependency available.</verify>
  <done>
- HTTP_REQUEST executes HTTP calls with WebClient
- Config parsing extracts url, method, headers, body
- Response captured with status code and body
- Error handling for timeouts, HTTP errors, network failures
- Sensitive headers masked in logs
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement CONDITION control flow executor with expression evaluation</name>
  <files>src/main/kotlin/riven/core/service/workflow/temporal/activities/WorkflowNodeActivitiesImpl.kt</files>
  <action>
Replace stubbed executeControlNode() with real implementation for CONDITION:

1. Cast config to WorkflowControlNode and extract subType
2. For CONDITION:
   - Parse config to extract: expression (String), contextEntityId (optional UUID)
   - If contextEntityId provided:
     - Call entityContextService.buildContext(contextEntityId, workspaceId)
     - Get entity data as Map<String, Any?>
   - Else: Use empty context or workflow-level variables
   - Call expressionParserService.parse(expression) to get Expression AST
   - Call expressionEvaluatorService.evaluate(ast, context) to get boolean result
   - Return result in NodeExecutionResult.output as Map("conditionResult" to <boolean>)
3. Handle expression errors:
   - Parse errors (invalid syntax) → error in NodeExecutionResult
   - Evaluation errors (undefined property, type mismatch) → error in NodeExecutionResult
   - Entity not found → error in NodeExecutionResult
4. Add expression evaluation logging at DEBUG level

**What to avoid:**
- DON'T evaluate expressions in workflow code (use activity only)
- DON'T ignore expression parsing errors - surface them for debugging
- DON'T return non-boolean results from CONDITION (must be true/false)
- DON'T cache expression parsing results across executions (each execution is independent)

**Why:**
- Expression evaluation can be non-deterministic (entity data changes)
- Parse errors indicate workflow configuration issues (need debugging)
- CONDITION nodes control branching; non-boolean results break DAG execution
- Temporal replays workflows; caching breaks determinism
  </action>
  <verify>./gradlew compileKotlin passes. CONDITION in executeControlNode() switch statement. Expression services called.</verify>
  <done>
- CONDITION evaluates expressions against entity context
- Expression parsing and evaluation integrated
- Boolean result returned in output
- Error handling for parse errors, evaluation errors, missing entities
- Debug logging for expression evaluation steps
  </done>
</task>

<task type="auto">
  <name>Task 3: Add integration test for HTTP and CONDITION executors</name>
  <files>src/test/kotlin/riven/core/service/workflow/temporal/activities/WorkflowNodeActivitiesImplTest.kt</files>
  <action>
Extend WorkflowNodeActivitiesImplTest with HTTP_REQUEST and CONDITION tests:

1. Test HTTP_REQUEST:
   - Success case: Mock HTTP server (WireMock or MockWebServer) returns 200 → response captured
   - Success case: POST with body → body sent correctly
   - Failure case: HTTP 500 error → error captured with status code
   - Failure case: Connection timeout → error captured
2. Test CONDITION:
   - Success case: Expression "status = 'active'" + entity context → true result
   - Success case: Expression "count > 10" + entity context → false result
   - Failure case: Invalid expression syntax → parse error captured
   - Failure case: Undefined property "invalid.field" → evaluation error captured
   - Failure case: Entity not found → error captured
3. Mock dependencies:
   - WebClient for HTTP tests (use WebClient.builder().exchangeFunction(mockExchange))
   - EntityContextService for CONDITION tests
   - ExpressionParserService and ExpressionEvaluatorService

**What to avoid:**
- DON'T make real HTTP calls in tests (use mocks or WireMock)
- DON'T test expression parser/evaluator logic (already tested in Phase 1)
- DON'T test entity service logic (already tested)
- Focus on activity routing and error handling

**Why:**
- Real HTTP calls make tests slow and flaky
- Expression parser/evaluator have their own comprehensive tests
- Activity tests should focus on integration and error propagation
  </action>
  <verify>./gradlew test --tests WorkflowNodeActivitiesImplTest passes all tests</verify>
  <done>
- HTTP_REQUEST tests cover success (200) and errors (500, timeout)
- CONDITION tests cover true/false results and errors
- Mocks verify correct service method calls
- Test coverage for all error paths
- Tests run in <10 seconds
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] ./gradlew clean build succeeds without errors
- [ ] ./gradlew test passes all tests including HTTP and CONDITION tests
- [ ] HTTP_REQUEST makes HTTP calls and captures responses
- [ ] CONDITION evaluates expressions and returns boolean results
- [ ] Error handling comprehensive for HTTP errors, expression errors, entity errors
- [ ] No security issues (SSRF prevention, sensitive data masking)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No compilation errors or warnings
- HTTP_REQUEST action executor operational
- CONDITION control flow executor operational
- Expression evaluation integrated with entity context
- Test coverage for success and failure paths
- Phase 4 complete - all core action executors implemented
  </success_criteria>

<output>
After completion, create `.planning/phases/04-action-executors/04-02-SUMMARY.md`:

# Phase 4 Plan 2: HTTP Actions and Conditional Control Flow Summary

**[Substantive one-liner - what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.kt` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 4 complete. Ready for Phase 5 (DAG Execution Coordinator)
</output>
