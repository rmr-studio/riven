---
phase: 04-action-executors
plan: 01
type: execute
---

<objective>
Implement entity CRUD action executors for workflow nodes.

Purpose: Enable workflows to create, update, delete, and query entities as actions, completing the entity manipulation capabilities required for automated business logic.
Output: Working CREATE_ENTITY, UPDATE_ENTITY, DELETE_ENTITY, and QUERY_ENTITY action executors with full entity service integration.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries (dependency chain)
@.planning/phases/01-expression-system-foundation/01-01-SUMMARY.md
@.planning/phases/02-entity-context-integration/02-01-SUMMARY.md
@.planning/phases/03-temporal-workflow-engine/03-01-SUMMARY.md

# Key implementation files
@src/main/kotlin/riven/core/service/workflow/temporal/activities/WorkflowNodeActivitiesImpl.kt
@src/main/kotlin/riven/core/service/entity/EntityService.kt
@src/main/kotlin/riven/core/models/workflow/WorkflowActionNode.kt
@src/main/kotlin/riven/core/enums/workflow/WorkflowActionType.kt

# Codebase patterns
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md

**Tech stack available:**
- EntityService with createEntity, updateEntity, deleteEntity methods
- EntityValidationService for schema validation
- ExpressionEvaluatorService and EntityContextService (from Phases 1-2)
- Temporal activity framework (from Phase 3)

**Established patterns:**
- Activity implementation as Spring bean with constructor injection
- Node type routing in WorkflowNodeActivitiesImpl.executeNode()
- Stub implementations currently return mock success

**Constraining decisions:**
- Phase 3: "V1: Sequential node execution, parallel execution deferred to Phase 5"
- Phase 3: "Activity timeout set to 5 minutes with 3 retry attempts max"
- Phase 3: "Node type routing: ACTION (entity CRUD), CONTROL_FLOW (expressions), TRIGGER (skip)"

**Issues being addressed:** None from prior phases
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement CREATE_ENTITY and UPDATE_ENTITY action executors</name>
  <files>src/main/kotlin/riven/core/service/workflow/temporal/activities/WorkflowNodeActivitiesImpl.kt</files>
  <action>
Replace the stubbed executeActionNode() method with real implementation that:

1. Cast config to WorkflowActionNode and extract subType
2. For CREATE_ENTITY:
   - Parse config to extract: entityTypeKey, payload (Map<String, Any?>)
   - Call entityService.createEntity(workspaceId, entityTypeKey, payload)
   - Return entity ID and payload as output
   - Handle SchemaValidationException and return error
3. For UPDATE_ENTITY:
   - Parse config to extract: entityId (UUID), payload updates
   - Call entityService.updateEntity(workspaceId, entityId, payload)
   - Return updated entity ID and payload as output
   - Handle NotFoundException, SchemaValidationException
4. Add helper method parseActionConfig() to extract typed fields from config

**What to avoid:**
- DON'T use type assertions (config as WorkflowActionNode) without safe casting
- DON'T ignore validation errors - surface them in NodeExecutionResult.error
- DON'T hardcode workspace ID - use the workspaceId parameter
- DON'T call entity service methods directly without proper error handling

**Why:**
- WorkflowNode is sealed interface, config must be safely cast to concrete type
- Validation errors need to be captured in execution records for debugging
- Multi-tenancy requires workspace ID for all entity operations
- Temporal retry logic depends on proper exception propagation
  </action>
  <verify>./gradlew compileKotlin passes without errors. Code compiles and type-checks correctly.</verify>
  <done>
- executeActionNode() handles CREATE_ENTITY and UPDATE_ENTITY with real EntityService calls
- Config parsing extracts entityTypeKey, entityId, and payload
- Validation errors are caught and returned in NodeExecutionResult.error
- Entity IDs returned in NodeExecutionResult.output
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement DELETE_ENTITY and QUERY_ENTITY action executors</name>
  <files>src/main/kotlin/riven/core/service/workflow/temporal/activities/WorkflowNodeActivitiesImpl.kt</files>
  <action>
Extend executeActionNode() to handle DELETE_ENTITY and QUERY_ENTITY:

1. For DELETE_ENTITY:
   - Parse config to extract: entityId (UUID)
   - Call entityService.deleteEntity(workspaceId, entityId)
   - Return success confirmation with deleted entity ID
   - Handle NotFoundException (entity doesn't exist)
2. For QUERY_ENTITY:
   - Parse config to extract: entityTypeKey, optional filters (for v1: single entity ID)
   - Call entityService.getEntityById(workspaceId, entityId) for v1 (full query deferred to Phase 5)
   - Return entity data (id, typeKey, payload) as output
   - Handle NotFoundException
3. Add comprehensive error logging for all action types
4. Ensure NodeExecutionResult.status is "COMPLETED" on success, "FAILED" on errors

**What to avoid:**
- DON'T implement complex query filtering in v1 - single entity fetch is sufficient
- DON'T swallow NotFoundException - return it in error field
- DON'T return sensitive data in output (passwords, tokens) - this is stored in execution records

**Why:**
- Complex queries require query DSL parsing (scope creep for Phase 4)
- Not found errors are actionable debugging information
- Execution records are audit logs, sensitive data leakage is security risk
  </action>
  <verify>./gradlew compileKotlin passes. All four action types (CREATE, UPDATE, DELETE, QUERY) handled in switch statement.</verify>
  <done>
- DELETE_ENTITY deletes entity and returns confirmation
- QUERY_ENTITY fetches entity by ID and returns full payload
- All action types log execution with context
- Error handling comprehensive for NotFoundException, SchemaValidationException
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for entity CRUD action executors</name>
  <files>src/test/kotlin/riven/core/service/workflow/temporal/activities/WorkflowNodeActivitiesImplTest.kt</files>
  <action>
Create comprehensive unit tests for WorkflowNodeActivitiesImpl:

1. Test CREATE_ENTITY:
   - Success case: Valid entity type and payload → entity created, ID returned
   - Failure case: Invalid schema → SchemaValidationException → FAILED status
   - Failure case: Missing entityTypeKey in config → error returned
2. Test UPDATE_ENTITY:
   - Success case: Existing entity + valid payload → entity updated
   - Failure case: Entity not found → NotFoundException → FAILED status
   - Failure case: Schema validation fails → error returned
3. Test DELETE_ENTITY:
   - Success case: Existing entity → deleted successfully
   - Failure case: Entity not found → NotFoundException → FAILED status
4. Test QUERY_ENTITY:
   - Success case: Valid entity ID → entity data returned
   - Failure case: Entity not found → NotFoundException → FAILED status

Use Mockito to mock EntityService, WorkflowNodeRepository, WorkflowExecutionNodeRepository.
Use H2 in-memory database for repositories if needed (follow existing test patterns).

**What to avoid:**
- DON'T create actual Temporal workflows in unit tests (use mock activity context)
- DON'T test integration with PostgreSQL (unit tests only)
- DON'T duplicate tests from EntityServiceTest (focus on activity layer)

**Why:**
- Temporal TestWorkflowEnvironment is for integration tests (Phase 3 has those)
- Unit tests should be fast and isolated
- EntityService already has its own tests; we're testing activity routing
  </action>
  <verify>./gradlew test --tests WorkflowNodeActivitiesImplTest passes all tests</verify>
  <done>
- All 4 action types have success and failure test cases
- Mocks verify correct EntityService method calls
- Test coverage for error handling (NotFoundException, SchemaValidationException)
- Tests run in <5 seconds
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] ./gradlew clean build succeeds without errors
- [ ] ./gradlew test passes all tests including new WorkflowNodeActivitiesImplTest
- [ ] All four CRUD action types (CREATE, UPDATE, DELETE, QUERY) implemented
- [ ] Error handling comprehensive (validation, not found, security)
- [ ] No type safety warnings or unsafe casts
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No compilation errors or warnings
- CREATE_ENTITY, UPDATE_ENTITY, DELETE_ENTITY, QUERY_ENTITY fully operational
- Test coverage for success and failure paths
- Entity service integration working end-to-end
  </success_criteria>

<output>
After completion, create `.planning/phases/04-action-executors/04-01-SUMMARY.md`:

# Phase 4 Plan 1: Entity CRUD Action Executors Summary

**[Substantive one-liner - what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.kt` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 04-02-PLAN.md (HTTP actions and conditional control flow)
</output>
