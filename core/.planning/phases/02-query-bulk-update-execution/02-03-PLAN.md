---
phase: 02-query-bulk-update-execution
plan: 03
type: execute
wave: 2
depends_on: ["02-02"]
files_modified:
  - src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowBulkUpdateEntityActionConfig.kt
  - src/main/kotlin/riven/core/service/workflow/WorkflowNodeConfigRegistry.kt
  - src/main/kotlin/riven/core/service/workflow/engine/coordinator/WorkflowCoordinationService.kt
autonomous: true

must_haves:
  truths:
    - "BulkUpdateEntityNode applies identical field updates to all entities matching the query"
    - "BulkUpdateEntityNode returns entitiesUpdated and entitiesFailed counts"
    - "BulkUpdateEntityNode supports FAIL_FAST and BEST_EFFORT error handling modes"
    - "Bulk update processes ALL matching entities regardless of query limit"
    - "Bulk update processes entities in configurable batches"
    - "FAIL_FAST stops on first failure with count of what succeeded"
    - "BEST_EFFORT processes all entities and reports failed entity IDs with error messages"
    - "BulkUpdateEntity is registered in WorkflowNodeConfigRegistry and WorkflowCoordinationService"
  artifacts:
    - path: "src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowBulkUpdateEntityActionConfig.kt"
      provides: "Working execute() implementation with batch processing and error handling"
      contains: "EntityService"
    - path: "src/main/kotlin/riven/core/service/workflow/WorkflowNodeConfigRegistry.kt"
      provides: "BULK_UPDATE_ENTITY node registration"
      contains: "WorkflowBulkUpdateEntityActionConfig"
    - path: "src/main/kotlin/riven/core/service/workflow/engine/coordinator/WorkflowCoordinationService.kt"
      provides: "Config map case for BULK_UPDATE_ENTITY"
      contains: "WorkflowBulkUpdateEntityActionConfig"
  key_links:
    - from: "WorkflowBulkUpdateEntityActionConfig.execute()"
      to: "EntityQueryService.execute()"
      via: "services.service<EntityQueryService>()"
      pattern: "services\\.service<EntityQueryService>"
    - from: "WorkflowBulkUpdateEntityActionConfig.execute()"
      to: "EntityService.saveEntity()"
      via: "services.service<EntityService>()"
      pattern: "entityService\\.saveEntity"
    - from: "WorkflowBulkUpdateEntityActionConfig.execute()"
      to: "BulkUpdateEntityOutput"
      via: "return BulkUpdateEntityOutput(...)"
      pattern: "BulkUpdateEntityOutput\\("
    - from: "WorkflowNodeConfigRegistry"
      to: "WorkflowBulkUpdateEntityActionConfig"
      via: "registerNode<>()"
      pattern: "registerNode<WorkflowBulkUpdateEntityActionConfig>"
    - from: "WorkflowCoordinationService"
      to: "WorkflowBulkUpdateEntityActionConfig"
      via: "when clause in config map extraction"
      pattern: "is WorkflowBulkUpdateEntityActionConfig"
---

<objective>
Implement BulkUpdateEntity execute() with batch processing, error handling modes, and register the node in the system.

Purpose: The BulkUpdateEntity config class exists from Plan 02 with a placeholder execute(). This plan implements the full execution logic: query all matching entities (paginating through ALL results, not capped by query limit), apply identical field updates to each entity in configurable batches, respect FAIL_FAST vs BEST_EFFORT error handling, and return BulkUpdateEntityOutput. Also wires the node into the registry and coordination service so it can be used in workflows.

Output: Fully functional BulkUpdateEntity workflow node registered and ready for workflow execution.
</objective>

<execution_context>
@/home/jared/.claude/get-shit-done/workflows/execute-plan.md
@/home/jared/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-query-bulk-update-execution/02-02-SUMMARY.md

@src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowBulkUpdateEntityActionConfig.kt
@src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowUpdateEntityActionConfig.kt
@src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowQueryEntityActionConfig.kt
@src/main/kotlin/riven/core/models/workflow/engine/state/NodeOutput.kt
@src/main/kotlin/riven/core/service/entity/query/EntityQueryService.kt
@src/main/kotlin/riven/core/service/entity/EntityService.kt
@src/main/kotlin/riven/core/models/entity/query/EntityQueryResult.kt
@src/main/kotlin/riven/core/models/entity/Entity.kt
@src/main/kotlin/riven/core/service/workflow/WorkflowNodeConfigRegistry.kt
@src/main/kotlin/riven/core/service/workflow/engine/coordinator/WorkflowCoordinationService.kt
@src/main/kotlin/riven/core/service/workflow/state/WorkflowNodeInputResolverService.kt
@src/main/kotlin/riven/core/enums/workflow/BulkUpdateErrorHandling.kt
@src/main/kotlin/riven/core/models/entity/query/pagination/QueryPagination.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement BulkUpdateEntityActionConfig execute() with batch processing and error handling</name>
  <files>src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowBulkUpdateEntityActionConfig.kt</files>
  <action>
Replace the NotImplementedError execute() placeholder with a working implementation. Follow the established pattern from UpdateEntityActionConfig.execute() for the entity update logic.

**execute() implementation:**

1. **Get services:**
   - `val entityQueryService = services.service<EntityQueryService>()`
   - `val entityService = services.service<EntityService>()`
   - `val inputResolver = services.service<WorkflowNodeInputResolverService>()`
   - `val workspaceId = dataStore.metadata.workspaceId`

2. **Resolve template FilterValues** in query.filter (same approach as QueryEntityActionConfig -- resolve FilterValue.Template expressions using inputResolver against the dataStore). Reuse or duplicate the resolveFilterTemplates helper from Plan 01's implementation.

3. **Resolve payload templates:** The `inputs["payload"]` from the coordination service will have template strings resolved. Extract the resolved payload map.

4. **Query ALL matching entities using pagination loop** (per locked decision: "Bulk update processes ALL matching entities regardless of any query limit"):
   - Define batch size constant: `private const val BULK_UPDATE_BATCH_SIZE = 50` (Claude's discretion)
   - Define query page size: `private const val QUERY_PAGE_SIZE = 100`
   - Loop with increasing offset, fetching QUERY_PAGE_SIZE entities per page
   - Accumulate all entity IDs across pages
   - Continue until `hasNextPage` is false
   - Use `kotlinx.coroutines.runBlocking` to call the suspend EntityQueryService.execute()

5. **Process entities in batches of BULK_UPDATE_BATCH_SIZE:**
   - Chunk the accumulated entities into batches
   - For each entity in each batch, apply the update using EntityService.saveEntity() following the same pattern as UpdateEntityActionConfig.execute():
     - Map resolved payload keys to UUIDs
     - Wrap values in EntityAttributeRequest with EntityAttributePrimitivePayload (SchemaType.TEXT default)
     - Build SaveEntityRequest with entity.id, entityPayload, null icon
     - Call entityService.saveEntity(workspaceId, entity.typeId, saveRequest)

6. **Error handling per mode:**

   **FAIL_FAST:**
   ```kotlin
   try {
       entityService.saveEntity(...)
       entitiesUpdated++
   } catch (e: Exception) {
       log.error { "FAIL_FAST: Entity ${entity.id} update failed: ${e.message}" }
       // Return immediately with what succeeded so far
       return BulkUpdateEntityOutput(
           entitiesUpdated = entitiesUpdated,
           entitiesFailed = 1,
           failedEntityDetails = listOf(mapOf("entityId" to entity.id.toString(), "error" to (e.message ?: "Unknown error"))),
           totalProcessed = entitiesUpdated + 1
       )
   }
   ```

   **BEST_EFFORT:**
   ```kotlin
   try {
       entityService.saveEntity(...)
       entitiesUpdated++
   } catch (e: Exception) {
       log.warn { "BEST_EFFORT: Entity ${entity.id} update failed: ${e.message}" }
       entitiesFailed++
       failedDetails.add(mapOf("entityId" to entity.id.toString(), "error" to (e.message ?: "Unknown error")))
   }
   ```

7. **Return BulkUpdateEntityOutput:**
   ```kotlin
   return BulkUpdateEntityOutput(
       entitiesUpdated = entitiesUpdated,
       entitiesFailed = entitiesFailed,
       failedEntityDetails = failedDetails,
       totalProcessed = entitiesUpdated + entitiesFailed
   )
   ```

**Add required imports:**
- `import kotlinx.coroutines.runBlocking`
- `import riven.core.service.entity.query.EntityQueryService`
- `import riven.core.service.entity.EntityService`
- `import riven.core.service.workflow.state.WorkflowNodeInputResolverService`
- `import riven.core.models.entity.payload.EntityAttributePrimitivePayload`
- `import riven.core.models.entity.payload.EntityAttributeRequest`
- `import riven.core.models.request.entity.SaveEntityRequest`
- `import riven.core.enums.common.validation.SchemaType`
- `import riven.core.models.workflow.engine.state.BulkUpdateEntityOutput`
- `import riven.core.models.entity.query.pagination.QueryPagination`
- `import java.util.*`

**Do NOT add rollback logic** -- per locked decision: "No rollback -- entities updated before the failure stay updated."

**Log info** at start: `log.info { "Executing BULK_UPDATE_ENTITY for type: ${query.entityTypeId}, errorHandling: $errorHandling" }`
**Log info** at end: `log.info { "BULK_UPDATE_ENTITY complete: $entitiesUpdated updated, $entitiesFailed failed, $totalProcessed total" }`
  </action>
  <verify>
Run `./gradlew test` -- all tests pass. Verify the file compiles with `./gradlew compileKotlin`. No NotImplementedError remains.
  </verify>
  <done>
BulkUpdateEntityActionConfig.execute() queries all matching entities via pagination loop, applies field updates in batches of 50, respects FAIL_FAST (stop on first error) and BEST_EFFORT (continue and collect failures) modes, returns BulkUpdateEntityOutput with accurate counts. No rollback on failure.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register BulkUpdateEntity in WorkflowNodeConfigRegistry and WorkflowCoordinationService</name>
  <files>
    src/main/kotlin/riven/core/service/workflow/WorkflowNodeConfigRegistry.kt
    src/main/kotlin/riven/core/service/workflow/engine/coordinator/WorkflowCoordinationService.kt
  </files>
  <action>
**1. Register in WorkflowNodeConfigRegistry:**

In the `registerAllNodes()` method, add a new entry after the QUERY_ENTITY registration:
```kotlin
registerNode<WorkflowBulkUpdateEntityActionConfig>(
    WorkflowNodeType.ACTION,
    "BULK_UPDATE_ENTITY"
),
```

Add the import: `import riven.core.models.workflow.node.config.actions.WorkflowBulkUpdateEntityActionConfig`

This will cause the registry to extract metadata, configSchema, and outputMetadata from the companion object via reflection, and expose it via the node-schemas API endpoint.

**2. Add config map case in WorkflowCoordinationService:**

In the `when` block that extracts configMap from node.config (around the area with `is WorkflowCreateEntityActionConfig`, `is WorkflowUpdateEntityActionConfig`, etc.), add:
```kotlin
is WorkflowBulkUpdateEntityActionConfig -> config.config
```

Add the import if not already covered by the wildcard import of the actions package.

This allows the coordination service to extract the config map for template resolution before calling execute().
  </action>
  <verify>
Run `./gradlew test` -- all tests pass. OutputMetadataValidationTest should now discover BulkUpdateEntityActionConfig via the registry and validate its outputMetadata keys against BulkUpdateEntityOutput.toMap() keys. Verify BULK_UPDATE_ENTITY appears in the node-schemas API by checking that the registry's getAllNodes() includes it.
  </verify>
  <done>
BulkUpdateEntity node registered in WorkflowNodeConfigRegistry (metadata, configSchema, outputMetadata exposed via API). WorkflowCoordinationService handles BULK_UPDATE_ENTITY config map extraction for template resolution. OutputMetadataValidationTest validates BulkUpdateEntityActionConfig.outputMetadata. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew test` passes with zero failures
2. No NotImplementedError in BulkUpdateEntityActionConfig.execute()
3. BULK_UPDATE_ENTITY appears in registry's getAllNodes()
4. OutputMetadataValidationTest validates BulkUpdateEntityActionConfig outputMetadata
5. WorkflowCoordinationService has config map case for BulkUpdateEntity
6. Batch processing logic processes ALL matching entities (not capped by query limit)
7. FAIL_FAST and BEST_EFFORT modes produce correct output shapes
</verification>

<success_criteria>
- BulkUpdateEntity execute() queries all matching entities via paginated loop
- Entity updates applied in batches of 50 using EntityService.saveEntity()
- FAIL_FAST mode stops on first error, returns count of successes before failure
- BEST_EFFORT mode continues through all entities, collects failed entity IDs with errors
- No rollback on failure (entities updated before failure remain updated)
- BulkUpdateEntity registered in WorkflowNodeConfigRegistry
- BulkUpdateEntity config map handled in WorkflowCoordinationService
- OutputMetadataValidationTest validates outputMetadata keys match toMap() keys
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-query-bulk-update-execution/02-03-SUMMARY.md`
</output>
