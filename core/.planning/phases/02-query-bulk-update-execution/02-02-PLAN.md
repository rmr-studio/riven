---
phase: 02-query-bulk-update-execution
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/kotlin/riven/core/enums/workflow/BulkUpdateErrorHandling.kt
  - src/main/kotlin/riven/core/enums/workflow/WorkflowActionType.kt
  - src/main/kotlin/riven/core/models/workflow/engine/state/NodeOutput.kt
  - src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowBulkUpdateEntityActionConfig.kt
autonomous: true

must_haves:
  truths:
    - "BulkUpdateEntityActionConfig exists as a separate WorkflowActionConfig"
    - "BULK_UPDATE_ENTITY exists in WorkflowActionType enum"
    - "BulkUpdateEntityOutput NodeOutput exists with entitiesUpdated, entitiesFailed, and failedEntityDetails"
    - "BulkUpdateErrorHandling enum defines FAIL_FAST and BEST_EFFORT modes"
    - "BulkUpdateEntityActionConfig has embedded query config (self-contained, no dependency on separate QueryEntity node)"
    - "BulkUpdateEntityActionConfig declares outputMetadata"
  artifacts:
    - path: "src/main/kotlin/riven/core/enums/workflow/BulkUpdateErrorHandling.kt"
      provides: "FAIL_FAST and BEST_EFFORT enum values"
      contains: "enum class BulkUpdateErrorHandling"
    - path: "src/main/kotlin/riven/core/enums/workflow/WorkflowActionType.kt"
      provides: "BULK_UPDATE_ENTITY enum value"
      contains: "BULK_UPDATE_ENTITY"
    - path: "src/main/kotlin/riven/core/models/workflow/engine/state/NodeOutput.kt"
      provides: "BulkUpdateEntityOutput data class"
      contains: "data class BulkUpdateEntityOutput"
    - path: "src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowBulkUpdateEntityActionConfig.kt"
      provides: "Complete config class with companion metadata, configSchema, outputMetadata, validate()"
      contains: "class WorkflowBulkUpdateEntityActionConfig"
  key_links:
    - from: "WorkflowBulkUpdateEntityActionConfig"
      to: "WorkflowActionConfig"
      via: "implements interface"
      pattern: "WorkflowBulkUpdateEntityActionConfig.*:.*WorkflowActionConfig"
    - from: "WorkflowBulkUpdateEntityActionConfig.subType"
      to: "WorkflowActionType.BULK_UPDATE_ENTITY"
      via: "override property"
      pattern: "BULK_UPDATE_ENTITY"
    - from: "WorkflowBulkUpdateEntityActionConfig.companion.outputMetadata"
      to: "BulkUpdateEntityOutput.toMap() keys"
      via: "key field matching"
      pattern: "outputMetadata.*=.*WorkflowNodeOutputMetadata"
---

<objective>
Create the BulkUpdateEntity model layer: enum, output type, and config class with validation and metadata.

Purpose: Before implementing BulkUpdate execution logic, the model layer needs to exist -- the error handling enum, the NodeOutput subclass, the WorkflowActionType enum value, and the full config class with companion metadata/configSchema/outputMetadata/validate(). The execute() method will be a placeholder (NotImplementedError) in this plan, implemented in Plan 03.

Output: Complete BulkUpdateEntity type system ready for execution implementation.
</objective>

<execution_context>
@/home/jared/.claude/get-shit-done/workflows/execute-plan.md
@/home/jared/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-infrastructure/01-01-SUMMARY.md

@src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowCreateEntityActionConfig.kt
@src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowQueryEntityActionConfig.kt
@src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowUpdateEntityActionConfig.kt
@src/main/kotlin/riven/core/models/workflow/engine/state/NodeOutput.kt
@src/main/kotlin/riven/core/enums/workflow/WorkflowActionType.kt
@src/main/kotlin/riven/core/enums/workflow/WorkflowNodeConfigFieldType.kt
@src/main/kotlin/riven/core/models/workflow/node/config/WorkflowActionConfig.kt
@src/main/kotlin/riven/core/models/workflow/node/config/WorkflowNodeConfig.kt
@src/main/kotlin/riven/core/models/workflow/node/config/WorkflowNodeOutputField.kt
@src/main/kotlin/riven/core/models/workflow/node/config/WorkflowNodeOutputMetadata.kt
@src/main/kotlin/riven/core/enums/workflow/OutputFieldType.kt
@src/main/kotlin/riven/core/models/entity/query/EntityQuery.kt
@src/main/kotlin/riven/core/models/entity/query/filter/FilterValue.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BulkUpdateErrorHandling enum and BulkUpdateEntityOutput NodeOutput</name>
  <files>
    src/main/kotlin/riven/core/enums/workflow/BulkUpdateErrorHandling.kt
    src/main/kotlin/riven/core/models/workflow/engine/state/NodeOutput.kt
    src/main/kotlin/riven/core/enums/workflow/WorkflowActionType.kt
  </files>
  <action>
**1. Create BulkUpdateErrorHandling enum** at `src/main/kotlin/riven/core/enums/workflow/BulkUpdateErrorHandling.kt`:
```kotlin
package riven.core.enums.workflow

/**
 * Error handling modes for bulk update operations.
 *
 * - FAIL_FAST: Stop on first entity update failure. No rollback -- entities updated before
 *   the failure remain updated. Output includes count of what succeeded before failure.
 * - BEST_EFFORT: Process all entities regardless of individual failures. Output includes
 *   entitiesUpdated count, entitiesFailed count, and details of failed entities.
 */
enum class BulkUpdateErrorHandling {
    FAIL_FAST,
    BEST_EFFORT
}
```

**2. Add BulkUpdateEntityOutput to NodeOutput.kt:**
Add a new section after the QueryEntityOutput section (before HTTP Action Output section). Follow the same pattern as other outputs:
```kotlin
/**
 * Output from BULK_UPDATE_ENTITY action.
 *
 * @property entitiesUpdated Count of entities successfully updated
 * @property entitiesFailed Count of entities that failed to update
 * @property failedEntityDetails List of failed entity IDs with error messages (empty for FAIL_FAST)
 * @property totalProcessed Total entities attempted (entitiesUpdated + entitiesFailed)
 */
data class BulkUpdateEntityOutput(
    val entitiesUpdated: Int,
    val entitiesFailed: Int,
    val failedEntityDetails: List<Map<String, Any?>>,
    val totalProcessed: Int
) : NodeOutput {
    override fun toMap(): Map<String, Any?> = mapOf(
        "entitiesUpdated" to entitiesUpdated,
        "entitiesFailed" to entitiesFailed,
        "failedEntityDetails" to failedEntityDetails,
        "totalProcessed" to totalProcessed
    )
}
```

The `failedEntityDetails` is a List of maps, each containing: `"entityId"` (UUID as String), `"error"` (String error message). This allows BEST_EFFORT mode to report which entities failed and why.

**3. Add BULK_UPDATE_ENTITY to WorkflowActionType enum:**
Add `BULK_UPDATE_ENTITY,` after `QUERY_ENTITY,` in the enum.
  </action>
  <verify>
Run `./gradlew test` -- all tests pass. The new enum and output class compile. The OutputMetadataValidationTest will detect BulkUpdateEntityOutput as a new NodeOutput subclass and log a Phase 3 TODO warning (no outputMetadata yet -- Plan 02 Task 2 adds it).
  </verify>
  <done>
BulkUpdateErrorHandling enum exists with FAIL_FAST and BEST_EFFORT values. BulkUpdateEntityOutput NodeOutput exists with entitiesUpdated, entitiesFailed, failedEntityDetails, totalProcessed fields and toMap(). BULK_UPDATE_ENTITY added to WorkflowActionType. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create WorkflowBulkUpdateEntityActionConfig with validation, metadata, and outputMetadata</name>
  <files>src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowBulkUpdateEntityActionConfig.kt</files>
  <action>
Create the full config class at `src/main/kotlin/riven/core/models/workflow/node/config/actions/WorkflowBulkUpdateEntityActionConfig.kt`. Follow the established patterns from WorkflowQueryEntityActionConfig (for query config) and WorkflowCreateEntityActionConfig (for outputMetadata).

**Class structure:**

```kotlin
@Schema(
    name = "WorkflowBulkUpdateEntityActionConfig",
    description = "Configuration for BULK_UPDATE_ENTITY action nodes that apply identical field updates to all entities matching a query."
)
@JsonTypeName("workflow_bulk_update_entity_action")
@JsonDeserialize(using = JsonDeserializer.None::class)
data class WorkflowBulkUpdateEntityActionConfig(
    override val version: Int = 1,

    // Embedded query config -- self-contained, per locked decision
    val query: EntityQuery,

    // Field updates to apply to each matching entity
    // Keys are attribute UUID strings, values are static or template values
    val payload: Map<String, String> = emptyMap(),

    // Error handling mode -- user-configurable dropdown
    val errorHandling: BulkUpdateErrorHandling = BulkUpdateErrorHandling.FAIL_FAST,

    // Optional pagination for the embedded query
    val pagination: QueryPagination? = null,

    val timeoutSeconds: Long? = null

) : WorkflowActionConfig {
    override val type get() = WorkflowNodeType.ACTION
    override val subType get() = WorkflowActionType.BULK_UPDATE_ENTITY

    override val config: Map<String, Any?>
        get() = mapOf(
            "entityTypeId" to query.entityTypeId.toString(),
            "filter" to query.filter,
            "payload" to payload,
            "errorHandling" to errorHandling.name,
            "pagination" to pagination,
            "timeoutSeconds" to timeoutSeconds
        )

    override val configSchema get() = Companion.configSchema
```

**companion object:**
- `metadata`: WorkflowNodeTypeMetadata with label "Bulk Update Entities", description "Applies identical updates to all entities matching a query", icon IconType.LAYERS (or COPY -- pick a reasonable icon from the existing IconType enum), category ACTION.
- `configSchema`: List of WorkflowNodeConfigField:
  - "query" (ENTITY_QUERY, required) -- "Query to find entities for bulk update"
  - "payload" (KEY_VALUE, required) -- "Map of attribute updates to apply to each entity"
  - "errorHandling" (ENUM, required) -- "How to handle individual entity update failures"
  - "timeoutSeconds" (DURATION, optional) -- "Optional timeout override"
- `outputMetadata`: WorkflowNodeOutputMetadata with fields matching BulkUpdateEntityOutput.toMap() keys:
  - "entitiesUpdated" (NUMBER) -- "Count of entities successfully updated", example 25
  - "entitiesFailed" (NUMBER) -- "Count of entities that failed to update", example 0
  - "failedEntityDetails" (LIST) -- "Details of failed entity updates with entityId and error", example emptyList
  - "totalProcessed" (NUMBER) -- "Total entities attempted", example 25

**validate() method:**
Follow the pattern from WorkflowQueryEntityActionConfig.validate(). Validate:
- query.filter (reuse the same recursive filter validation -- extract the private methods or call the same validation service)
- payload keys (validateTemplateMap)
- pagination if present
- timeoutSeconds (validateOptionalDuration)

Since WorkflowQueryEntityActionConfig has private filter validation methods that cannot be reused directly, duplicate the filter validation logic in this config class. Alternatively, extract the filter validation into the validate method using the same pattern: walk the filter tree validating FilterValue.Template syntax and RelationshipFilter conditions. Follow the exact same approach as WorkflowQueryEntityActionConfig.validateFilter, validateFilterValue, and validateRelationshipCondition.

**execute() method:**
Placeholder -- throw NotImplementedError with descriptive message. This will be implemented in Plan 03.
```kotlin
override fun execute(
    dataStore: WorkflowDataStore,
    inputs: Map<String, Any?>,
    services: NodeServiceProvider
): NodeOutput {
    throw NotImplementedError(
        "BULK_UPDATE_ENTITY execution is implemented in Plan 03. " +
        "Query: ${query.entityTypeId}, ErrorHandling: $errorHandling"
    )
}
```

**Required imports:**
- Same pattern as WorkflowQueryEntityActionConfig imports
- Plus: `import riven.core.enums.workflow.BulkUpdateErrorHandling`
- Plus: `import riven.core.models.workflow.engine.state.BulkUpdateEntityOutput`
- Plus outputMetadata imports from Phase 1

**Add @Schema annotations** to all properties following existing convention with `@param:Schema`.
  </action>
  <verify>
Run `./gradlew test` -- all tests pass. OutputMetadataValidationTest should now validate BulkUpdateEntityActionConfig.outputMetadata keys match BulkUpdateEntityOutput.toMap() keys (if the test discovers the new config via the registry -- it may not yet since the node isn't registered in the registry until Plan 03). Verify the file compiles.
  </verify>
  <done>
WorkflowBulkUpdateEntityActionConfig exists as a separate WorkflowActionConfig with embedded query config, payload map, errorHandling enum field, companion metadata/configSchema/outputMetadata. validate() validates filter tree, payload templates, and timeout. execute() is a placeholder. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew test` passes with zero failures
2. BulkUpdateErrorHandling.kt exists with FAIL_FAST and BEST_EFFORT
3. BulkUpdateEntityOutput exists in NodeOutput.kt with toMap() returning 4 keys
4. BULK_UPDATE_ENTITY exists in WorkflowActionType
5. WorkflowBulkUpdateEntityActionConfig compiles with all companion properties
6. outputMetadata keys match BulkUpdateEntityOutput.toMap() keys
</verification>

<success_criteria>
- BulkUpdateErrorHandling enum defines FAIL_FAST and BEST_EFFORT
- BULK_UPDATE_ENTITY added to WorkflowActionType
- BulkUpdateEntityOutput NodeOutput has entitiesUpdated, entitiesFailed, failedEntityDetails, totalProcessed
- WorkflowBulkUpdateEntityActionConfig implements WorkflowActionConfig with embedded query
- Config has payload field for template-enabled field updates
- Config has errorHandling field with FAIL_FAST default
- Companion declares metadata, configSchema, outputMetadata
- outputMetadata keys match BulkUpdateEntityOutput.toMap() keys exactly
- validate() covers filter tree, payload templates, and timeout
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-query-bulk-update-execution/02-02-SUMMARY.md`
</output>
