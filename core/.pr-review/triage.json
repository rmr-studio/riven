[
  {
    "id": "PRRT_kwDOPrHE-c5vtJZ8",
    "status": "fixed",
    "severity": "moderate",
    "summary": "Add index on relationship_definition_id in SQL schema for definition-based lookups",
    "reviewer": "coderabbitai",
    "file": "core/db/schema/02_indexes/entity_indexes.sql",
    "line_start": null,
    "line_end": 35,
    "original_comment": "New indexes look appropriate; consider adding an index on entity_relationships(relationship_definition_id). The three new indexes are well-targeted. However, entity_relationships now carries relationship_definition_id as a foreign key with no standalone index on that column.",
    "assessment": "Performance optimization for FK lookups and cascade operations. Not a correctness bug but worth adding alongside the JPA-level index suggestion in thread 4.",
    "should_address": true,
    "user_decision": "approved"
  },
  {
    "id": "PRRT_kwDOPrHE-c5vtJZ-",
    "status": "fixed",
    "severity": "critical",
    "summary": "Unique constraint must be partial index to support soft-delete re-creation",
    "reviewer": "coderabbitai",
    "file": "core/db/schema/04_constraints/entity_constraints.sql",
    "line_start": null,
    "line_end": 13,
    "original_comment": "entity_relationships uses soft-delete. A non-partial ADD CONSTRAINT ... UNIQUE will be violated when a soft-deleted relationship is recreated with the same triple -- even though no live relationship exists. Replace with a partial unique index.",
    "assessment": "VERIFIED: Correctness bug. Recreating a soft-deleted relationship will fail with a unique constraint violation. The existing codebase pattern (uq_unique_attribute_per_type on lines 1-4 of same file) uses partial indexes for soft-deletable tables.",
    "should_address": true,
    "user_decision": "approved"
  },
  {
    "id": "PRRT_kwDOPrHE-c5vtJZ_",
    "status": "fixed",
    "severity": "nitpick",
    "summary": "Missing trailing semicolon on final SQL statement",
    "reviewer": "coderabbitai",
    "file": "core/db/schema/04_constraints/entity_constraints.sql",
    "line_start": null,
    "line_end": 13,
    "original_comment": "All other statements in this file end with ;. Add the missing semicolon.",
    "assessment": "Absorbed into thread 2 fix — the entire constraint statement is being replaced with a partial unique index.",
    "should_address": true,
    "user_decision": "approved"
  },
  {
    "id": "PRRT_kwDOPrHE-c5vtJaB",
    "status": "fixed",
    "severity": "moderate",
    "summary": "Add index on relationship_definition_id in JPA entity annotation",
    "reviewer": "coderabbitai",
    "file": "core/src/main/kotlin/riven/core/entity/entity/EntityRelationshipEntity.kt",
    "line_start": null,
    "line_end": 20,
    "original_comment": "countByDefinitionId() and softDeleteByDefinitionId() filter directly on relationship_definition_id without a dedicated index. Add Index annotation on the entity.",
    "assessment": "Companion to thread 1 (SQL schema index). Both should be addressed together for consistency between JPA annotations and actual schema.",
    "should_address": true,
    "user_decision": "approved"
  },
  {
    "id": "PRRT_kwDOPrHE-c5vtJaD",
    "status": "skipped",
    "severity": "nitpick",
    "summary": "icon_value column name is ambiguous -- should be icon_colour",
    "reviewer": "coderabbitai",
    "file": "core/src/main/kotlin/riven/core/entity/entity/RelationshipDefinitionEntity.kt",
    "line_start": null,
    "line_end": 41,
    "original_comment": "icon_type correctly names the type column; the symmetric naming for the colour column would be icon_colour. The current icon_value name is misleading.",
    "assessment": "Naming preference. icon_value is used elsewhere in the codebase for the same pattern. Not worth changing in this PR.",
    "should_address": false,
    "user_decision": "skipped"
  },
  {
    "id": "PRRT_kwDOPrHE-c5vtJaG",
    "status": "fixed",
    "severity": "moderate",
    "summary": "Document why RelationshipTargetRuleEntity uses hard-delete instead of soft-delete",
    "reviewer": "coderabbitai",
    "file": "core/src/main/kotlin/riven/core/entity/entity/RelationshipTargetRuleEntity.kt",
    "line_start": null,
    "line_end": 41,
    "original_comment": "Entity extends AuditableEntity while its sibling extends AuditableSoftDeletableEntity. Per coding guideline: use soft-delete by default. Add a comment explaining why hard-delete is appropriate.",
    "assessment": "Valid point about documenting the deviation from the default pattern. A simple KDoc comment suffices.",
    "should_address": true,
    "user_decision": "approved"
  },
  {
    "id": "PRRT_kwDOPrHE-c5vtJaJ",
    "status": "fixed",
    "severity": "important",
    "summary": "No application-layer enforcement of chk_target_or_semantic DB constraint",
    "reviewer": "coderabbitai",
    "file": "core/src/main/kotlin/riven/core/entity/entity/RelationshipTargetRuleEntity.kt",
    "line_start": null,
    "line_end": 30,
    "original_comment": "Both targetEntityTypeId and semanticTypeConstraint are nullable with no require() guard. An entity with both null will throw unhandled DataIntegrityViolationException at DB commit.",
    "assessment": "VERIFIED: Valid. No require() guard in buildTargetRuleEntities or diffTargetRules. Both fields nullable with no validation. Will cause opaque 500 error instead of clean 400.",
    "should_address": true,
    "user_decision": "approved"
  },
  {
    "id": "PRRT_kwDOPrHE-c5vtJaM",
    "status": "fixed",
    "severity": "moderate",
    "summary": "inverseName missing = null default, inconsistent with sibling nullable fields",
    "reviewer": "coderabbitai",
    "file": "core/src/main/kotlin/riven/core/entity/entity/RelationshipTargetRuleEntity.kt",
    "line_start": null,
    "line_end": 40,
    "original_comment": "semanticTypeConstraint and cardinalityOverride both have explicit = null defaults. inverseName does not, forcing every call-site to name it explicitly.",
    "assessment": "Minor consistency fix. Easy to address.",
    "should_address": true,
    "user_decision": "approved"
  },
  {
    "id": "PRRT_kwDOPrHE-c5vtJaO",
    "status": "skipped",
    "severity": "nitpick",
    "summary": "Add KDoc comment to QueryDirection enum",
    "reviewer": "coderabbitai",
    "file": "core/src/main/kotlin/riven/core/enums/entity/query/QueryDirection.kt",
    "line_start": null,
    "line_end": 6,
    "original_comment": "FORWARD/INVERSE aren't self-explanatory in the context of per-definition relationship traversal. Add KDoc for consistency with peer enum files.",
    "assessment": "Low value. FORWARD and INVERSE are self-explanatory in context.",
    "should_address": false,
    "user_decision": "skipped"
  },
  {
    "id": "PRRT_kwDOPrHE-c5vtJaP",
    "status": "skipped",
    "severity": "nitpick",
    "summary": "RelationshipTargetRule diverges from AuditableModel pattern",
    "reviewer": "coderabbitai",
    "file": "core/src/main/kotlin/riven/core/models/entity/RelationshipTargetRule.kt",
    "line_start": null,
    "line_end": 17,
    "original_comment": "RelationshipTargetRule has raw createdAt/updatedAt without createdBy/updatedBy and doesn't extend AuditableModel. Document the intentional deviation.",
    "assessment": "Target rules are system-managed configuration rows. createdBy/updatedBy adds no value.",
    "should_address": false,
    "user_decision": "skipped"
  },
  {
    "id": "PRRT_kwDOPrHE-c5vtJaQ",
    "status": "skipped",
    "severity": "nitpick",
    "summary": "Premature refactor suggestion for semantic type enum",
    "reviewer": "coderabbitai",
    "file": "core/src/main/kotlin/riven/core/models/entity/RelationshipTargetRule.kt",
    "line_start": null,
    "line_end": 11,
    "original_comment": "CodeRabbit itself acknowledges this is premature given the semantic type domain is not yet specified.",
    "assessment": "Self-acknowledged as premature.",
    "should_address": false,
    "user_decision": "skipped"
  },
  {
    "id": "PRRT_kwDOPrHE-c5vtJaS",
    "status": "fixed",
    "severity": "nitpick",
    "summary": "Missing @Schema annotation on SaveTargetRuleRequest",
    "reviewer": "coderabbitai",
    "file": "core/src/main/kotlin/riven/core/models/request/entity/type/SaveTypeDefinitionRequest.kt",
    "line_start": null,
    "line_end": 54,
    "original_comment": "Other request types in this file have @Schema annotations. SaveTargetRuleRequest is missing one.",
    "assessment": "Consistency fix for OpenAPI docs. Quick to add.",
    "should_address": true,
    "user_decision": "approved"
  },
  {
    "id": "PRRT_kwDOPrHE-c5vtJaW",
    "status": "fixed",
    "severity": "moderate",
    "summary": "Move DeleteDefinitionImpact from service to models package to fix inverted dependency",
    "reviewer": "coderabbitai",
    "file": "core/src/main/kotlin/riven/core/models/response/entity/type/EntityTypeImpactResponse.kt",
    "line_start": null,
    "line_end": 4,
    "original_comment": "DeleteDefinitionImpact is a response DTO used in the two-pass delete pattern. It should be in models package so services import from models, not the other way around.",
    "assessment": "Valid architectural concern about dependency direction. Worth fixing.",
    "should_address": true,
    "user_decision": "approved"
  },
  {
    "id": "PRRT_kwDOPrHE-c5vtJaX",
    "status": "skipped",
    "severity": "nitpick",
    "summary": "Fix naming convention violation: getworkspaceId() should be getWorkspaceId()",
    "reviewer": "coderabbitai",
    "file": "core/src/main/kotlin/riven/core/projection/entity/EntityLinkProjection.kt",
    "line_start": null,
    "line_end": 18,
    "original_comment": "getworkspaceId() violates camelCase convention. Pre-existing but worth correcting.",
    "assessment": "Pre-existing issue not introduced by this PR. Skip to keep scope clean.",
    "should_address": false,
    "user_decision": "skipped"
  },
  {
    "id": "PRRT_kwDOPrHE-c5vtJaZ",
    "status": "fixed",
    "severity": "moderate",
    "summary": "Prefer JPQL over native SQL for softDeleteByDefinitionId",
    "reviewer": "coderabbitai",
    "file": "core/src/main/kotlin/riven/core/repository/entity/EntityRelationshipRepository.kt",
    "line_start": null,
    "line_end": 108,
    "original_comment": "Bulk update doesn't use PostgreSQL-specific features. JPQL is sufficient and preferred per coding guidelines.",
    "assessment": "Valid per coding standards. The query uses no native-SQL-specific features.",
    "should_address": true,
    "user_decision": "approved"
  },
  {
    "id": "PRRT_kwDOPrHE-c5vtJac",
    "status": "fixed",
    "severity": "moderate",
    "summary": "Add DISTINCT to prevent duplicate rows in inverse link queries",
    "reviewer": "coderabbitai",
    "file": "core/src/main/kotlin/riven/core/repository/entity/EntityRelationshipRepository.kt",
    "line_start": null,
    "line_end": 225,
    "original_comment": "JOIN on relationship_target_rules can produce duplicate rows if multiple rules exist with same (relationship_definition_id, target_entity_type_id) pair. Add DISTINCT as defensive safeguard.",
    "assessment": "REVIEWED: Duplicate scenario requires multiple target rules with same (definition_id, target_type_id, inverse_visible=true). Unlikely in practice but no schema constraint prevents it. DISTINCT is cheap insurance. Downgraded from important to moderate.",
    "should_address": true,
    "user_decision": "approved"
  },
  {
    "id": "PRRT_kwDOPrHE-c5vtJag",
    "status": "fixed",
    "severity": "moderate",
    "summary": "Same DISTINCT issue for batch inverse query",
    "reviewer": "coderabbitai",
    "file": "core/src/main/kotlin/riven/core/repository/entity/EntityRelationshipRepository.kt",
    "line_start": null,
    "line_end": 258,
    "original_comment": "Same duplication concern as findInverseEntityLinksByTargetId. Apply DISTINCT here as well.",
    "assessment": "Same as thread 16. Cheap defensive fix.",
    "should_address": true,
    "user_decision": "approved"
  },
  {
    "id": "PRRT_kwDOPrHE-c5vtJak",
    "status": "skipped",
    "severity": "nitpick",
    "summary": "Add explicit soft-delete filter and empty collection guard to findByWorkspaceIdAndSourceEntityTypeIdIn",
    "reviewer": "coderabbitai",
    "file": "core/src/main/kotlin/riven/core/repository/entity/RelationshipDefinitionRepository.kt",
    "line_start": null,
    "line_end": 21,
    "original_comment": "Add AND rd.deleted = false for consistency with codebase pattern. Also guard against empty entityTypeIds list.",
    "assessment": "INVALID: @SQLRestriction('deleted = false') on AuditableSoftDeletableEntity already handles soft-delete filtering automatically for all JPQL queries. Adding explicit filter is redundant. Hibernate 6.x handles empty IN collections safely. Not a bug.",
    "should_address": false,
    "user_decision": "skipped"
  },
  {
    "id": "PRRT_kwDOPrHE-c5vtJal",
    "status": "fixed",
    "severity": "moderate",
    "summary": "Add @Transactional to deleteByRelationshipDefinitionId repository method",
    "reviewer": "coderabbitai",
    "file": "core/src/main/kotlin/riven/core/repository/entity/RelationshipTargetRuleRepository.kt",
    "line_start": null,
    "line_end": 16,
    "original_comment": "Derived deleteBy* methods are not automatically transactional. Add @Transactional for defensive annotation.",
    "assessment": "Defensive but valid. Currently called from transactional context but protects against future refactoring.",
    "should_address": true,
    "user_decision": "approved"
  },
  {
    "id": "PRRT_kwDOPrHE-c5vtJaq",
    "status": "skipped",
    "severity": "nitpick",
    "summary": "saveRelationships missing activity logging for relationship mutations",
    "reviewer": "coderabbitai",
    "file": "core/src/main/kotlin/riven/core/service/entity/EntityRelationshipService.kt",
    "line_start": null,
    "line_end": 93,
    "original_comment": "Per coding guidelines, all create/update/delete mutations must log activity. This method creates and deletes relationship links but does not log. Also: variable name fieldProjections is misleading.",
    "assessment": "REVIEWED: The parent EntityService.saveEntity already logs the entity save activity (lines 214-223). Relationship link mutations are sub-operations of the entity save, not standalone mutations. Per-link activity logging would be excessively noisy. Downgraded from important to skip.",
    "should_address": false,
    "user_decision": "skipped"
  },
  {
    "id": "PRRT_kwDOPrHE-c5vtJav",
    "status": "fixed",
    "severity": "nitpick",
    "summary": "Stale variable name fieldProjections should be renamed",
    "reviewer": "coderabbitai",
    "file": "core/src/main/kotlin/riven/core/service/entity/EntityRelationshipService.kt",
    "line_start": null,
    "line_end": 130,
    "original_comment": "fieldProjections is a remnant of old field-based naming. Rename to defProjections.",
    "assessment": "Simple rename for clarity. Quick fix.",
    "should_address": true,
    "user_decision": "approved"
  },
  {
    "id": "PRRT_kwDOPrHE-c5vtJax",
    "status": "skipped",
    "severity": "nitpick",
    "summary": "Frontend caches will become stale: impactedEntities hardcoded to null",
    "reviewer": "coderabbitai",
    "file": "core/src/main/kotlin/riven/core/service/entity/EntityService.kt",
    "line_start": null,
    "line_end": 231,
    "original_comment": "Client-side mutation hook checks if (response.impactedEntities) and updates entity caches. With removal of inverse rows, returning null breaks this contract -- related entities won't sync to client cache, causing stale UI data.",
    "assessment": "INVALID: In the new architecture, saving entity A with a relationship to entity B does NOT change entity B's stored data. Inverse visibility is resolved at query time. There is nothing to 'impact' — B's record is identical before and after. Frontend cache invalidation for computed relationships is a frontend concern, not a backend data issue. Downgraded from critical to skip.",
    "should_address": false,
    "user_decision": "skipped"
  },
  {
    "id": "PRRT_kwDOPrHE-c5vtJa0",
    "status": "fixed",
    "severity": "important",
    "summary": "Inverse definitions allow semantically inverted relationship writes (polymorphic case)",
    "reviewer": "coderabbitai",
    "file": "core/src/main/kotlin/riven/core/service/entity/EntityService.kt",
    "line_start": null,
    "line_end": 270,
    "original_comment": "getDefinitionsForEntityType returns inverse-visible definitions. If a client submits a relationship keyed by an inverse definition ID, the entity gets stored as source despite definition's sourceEntityTypeId pointing elsewhere. Silently creates flipped relationships.",
    "assessment": "PARTIALLY VALID: For non-polymorphic definitions, validateTargets catches this (targets won't match rules). But for polymorphic definitions (allowPolymorphic=true), validation is skipped entirely and inverted rows would be created. Fix: add require(definition.sourceEntityTypeId == entityTypeId) in saveRelationshipsPerDefinition, or filter to forward-only definitions. Downgraded from critical to important.",
    "should_address": true,
    "user_decision": "approved"
  },
  {
    "id": "PRRT_kwDOPrHE-c5vtJa1",
    "status": "skipped",
    "severity": "nitpick",
    "summary": "Definition loading runs unconditionally even for attribute-only filters",
    "reviewer": "coderabbitai",
    "file": "core/src/main/kotlin/riven/core/service/entity/query/EntityQueryService.kt",
    "line_start": null,
    "line_end": 106,
    "original_comment": "loadRelationshipDefinitions hits two repositories even when the filter tree contains no Relationship nodes. Consider deferring.",
    "assessment": "Premature optimization. The cost of loading definitions is negligible compared to the query itself.",
    "should_address": false,
    "user_decision": "skipped"
  },
  {
    "id": "PRRT_kwDOPrHE-c5vtJa4",
    "status": "fixed",
    "severity": "moderate",
    "summary": "Duplicate loadRelationshipDefinitions pattern -- consolidate to shared service",
    "reviewer": "coderabbitai",
    "file": "core/src/main/kotlin/riven/core/service/entity/query/EntityQueryService.kt",
    "line_start": null,
    "line_end": 211,
    "original_comment": "Third copy of forward + inverse definition loading pattern. Extract to EntityTypeRelationshipService.",
    "assessment": "Valid DRY concern. Three copies of the same pattern is a maintenance burden. Related to thread 27.",
    "should_address": true,
    "user_decision": "approved"
  },
  {
    "id": "PRRT_kwDOPrHE-c5vtJa7",
    "status": "fixed",
    "severity": "important",
    "summary": "DeleteDefinitionImpact.definitionId receives entity type ID (wrong ID type) + missing target rule cleanup for deleted entity types",
    "reviewer": "coderabbitai",
    "file": "core/src/main/kotlin/riven/core/service/entity/type/EntityTypeService.kt",
    "line_start": null,
    "line_end": 286,
    "original_comment": "Two issues: (1) DeleteDefinitionImpact.definitionId is passed entityTypeId which is semantically wrong. (2) Deleting an entity type doesn't clean up target rules from OTHER definitions that point TO the deleted type.",
    "assessment": "VERIFIED: Sub-issue 1 (moderate): entityTypeId passed as definitionId — semantically wrong but not data-corrupting. Sub-issue 2 (important): target rules from other definitions that point TO the deleted entity type become orphaned. Code at lines 272-295 only deletes definitions WHERE sourceEntityTypeId = entityTypeId, missing cleanup of target rules from other types. Downgraded from critical to important.",
    "should_address": true,
    "user_decision": "approved"
  },
  {
    "id": "PRRT_kwDOPrHE-c5vtJa9",
    "status": "fixed",
    "severity": "moderate",
    "summary": "Duplicate loadDefinitions logic in EntityContextService -- consolidate",
    "reviewer": "coderabbitai",
    "file": "core/src/main/kotlin/riven/core/service/workflow/state/EntityContextService.kt",
    "line_start": null,
    "line_end": 276,
    "original_comment": "Nearly identical to loadRelationshipDefinitions in EntityQueryService. Extract to EntityTypeRelationshipService. This also removes two repository constructor parameters from EntityContextService.",
    "assessment": "Same as thread 25. Both should be addressed together as a single consolidation effort.",
    "should_address": true,
    "user_decision": "approved"
  },
  {
    "id": "PRRT_kwDOPrHE-c5vtJa_",
    "status": "fixed",
    "severity": "moderate",
    "summary": "Test comment says 'polymorphic' but allowPolymorphic = false",
    "reviewer": "coderabbitai",
    "file": "core/src/test/kotlin/riven/core/service/entity/query/EntityQueryIntegrationTestBase.kt",
    "line_start": null,
    "line_end": 450,
    "original_comment": "Line 431 says 'polymorphic: Employee or Project' but definition has allowPolymorphic = false. Comment is misleading.",
    "assessment": "Misleading test comment. Quick fix to correct the wording.",
    "should_address": true,
    "user_decision": "approved"
  },
  {
    "id": "PRRT_kwDOPrHE-c5vtJbB",
    "status": "fixed",
    "severity": "moderate",
    "summary": "Extend EntityFactory for EntityEntity creation + fix FQN import",
    "reviewer": "coderabbitai",
    "file": "core/src/test/kotlin/riven/core/service/entity/query/EntityQueryRelationshipIntegrationTest.kt",
    "line_start": null,
    "line_end": 439,
    "original_comment": "EntityEntity constructed inline instead of using factory. Also uses fully qualified class name instead of import.",
    "assessment": "Valid per test conventions. Factory should be extended and FQN replaced with import.",
    "should_address": true,
    "user_decision": "approved"
  },
  {
    "id": "PRRT_kwDOPrHE-c5vtJbC",
    "status": "fixed",
    "severity": "moderate",
    "summary": "Lambda parameter 'key' shadows outer function parameter",
    "reviewer": "coderabbitai",
    "file": "core/src/test/kotlin/riven/core/service/util/factory/entity/EntityFactory.kt",
    "line_start": null,
    "line_end": 35,
    "original_comment": "Function-level key: String and schema-property-key lambda both use 'key'. Lambda's key is UUID, outer is String. Rename lambda parameter.",
    "assessment": "Confusing variable shadowing. Simple rename fix.",
    "should_address": true,
    "user_decision": "approved"
  }
]
